<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§çŒ«çŒ«æ–—æ¶é¾™ Ver2.01.12102501beta</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px;
            max-height: 850px;
            background: #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- ç•Œé¢å±‚çº§ --- */
        .layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.98);
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
        }
        .active { display: flex; }

        /* --- åŸºç¡€ç»„ä»¶ --- */
        h1 { color: #e67e22; text-shadow: 2px 2px #f1c40f; margin-bottom: 5px; text-align: center;}
        .version { color: #7f8c8d; font-size: 12px; margin-bottom: 30px; }
        input { padding: 12px; border: 2px solid #3498db; border-radius: 8px; width: 70%; text-align: center; font-size: 16px; margin-bottom: 20px; }
        
        button { padding: 10px 25px; background: #e67e22; color: white; border: none; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #d35400; transition: all 0.1s; margin: 5px; }
        button:active { transform: translateY(4px); box-shadow: 0 0 0 #d35400; }
        button:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; transform: none; color: #fff; }
        
        .btn-blue { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-blue:active { transform: translateY(4px); box-shadow: 0 0 0 #2980b9; }
        .btn-green { 
            background: #2ecc71; 
            box-shadow: 0 4px 0 #27ae60; 
            width: 80%; 
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        .btn-green:active { transform: translateY(4px); box-shadow: 0 0 0 #27ae60; }

        /* --- æ—¥å¿— & å±æ€§ --- */
        .scroll-box {
            width: 100%;
            flex-grow: 1;
            background: #f9f9f9;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            margin-bottom: 20px;
            text-align: left;
            cursor: grab;
        }
        .scroll-box:active { cursor: grabbing; }
        .log-block { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .log-ver { color: #e67e22; font-weight: 900; font-size: 16px; margin-bottom: 5px; }
        .log-date { color: #95a5a6; font-size: 12px; margin-bottom: 8px; }
        .log-list { padding-left: 20px; margin: 0; }
        .log-list li { font-size: 13px; color: #34495e; margin-bottom: 4px; line-height: 1.5; }
        .highlight { color: #c0392b; font-weight: bold; }
        .attr-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px; color: #34495e; }
        .attr-val { color: #2980b9; font-family: monospace; font-size: 16px; }

        /* --- èŒä¸šé€‰æ‹© --- */
        .card-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; overflow-y: auto; padding-bottom: 20px; }
        .class-card { background: white; border: 2px solid #bdc3c7; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
        .class-card:hover { border-color: #3498db; transform: scale(1.02); }
        .class-card h3 { margin: 5px 0; color: #2c3e50; font-size: 16px; }
        .svg-icon { width: 70px; height: 70px; margin: 5px auto; }
        .stats-text { font-size: 10px; color: #7f8c8d; text-align: left; line-height: 1.4; width: 100%; }
        .talent-text { font-size: 10px; color: #c0392b; margin-top: 8px; font-weight: bold; text-align: left; border-top: 1px dashed #eee; padding-top:5px; width: 100%; }

        /* --- æˆ˜æ–—ç•Œé¢ --- */
        #battleLayer { background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #90EE90 70%, #90EE90 100%); justify-content: space-between; padding: 0; }
        .cloud { position: absolute; background: white; border-radius: 50px; opacity: 0.8; animation: floatCloud 20s linear infinite; }
        @keyframes floatCloud { from { left: -100px; } to { left: 100%; } }
        .battle-hud { width: 100%; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; box-sizing: border-box; display: flex; justify-content: space-between; font-size: 14px; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .battle-scene { flex-grow: 1; width: 100%; position: relative; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 25%; z-index: 2; }
        .fighter { width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; transition: transform 0.2s; }
        .fighter-svg { width: 100%; height: 100%; filter: drop-shadow(0 5px 2px rgba(0,0,0,0.2)); }
        .status-box { position: absolute; top: -40px; width: 100%; text-align: center; }
        .fighter-name { background: rgba(0,0,0,0.5); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 12px; display: inline-block; margin-bottom: 2px; }
        .bar-bg { width: 80px; height: 8px; background: #333; border-radius: 4px; margin: 1px auto; overflow: hidden; border:1px solid #fff;}
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.3s; }
        .mp-fill { height: 100%; background: #3498db; width: 100%; transition: width 0.3s; }

        .toolbar { position: absolute; bottom: 140px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 6; padding: 0 5px; }
        .tool-btn { width: 40px; height: 40px; background: #fff; border: 2px solid #bdc3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.1s; }
        .tool-btn:active { transform: scale(0.9); }
        .tool-btn svg { width: 22px; height: 22px; }

        .bottom-panel { width: 100%; background: #fff; padding: 10px; box-sizing: border-box; border-top: 4px solid #f1c40f; z-index: 5; }
        .exp-container { width: 100%; height: 15px; background: #bdc3c7; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .exp-fill { height: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); width: 0%; transition: width 0.5s; }
        .exp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; font-size: 10px; line-height: 15px; color: #333; font-weight: bold; }

        .floating-text { position: absolute; font-weight: 900; font-size: 28px; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0 #fff; z-index: 20; white-space: nowrap; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.2); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }

        .slash-effect { position: absolute; width: 150px; height: 150px; background: transparent; border: 2px solid transparent; z-index: 15; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .slash-effect::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 4px; background: #e74c3c; transform: rotate(-45deg); box-shadow: 0 0 10px #c0392b; animation: slashAnim 0.3s forwards; }
        @keyframes slashAnim { 0% { width: 0; opacity: 0; } 50% { width: 100%; opacity: 1; } 100% { width: 100%; opacity: 0; } }

        .log-box { width: 100%; height: 120px; background: #f8f9fa; overflow-y: auto; padding: 10px; box-sizing: border-box; font-size: 12px; border-top: 1px solid #ccc; }
        .log-entry { margin-bottom: 3px; border-bottom: 1px dashed #eee; padding-bottom: 2px; line-height: 1.4;}
        
        #rogueContainer { display: flex; flex-direction: row; justify-content: space-between; align-items: stretch; width: 100%; gap: 10px; margin-bottom: 20px;}
        .rogue-card { flex: 1; border: 2px solid #ccc; border-radius: 8px; padding: 10px 5px; background: #fff; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .rogue-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        .rogue-card.selected { border: 3px solid #f1c40f; background: #fcf8e3; transform: scale(1.05); box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); }
        .card-icon { font-size: 32px; margin-bottom: 5px; }
        .card-white { border-top: 5px solid #bdc3c7; }
        .card-green { border-top: 5px solid #2ecc71; }
        .card-blue { border-top: 5px solid #3498db; }
        .card-purple { border-top: 5px solid #9b59b6; }
        .card-orange { border-top: 5px solid #e67e22; }

    </style>
</head>
<body>

<div id="gameContainer">
    
    <div id="startLayer" class="layer active">
        <h1>å¤§çŒ«çŒ«æ–—æ¶é¾™</h1>
        <div class="version">Ver2.01.12102501beta</div>
        <svg width="150" height="150" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="#f1c40f" stroke="#e67e22" stroke-width="3"/>
            <path d="M30 30 L40 10 L55 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <path d="M70 30 L60 10 L45 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <circle cx="35" cy="45" r="5" fill="#2c3e50"/>
            <circle cx="65" cy="45" r="5" fill="#2c3e50"/>
            <path d="M45 60 Q50 70 55 60" stroke="#c0392b" stroke-width="3" fill="none"/>
            <path d="M10 50 L90 50" stroke="#bdc3c7" stroke-width="5" opacity="0.5"/>
        </svg>
        <br>
        <button class="btn-green" id="continueBtn" onclick="loadGame()" disabled>æš‚æ— å­˜æ¡£</button>
        <br>
        <input type="text" id="playerNameInput" placeholder="è¯·è¾“å…¥ä½ çš„å‹‡è€…å" maxlength="8">
        <button onclick="goToClassSelection()">æ–°æ¸¸æˆ</button>
        <button class="btn-blue" onclick="showLayer('changelog')">æ›´æ–°æ—¥å¿—</button>
    </div>

    <div id="changelogLayer" class="layer">
        <h2>æ›´æ–°æ—¥å¿—</h2>
        <div class="scroll-box" id="changelogBox">
            <div class="log-block">
                <div class="log-ver">Ver 2.01.12102501beta</div>
                <div class="log-date">ç´§æ€¥Bugä¿®å¤</div>
                <ul class="log-list">
                    <li><span class="highlight">ä¿®å¤å¡æ­»</span>ï¼šä¿®å¤äº†â€œä¼¤å®³æµ‹è¯•â€åè¡€æ¡æ¸…ç©ºä¸”æ— æ³•åˆ·å‡ºä¸‹ä¸€åªæ€ªç‰©çš„ä¸¥é‡Bugã€‚</li>
                    <li><span class="highlight">å®Œæ•´æ—¥å¿—</span>ï¼šè¡¥å…¨äº†å†ä»£ç‰ˆæœ¬çš„æ›´æ–°è®°å½•ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 2.0</div>
                <div class="log-date">å­˜æ¡£ç³»ç»Ÿ</div>
                <ul class="log-list">
                    <li>æ–°å¢è‡ªåŠ¨/æ‰‹åŠ¨å­˜æ¡£åŠŸèƒ½ã€‚</li>
                    <li>ä¸»ç•Œé¢æ–°å¢ç»§ç»­æ¸¸æˆæŒ‰é’®ï¼Œæ˜¾ç¤ºè¿›åº¦ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.95</div>
                <div class="log-date">ä½“éªŒä¼˜åŒ–</div>
                <ul class="log-list">
                    <li>ä¼˜åŒ–å­˜æ¡£æŒ‰é’®æ˜¾ç¤ºä¿¡æ¯ã€‚</li>
                    <li>ç•Œé¢ç²¾ç®€ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.8</div>
                <div class="log-date">åŠŸèƒ½æ‰©å±•</div>
                <ul class="log-list">
                    <li>åšæ¯…çŒ«åŠ å¼ºï¼šåä¼¤é˜ˆå€¼é™ä½(2å€/5å€)ã€‚</li>
                    <li>æ–°å¢ä¼¤å®³æµ‹è¯•(æ‰“æ¡©)åŠŸèƒ½ã€‚</li>
                    <li>é­”ç‹å½¢è±¡é‡ç»˜ï¼Œæ›´å…·å‹è¿«æ„Ÿã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.7</div>
                <div class="log-date">æ•°å€¼ä¸å¡ç‰Œ</div>
                <ul class="log-list">
                    <li>æ€ªç‰©é€Ÿåº¦æˆé•¿æå‡ã€‚</li>
                    <li>æ–°å¢æš´å‡»ç³»ç»Ÿ(ç»¿å¡)ã€‚</li>
                    <li>æ™ºæ…§çŒ«åŠ å¼ºï¼šçŒ«èƒ½æˆé•¿æå‡ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.6</div>
                <div class="log-date">æˆ˜æ–—ä¿®æ­£</div>
                <ul class="log-list">
                    <li>ä¿®å¤çµæ´»çŒ«è¿½åŠ ä¼¤å®³ä¸¢å¤±çš„é—®é¢˜ã€‚</li>
                    <li>ä¿®å¤æ™ºæ…§çŒ«å¢ä¼¤æœªç”Ÿæ•ˆçš„é—®é¢˜ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.5</div>
                <div class="log-date">æµç¨‹ä¼˜åŒ–</div>
                <ul class="log-list">
                    <li>æŠ½å¡ç•Œé¢å¢åŠ ç¡®è®¤æŒ‰é’®ã€‚</li>
                    <li>æ€ªç‰©å±æ€§æ”¹ä¸ºåŸºäºå±‚æ•°ç‹¬ç«‹æˆé•¿ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.3</div>
                <div class="log-date">å¤šæ®µä¼¤å®³</div>
                <ul class="log-list">
                    <li>å®è£…å¤šæ®µä¼¤å®³åˆ¤å®šï¼ˆåä¼¤/è¿½åŠ ä¼¤å®³ï¼‰ã€‚</li>
                    <li>æˆ˜æ–—æ—¥å¿—ä¼˜åŒ–ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.2</div>
                <div class="log-date">æœ¯è¯­ç»Ÿä¸€</div>
                <ul class="log-list">
                    <li>ç»Ÿä¸€æ¸¸æˆæœ¯è¯­(çŒ«å¨/çŒ«å¾¡ç­‰)ã€‚</li>
                    <li>å¡ç‰Œé€‰æ‹©ç•Œé¢UIé‡æ„ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.1</div>
                <div class="log-date">ç”»é¢å‡çº§</div>
                <ul class="log-list">
                    <li>å…¨æ–°SVGå¡é€šç”»é£ã€‚</li>
                    <li>æ–°å¢æ­»äº¡å›é€€æœºåˆ¶ã€‚</li>
                    <li>æ–°å¢ç»éªŒæ¡ç³»ç»Ÿã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 1.0</div>
                <div class="log-date">å…¬æµ‹ç‰ˆ</div>
                <ul class="log-list">
                    <li>åŸºç¡€æˆ˜æ–—å¾ªç¯ä¸èŒä¸šå¤©èµ‹å®è£…ã€‚</li>
                </ul>
            </div>
        </div>
        <button onclick="showLayer('start')">è¿”å›ä¸»ç•Œé¢</button>
    </div>

    <div id="classLayer" class="layer">
        <h2 style="color:#2c3e50; font-size: 20px;">è¯·é€‰æ‹©ä½ çš„èŒä¸š</h2>
        <div class="card-container" id="classContainer"></div>
    </div>

    <div id="battleLayer" class="layer">
        <div class="cloud" style="top:20px; width:80px; height:30px; animation-duration:25s;"></div>
        <div class="cloud" style="top:60px; width:120px; height:40px; animation-duration:35s; animation-delay:-10s"></div>

        <div class="battle-hud">
            <div>ğŸ“ ç¬¬ <span id="levelText" style="color:#f1c40f; font-weight:bold">1</span> å±‚</div>
            <div>ğŸ’€ å‡»æ€: <span id="killText">0</span></div>
        </div>

        <div class="battle-scene">
            <div id="playerEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="pName">å‹‡è€…</div>
                    <div class="bar-bg"><div class="hp-fill" id="pHpBar"></div></div>
                    <div class="bar-bg" style="margin-top:1px; height:4px; border:none;"><div class="mp-fill" id="pMpBar"></div></div>
                </div>
                <div id="pVisual" class="fighter-svg"></div>
            </div>
            <div id="enemyEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="eName">æ€ªç‰©</div>
                    <div class="bar-bg"><div class="hp-fill" id="eHpBar"></div></div>
                </div>
                <div id="eVisual" class="fighter-svg"></div>
            </div>
        </div>

        <div class="toolbar">
            <div class="tool-btn" onclick="showAttrPanel()" title="è§’è‰²å±æ€§">
                <svg viewBox="0 0 24 24" fill="#34495e"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            </div>
            <div class="tool-btn" onclick="alert('èƒŒåŒ…ç³»ç»Ÿæš‚æœªå®è£…ï¼Œæ•¬è¯·æœŸå¾…ï¼')" title="èƒŒåŒ…">
                <svg viewBox="0 0 24 24" fill="#e67e22"><path d="M12 2l-5.5 9h11z"/><path d="M10 12h4v4h-4z"/><path d="M4 14v8h16v-8l-2-3H6z"/></svg>
            </div>
            <div class="tool-btn" onclick="alert('è£…å¤‡ç³»ç»Ÿæš‚æœªå®è£…ï¼Œæ•¬è¯·æœŸå¾…ï¼')" title="è£…å¤‡">
                <svg viewBox="0 0 24 24" fill="#95a5a6"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
            </div>
            <div class="tool-btn" onclick="startDamageTest()" title="ä¼¤å®³æµ‹è¯•">
                <svg viewBox="0 0 24 24" fill="#c0392b"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4h2v4zm2-6H8V9h6v2z"/></svg>
            </div>
            <div class="tool-btn" onclick="saveGame(true)" title="ä¿å­˜è¿›åº¦">
                <svg viewBox="0 0 24 24" fill="#2980b9"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
            </div>
        </div>

        <div class="bottom-panel">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                <span>EXP</span>
                <span>LV.<span id="pLvVal">1</span></span>
            </div>
            <div class="exp-container">
                <div class="exp-fill" id="expFill"></div>
                <div class="exp-text" id="expText">0/2</div>
            </div>
        </div>
        <div class="log-box" id="battleLog">
            <div class="log-entry">æ¬¢è¿æ¥åˆ°å¤§çŒ«çŒ«çš„ä¸–ç•Œ...</div>
        </div>
    </div>

    <div id="cardLayer" class="layer">
        <h2 style="color:#8e44ad; font-size:22px;">ğŸ å‘½è¿çš„é¦ˆèµ </h2>
        <p style="color:#7f8c8d; font-size:12px; margin-bottom:15px;">è¯·ç‚¹å‡»å¡ç‰Œé€‰ä¸­ï¼Œç„¶åç¡®è®¤</p>
        <div id="rogueContainer"></div>
        <button id="confirmCardBtn" onclick="confirmRogueSelection()" disabled style="width:80%; margin-top:20px;">ç¡®è®¤é€‰æ‹©</button>
    </div>

    <div id="gameOverLayer" class="layer">
        <h1 style="color: #c0392b;">ğŸ’” èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹</h1>
        <p id="goReason" style="font-size:18px; color:#34495e;">åœ¨ç¬¬ X å±‚åŠ›ç«­å€’ä¸‹...</p>
        <div style="font-size: 60px; margin: 30px;">ğŸš‘</div>
        <p style="color:#7f8c8d; font-size:14px;">å¤§çŒ«çŒ«æ–½å±•äº†æ—¶é—´å›æº¯é­”æ³•ï¼<br>å±‚æ•°å›é€€5å±‚ï¼ŒçŠ¶æ€å›æ»¡ã€‚</p>
        <button onclick="revivePlayer()" style="background:#2ecc71; box-shadow:0 4px 0 #27ae60">å¤æ´»å†æˆ˜</button>
    </div>

    <div id="attrLayer" class="layer">
        <h2>è§’è‰²å±æ€§</h2>
        <div class="scroll-box" style="margin-bottom:20px;">
            <div class="attr-row"><span class="attr-label">åç§°</span><span class="attr-val" id="attrName">---</span></div>
            <div class="attr-row"><span class="attr-label">èŒä¸š</span><span class="attr-val" id="attrClass">---</span></div>
            <div class="attr-row"><span class="attr-label">ç­‰çº§</span><span class="attr-val" id="attrLvl">1</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«è¡€ (HP)</span><span class="attr-val" id="attrHp">---</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«èƒ½ (MP)</span><span class="attr-val" id="attrMp">---</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«å¨ (Atk)</span><span class="attr-val" id="attrAtk">0</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«å¾¡ (Def)</span><span class="attr-val" id="attrDef">0</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«é€Ÿ (Spd)</span><span class="attr-val" id="attrSpd">0</span></div>
            <div class="attr-row"><span class="attr-label">æš´å‡»ç‡</span><span class="attr-val" id="attrCrit">0%</span></div>
            <div class="attr-row"><span class="attr-label">æš´å‡»ä¼¤å®³</span><span class="attr-val" id="attrCritDmg">150%</span></div>
        </div>
        <button onclick="closeAttrPanel()">è¿”å›æˆ˜æ–—</button>
    </div>

</div>

<script>
    const SVGS = {
        cat_resolute: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#95a5a6" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#95a5a6" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#95a5a6" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M65 40 L90 10" stroke="#bdc3c7" stroke-width="6"/><path d="M65 40 L90 10" stroke="#7f8c8d" stroke-width="2"/><line x1="60" y1="45" x2="70" y2="35" stroke="#e67e22" stroke-width="4"/></g></svg>`,
        cat_agile: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M70 40 L85 25" stroke="#3498db" stroke-width="4"/><path d="M10 40 L-5 25" stroke="#3498db" stroke-width="4"/></g></svg>`,
        cat_wise: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><line x1="75" y1="20" x2="75" y2="80" stroke="#8e44ad" stroke-width="4"/><circle cx="75" cy="20" r="8" fill="#e74c3c"/></g></svg>`,
        cat_berserk: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="30" x2="35" y2="38" stroke="#000" stroke-width="2"/><line x1="55" y1="30" x2="45" y2="38" stroke="#000" stroke-width="2"/><path d="M35 50 Q40 45 45 50" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M80 40 L80 70 M70 40 L90 40 L80 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/><path d="M0 40 L0 70 M-10 40 L10 40 L0 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/></g></svg>`,
        monster_slime: `<svg viewBox="0 0 100 100"><path d="M20 80 Q20 20 50 20 Q80 20 80 80 Z" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/><circle cx="40" cy="50" r="5" fill="#000"/><circle cx="60" cy="50" r="5" fill="#000"/></svg>`,
        monster_bat: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="15" fill="#34495e"/><path d="M35 50 Q10 20 10 50 Q20 70 35 55" fill="#34495e"/><path d="M65 50 Q90 20 90 50 Q80 70 65 55" fill="#34495e"/><circle cx="45" cy="50" r="2" fill="#e74c3c"/><circle cx="55" cy="50" r="2" fill="#e74c3c"/></svg>`,
        monster_dragon: `<svg viewBox="0 0 100 100"><path d="M30 60 Q30 30 50 20 Q70 30 70 60" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/><path d="M50 20 L50 5" stroke="#e74c3c" stroke-width="4"/><circle cx="40" cy="45" r="4" fill="#f1c40f"/><circle cx="60" cy="45" r="4" fill="#f1c40f"/><path d="M40 70 Q50 80 60 70" stroke="#000" stroke-width="2" fill="none"/></svg>`,
        stake: `<svg viewBox="0 0 100 100"><rect x="35" y="20" width="30" height="70" fill="#d35400" stroke="#5d4037" stroke-width="2"/><circle cx="50" cy="40" r="8" fill="#fff" opacity="0.8"/><circle cx="50" cy="40" r="3" fill="#000"/><path d="M35 20 L50 5 L65 20 Z" fill="#d35400" stroke="#5d4037" stroke-width="2"/></svg>`
    };

    const CLASSES = [
        {
            id: 'resolute', name: 'åšæ¯…çŒ«', svg: SVGS.cat_resolute, color: '#95a5a6',
            base: { atk: 32, mp: 5, def: 25, hp: 200, spd: 10 },
            growth: { atk: 3, mp: 1, def: 15, hp: 50, spd: 1 },
            talent: 'ã€è†æ£˜ç”²å£³ã€‘è‹¥è‡ªèº«[çŒ«å¾¡]â‰¥[çŒ«å¨]x2ï¼Œæ•Œäººæ”»å‡»ååå¼¹[çŒ«å¾¡]x1ä¼¤å®³ï¼›è‹¥[çŒ«å¾¡]â‰¥[çŒ«å¨]x5ï¼Œåå¼¹[çŒ«å¾¡]x2+[çŒ«è¡€]x0.2ä¼¤å®³ã€‚'
        },
        {
            id: 'agile', name: 'çµæ´»çŒ«', svg: SVGS.cat_agile, color: '#f1c40f',
            base: { atk: 40, mp: 8, def: 10, hp: 80, spd: 20 },
            growth: { atk: 10, mp: 2, def: 3, hp: 20, spd: 4 },
            talent: 'ã€è¿…æ·è¿å‡»ã€‘æ”»å‡»åè¿½åŠ ä¸€æ®µ[çŒ«é€Ÿ]x1çš„çœŸå®ä¼¤å®³ã€‚æ¯å‡10çº§ç³»æ•°+0.2ã€‚'
        },
        {
            id: 'wise', name: 'æ™ºæ…§çŒ«', svg: SVGS.cat_wise, color: '#9b59b6',
            base: { atk: 45, mp: 20, def: 10, hp: 70, spd: 10 },
            growth: { atk: 15, mp: 10, def: 3, hp: 18, spd: 2 },
            talent: 'ã€å¥¥æœ¯è¶…è½½ã€‘æ¶ˆè€—10%[çŒ«èƒ½]å¢ä¼¤ï¼Œ1ç‚¹[çŒ«èƒ½]å¢åŠ 1%ä¼¤å®³ã€‚è‡´æ­»æ—¶æ¶ˆè€—[çŒ«èƒ½]æŠµæŒ¡ä¼¤å®³(1çŒ«èƒ½æŠµ2ä¼¤å®³ï¼Œå•åœºæˆ˜æ–—é™1æ¬¡)ã€‚'
        },
        {
            id: 'berserk', name: 'ç‹‚æš´çŒ«', svg: SVGS.cat_berserk, color: '#c0392b',
            base: { atk: 50, mp: 6, def: 8, hp: 100, spd: 15 },
            growth: { atk: 20, mp: 1, def: 3, hp: 25, spd: 2 },
            talent: 'ã€é²œè¡€æ¸´æœ›ã€‘æ¶ˆè€—20%[çŒ«è¡€]æ”»å‡»ã€‚è¡€é‡è¶Šä½ä¼¤å®³è¶Šé«˜ã€‚æ”»å‡»é™„å¸¦10%å¸è¡€ã€‚'
        }
    ];

    const CARDS = [
        { type: 'white', icon: 'âš”ï¸', title: 'åŠ›é‡è®­ç»ƒ', desc: 'çŒ«å¨ +10', effect: (p) => { p.atk += 10; } },
        { type: 'white', icon: 'â¤ï¸', title: 'ä½“èƒ½å¼ºåŒ–', desc: 'çŒ«è¡€ +30', effect: (p) => { p.maxHp += 30; p.hp += 30; } },
        { type: 'white', icon: 'ğŸ›¡ï¸', title: 'ç¡¬åŒ–çš®æ¯›', desc: 'çŒ«å¾¡ +10', effect: (p) => { p.def += 10; } },
        { type: 'white', icon: 'âš¡', title: 'æ•æ·æ­¥ä¼', desc: 'çŒ«é€Ÿ +5', effect: (p) => { p.spd += 5; } },
        { type: 'blue', icon: 'ğŸ’§', title: 'é­”æ³•æºæ³‰', desc: 'çŒ«èƒ½ +10', effect: (p) => { p.mp += 10; p.maxMp += 10; } }, 
        { type: 'green', icon: 'ğŸ—¡ï¸', title: 'å¼±ç‚¹çœ‹ç ´', desc: 'æš´å‡»ç‡ +5%', effect: (p) => { p.critRate += 0.05; } },
        { type: 'green', icon: 'âš”ï¸', title: 'è‡´å‘½ä¸€å‡»', desc: 'æš´å‡»ä¼¤å®³ +10%', effect: (p) => { p.critDmg += 0.1; } },
    ];

    let player = null;
    let enemy = null;
    let gameLevel = 1;
    let killCount = 0;
    let stageCount = 0; 
    let stageType = 'minion'; 
    let isPlayerTurn = true;
    let isPendingRogue = false;
    let selectedRogueCard = null;
    let isFirstRogue = false;
    
    let isTestingDamage = false;
    let testTimer = 0;
    let testTotalDamage = 0;
    let testInterval = null;

    const layers = {
        start: document.getElementById('startLayer'),
        select: document.getElementById('classLayer'),
        battle: document.getElementById('battleLayer'),
        card: document.getElementById('cardLayer'),
        over: document.getElementById('gameOverLayer'),
        changelog: document.getElementById('changelogLayer'),
        attr: document.getElementById('attrLayer')
    };
    const logs = document.getElementById('battleLog');

    // --- 0. åˆå§‹åŒ–æ£€æµ‹å­˜æ¡£ ---
    window.onload = function() {
        checkSave();
        const slider = document.getElementById('changelogBox');
        let isDown = false; let startY; let scrollTop;
        if (slider) {
            slider.addEventListener('mousedown', (e) => { isDown = true; startY = e.pageY - slider.offsetTop; scrollTop = slider.scrollTop; });
            slider.addEventListener('mouseleave', () => { isDown = false; });
            slider.addEventListener('mouseup', () => { isDown = false; });
            slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const y = e.pageY - slider.offsetTop; const walk = (y - startY) * 2; slider.scrollTop = scrollTop - walk; });
        }
    };

    function showLayer(name) {
        Object.values(layers).forEach(l => l.classList.remove('active'));
        layers[name].classList.add('active');
    }

    function log(msg, color = '#333') {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = msg;
        div.style.color = color;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    function floatText(text, targetEl, color='red', fontSize='24px') {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = text;
        el.style.color = color;
        el.style.fontSize = fontSize;
        el.style.left = '50%';
        el.style.top = '20%';
        el.style.marginLeft = (Math.random() * 40 - 20) + 'px';
        targetEl.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function showSlash(targetEl) {
        const el = document.createElement('div');
        el.className = 'slash-effect';
        targetEl.appendChild(el);
        setTimeout(() => el.remove(), 300);
    }

    function goToClassSelection() {
        const name = document.getElementById('playerNameInput').value.trim();
        if (!name) { alert("å¤§ä¾ è¯·ç•™åï¼"); return; }
        
        const container = document.getElementById('classContainer');
        container.innerHTML = '';
        CLASSES.forEach(cls => {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.innerHTML = `
                <div class="svg-icon">${cls.svg}</div>
                <h3 style="color:${cls.color}">${cls.name}</h3>
                <div class="stats-text">
                    çŒ«å¨: ${cls.base.atk} <span style="color:#27ae60">(+${cls.growth.atk})</span><br>
                    çŒ«èƒ½: ${cls.base.mp} <span style="color:#27ae60">(+${cls.growth.mp})</span><br>
                    çŒ«å¾¡: ${cls.base.def} <span style="color:#27ae60">(+${cls.growth.def})</span><br>
                    çŒ«è¡€: ${cls.base.hp} <span style="color:#27ae60">(+${cls.growth.hp})</span><br>
                    çŒ«é€Ÿ: ${cls.base.spd} <span style="color:#27ae60">(+${cls.growth.spd})</span>
                </div>
                <div class="talent-text">${cls.talent}</div>
            `;
            card.onclick = () => initGame(name, cls);
            container.appendChild(card);
        });
        showLayer('select');
    }

    function initGame(name, cls) {
        player = {
            name: name,
            cls: cls,
            lvl: 1,
            exp: 0,
            maxExp: 2,
            maxHp: cls.base.hp, hp: cls.base.hp,
            maxMp: cls.base.mp, mp: cls.base.mp,
            atk: cls.base.atk, def: cls.base.def, spd: cls.base.spd,
            critRate: 0, critDmg: 1.5,
            shieldUsed: false 
        };
        gameLevel = 1;
        killCount = 0;
        stageCount = 0;
        stageType = 'minion';
        
        document.getElementById('pName').innerText = player.name;
        document.getElementById('pVisual').innerHTML = cls.svg;
        
        saveGame();
        
        log("å†’é™©å¼€å§‹ï¼", '#f39c12');
        showRogueSelection(true); 
    }

    // --- å­˜æ¡£ç³»ç»Ÿ ---
    function saveGame(manual = false) {
        if (!player) return;
        const saveData = {
            player: player,
            clsId: player.cls.id, 
            gameLevel: gameLevel,
            killCount: killCount,
            stageCount: stageCount,
            stageType: stageType,
            timestamp: new Date().toLocaleString()
        };
        localStorage.setItem('bigCatQuestSave', JSON.stringify(saveData));
        
        if (manual) {
            log("ã€ç³»ç»Ÿã€‘æ¸¸æˆå·²æ‰‹åŠ¨ä¿å­˜ã€‚", '#27ae60');
            alert("å­˜æ¡£æˆåŠŸï¼");
        } else {
            checkSave(); 
        }
    }

    function checkSave() {
        const saveStr = localStorage.getItem('bigCatQuestSave');
        const btn = document.getElementById('continueBtn');
        if (saveStr) {
            const data = JSON.parse(saveStr);
            const cls = CLASSES.find(c => c.id === data.clsId);
            const clsName = cls ? cls.name : "æœªçŸ¥";
            btn.disabled = false;
            // æŒ‰é’®ä¸Šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            btn.innerHTML = `ç»§ç»­: ${clsName} Lv.${data.player.lvl}<br><span style="font-size:12px; font-weight:normal">ç¬¬ ${data.gameLevel} å±‚</span>`;
        } else {
            btn.disabled = true;
            btn.innerText = "æš‚æ— å­˜æ¡£";
        }
    }

    function loadGame() {
        const saveStr = localStorage.getItem('bigCatQuestSave');
        if (!saveStr) return;
        const data = JSON.parse(saveStr);
        
        player = data.player;
        player.cls = CLASSES.find(c => c.id === data.clsId);
        
        gameLevel = data.gameLevel;
        killCount = data.killCount;
        stageCount = data.stageCount;
        stageType = data.stageType;
        
        // å…¼å®¹æ€§
        if(player.critRate === undefined) player.critRate = 0;
        if(player.critDmg === undefined) player.critDmg = 1.5;
        if(player.shieldUsed === undefined) player.shieldUsed = false;
        
        document.getElementById('pName').innerText = player.name;
        document.getElementById('pVisual').innerHTML = player.cls.svg;
        
        updateUI();
        showLayer('battle');
        log("ã€ç³»ç»Ÿã€‘æ¬¢è¿å›æ¥ï¼Œå†’é™©ç»§ç»­ï¼", '#27ae60');
        
        startNextBattle();
    }

    function startNextBattle() {
        if (isPendingRogue) {
            isPendingRogue = false;
            showRogueSelection();
            return;
        }

        player.shieldUsed = false; 
        generateEnemy();
        updateUI();
        log(`<br><strong>=== ç¬¬ ${gameLevel} å±‚ ===</strong>`, '#3498db');
        log(`é­é‡äº† ${enemy.name}!`, '#e74c3c');

        isPlayerTurn = player.spd >= enemy.spd;
        setTimeout(battleLoop, 800);
    }

    function generateEnemy() {
        if (stageCount >= 5) {
            if (stageType === 'minion') stageType = 'elite'; 
        } else {
            stageType = 'minion';
        }
        if (stageType === 'boss') {
             stageType = 'minion';
             stageCount = 0;
        }
        if (!player.eliteKills) player.eliteKills = 0;
        if (stageCount >= 5) {
            if ((player.eliteKills + 1) % 5 === 0 && player.eliteKills > 0) {
                stageType = 'boss';
            } else {
                stageType = 'elite';
            }
        }

        let baseHp = 80 + (gameLevel * 25);
        let baseAtk = 15 + (gameLevel * 4);
        let baseDef = 5 + (gameLevel * 1); 
        let baseSpd = 10 + (gameLevel * 1.5); 

        let typeName = 'å°æ€ª';
        let svg = SVGS.monster_slime;
        let hpMult = 1.0, atkMult = 1.0, defMult = 1.0;

        if (stageType === 'elite') {
            typeName = 'ã€ç²¾è‹±ã€‘';
            svg = SVGS.monster_bat;
            hpMult = 2.5;
            atkMult = 1.3;
            defMult = 1.2;
        } else if (stageType === 'boss') {
            typeName = 'ã€é­”ç‹ã€‘';
            svg = SVGS.monster_dragon;
            hpMult = 5.5; 
            atkMult = 1.5; 
            defMult = 1.4;
        }

        enemy = {
            name: typeName,
            maxHp: Math.floor(baseHp * hpMult * (0.9 + Math.random()*0.2)),
            hp: 0,
            atk: Math.floor(baseAtk * atkMult),
            def: Math.floor(baseDef * defMult),
            spd: Math.floor(baseSpd),
            visual: svg
        };
        enemy.hp = enemy.maxHp;
        
        document.getElementById('eName').innerText = enemy.name;
        document.getElementById('eVisual').innerHTML = enemy.visual;
    }

    function battleLoop() {
        if (!isTestingDamage && (player.hp <= 0 || enemy.hp <= 0)) return;
        if (isTestingDamage && enemy.hp <= 0) enemy.hp = enemy.maxHp;
        if (isTestingDamage && player.hp <= 0) player.hp = 1; 

        if (isPlayerTurn) performPlayerAttack();
        else performEnemyAttack();
    }

    function performPlayerAttack() {
        const pEl = document.getElementById('playerEl');
        pEl.style.transform = 'translateX(30px)';
        setTimeout(() => pEl.style.transform = 'translateX(0)', 200);
        showSlash(document.getElementById('enemyEl'));

        if (player.cls.id === 'wise') {
            let rec = Math.ceil(player.maxMp * 0.05);
            player.mp = Math.min(player.maxMp, player.mp + rec);
        }

        let dmgMult = 1.0;
        let extraDmg = 0;
        let selfDmg = 0;
        
        if (player.cls.id === 'wise') {
            let cost = Math.floor(player.mp * 0.1);
            if (cost > 0) { player.mp -= cost; dmgMult += cost * 0.01; if(!isTestingDamage) log(`[å¥¥æœ¯] è€—è“å¢ä¼¤`); }
        }
        if (player.cls.id === 'berserk') {
            let cost = Math.floor(player.hp * 0.2);
            selfDmg = cost;
            let missingPct = (player.maxHp - player.hp)/player.maxHp * 100;
            dmgMult += missingPct * 0.01;
            if(!isTestingDamage) log(`[è¡€æ€’] è€—è¡€å¢ä¼¤`);
        }
        if (player.cls.id === 'agile') {
            extraDmg += player.spd * (1 + Math.floor(player.lvl/10)*0.2);
        }

        let isCrit = Math.random() < player.critRate;
        let finalMult = dmgMult;
        if (isCrit) {
            finalMult *= player.critDmg;
        }

        let dmg = Math.max(1, Math.floor(player.atk * finalMult - enemy.def + extraDmg));
        enemy.hp -= dmg;
        
        if(isTestingDamage) testTotalDamage += dmg;

        let floatColor = isCrit ? '#e74c3c' : '#fff';
        let floatSize = isCrit ? '32px' : '24px';
        let floatMsg = isCrit ? `æš´å‡»! ${dmg}` : dmg;
        floatText(floatMsg, document.getElementById('enemyEl'), floatColor, floatSize);
        
        if(!isTestingDamage) {
            if(isCrit) log(`âš¡æš´å‡» ${dmg}!`, '#c0392b');
            else log(`é€ æˆ ${dmg} ä¼¤å®³ã€‚`);
        }

        if (player.cls.id === 'agile' && enemy.hp > 0) {
            let spdCoef = 1.0 + Math.floor(player.lvl/10)*0.2;
            let extra = Math.floor(player.spd * spdCoef);
            setTimeout(() => {
                enemy.hp -= extra;
                if(isTestingDamage) testTotalDamage += extra;
                floatText("+" + extra, document.getElementById('enemyEl'), '#f1c40f', '28px');
                if(!isTestingDamage) log(`[è¿å‡»] è¿½åŠ  ${extra}!`, '#f1c40f');
                updateUI();
                if (!isTestingDamage && enemy.hp <= 0) checkResult();
                else checkMultiHit(); 
            }, 300);
        } else {
            if (selfDmg > 0) {
                player.hp -= selfDmg;
                let drain = Math.floor(dmg * 0.1);
                player.hp += drain;
                if(!isTestingDamage) floatText(`+${drain}`, document.getElementById('playerEl'), '#2ecc71', '16px');
            }
            updateUI();
            if (enemy.hp > 0) checkMultiHit();
            else if (!isTestingDamage) checkResult();
        }
    }
    
    function checkMultiHit() {
        if (player.spd >= enemy.spd * 2 && Math.random() > 0.4) {
            if(!isTestingDamage) log(">>> æé€Ÿè¿å‡»! <<<", '#f39c12');
            setTimeout(performPlayerAttack, 600);
        } else {
            isPlayerTurn = false;
            setTimeout(battleLoop, 1000);
        }
    }

    function performEnemyAttack() {
        const eEl = document.getElementById('enemyEl');
        eEl.style.transform = 'translateX(-30px)';
        setTimeout(() => eEl.style.transform = 'translateX(0)', 200);
        showSlash(document.getElementById('playerEl'));

        let dmg = Math.max(1, Math.floor(enemy.atk - player.def));
        
        if (player.hp - dmg <= 0 && player.cls.id === 'wise' && player.mp > 0 && !player.shieldUsed) {
            let needBlock = dmg - (player.hp - 1);
            let manaCost = Math.ceil(needBlock / 2);
            if (player.mp >= manaCost) {
                player.mp -= manaCost;
                dmg -= needBlock;
                player.shieldUsed = true; 
                if(!isTestingDamage) log("ğŸ›¡ï¸ [å¥¥æœ¯] æŠ¤ç›¾æŠµæŒ¡!", '#3498db');
            }
        }

        player.hp -= dmg;
        floatText(dmg, document.getElementById('playerEl'), '#c0392b');
        if(!isTestingDamage) log(`å—åˆ° ${dmg} ä¼¤å®³ã€‚`);
        
        updateUI();
        
        if (player.cls.id === 'resolute' && player.hp > 0) {
            let reflect = 0;
            if (player.def >= player.atk * 5) {
                reflect = player.def * 2 + player.hp * 0.2;
                if(!isTestingDamage) log(`[è†æ£˜] é«˜é˜¶åä¼¤!`, '#f1c40f');
            } else if (player.def >= player.atk * 2) {
                reflect = player.def;
                if(!isTestingDamage) log(`[è†æ£˜] åä¼¤!`, '#f1c40f');
            }
            if (reflect > 0) {
                reflect = Math.floor(reflect);
                setTimeout(() => {
                    enemy.hp -= reflect;
                    if(isTestingDamage) testTotalDamage += reflect;
                    floatText(`åä¼¤${reflect}`, document.getElementById('enemyEl'), '#e67e22');
                    updateUI();
                    if (!isTestingDamage) checkResult();
                }, 300);
            } else {
                if (!isTestingDamage) checkResult();
            }
        } else {
            if (!isTestingDamage) checkResult();
        }

        if (player.hp > 0 && enemy.hp > 0) {
            isPlayerTurn = true;
            setTimeout(battleLoop, 800);
        }
    }

    function checkResult() {
        if(enemy.hp <= 0 && document.getElementById('eName').innerText !== "å·²å‡»è´¥") {
            let rawName = enemy.name;
            document.getElementById('eName').innerText = "å·²å‡»è´¥";
            log(`${rawName} å€’ä¸‹äº†!`, '#27ae60');
            killCount++;
            stageCount++; 
            
            let gainExp = player.lvl + 1;
            player.exp += gainExp;
            while (player.exp >= player.maxExp) {
                player.exp -= player.maxExp;
                levelUp();
            }
            
            let heal = Math.floor(player.maxHp * 0.1);
            player.hp = Math.min(player.maxHp, player.hp + heal);
            log(`èƒœåˆ©æ¢å¤ ${heal} [çŒ«è¡€]`, '#2ecc71');

            gameLevel++;
            
            // è‡ªåŠ¨ä¿å­˜ (é™¤äº†æµ‹è¯•æ¨¡å¼)
            if (!isTestingDamage) saveGame();

            updateUI();

            if (stageType === 'elite' || stageType === 'boss') {
                player.eliteKills = (player.eliteKills || 0) + 1;
                isPendingRogue = true; 
                stageCount = 0; 
            }

            setTimeout(startNextBattle, 1500);

        } else if (player.hp <= 0) {
            player.hp = 0;
            updateUI();
            document.getElementById('goReason').innerText = `åœ¨ç¬¬ ${gameLevel} å±‚è¢« ${enemy.name} å‡»è´¥`;
            showLayer('over');
        }
    }

    function levelUp() {
        player.lvl++;
        player.maxExp = player.lvl * 2; 
        const g = player.cls.growth;
        player.atk += g.atk;
        player.mp += g.mp; player.maxMp += g.mp;
        player.def += g.def;
        player.hp += g.hp; player.maxHp += g.hp;
        player.spd += g.spd;
        floatText("LV UP!", document.getElementById('playerEl'), '#f1c40f', '32px');
        log(`å‡çº§! ç­‰çº§ ${player.lvl}`, '#f1c40f');
    }

    function revivePlayer() {
        gameLevel = Math.max(1, gameLevel - 5);
        player.hp = player.maxHp;
        player.mp = player.maxMp;
        stageCount = 0;
        log("=== æ—¶å…‰å€’æµï¼Œé‡æ–°å¼€å§‹ ===", '#3498db');
        saveGame(); // å¤æ´»åç«‹å³ä¿å­˜é˜²æ­¢SL
        showLayer('battle');
        startNextBattle();
    }

    function showRogueSelection(first = false) {
        selectedRogueCard = null;
        const container = document.getElementById('rogueContainer');
        const btn = document.getElementById('confirmCardBtn');
        btn.disabled = true;
        btn.innerText = "è¯·é€‰æ‹©ä¸€é¡¹";
        container.innerHTML = '';
        
        const shuffled = CARDS.sort(() => 0.5 - Math.random());
        const choices = shuffled.slice(0, 3);

        choices.forEach(card => {
            const el = document.createElement('div');
            el.className = `rogue-card card-${card.type}`;
            el.innerHTML = `
                <div class="card-icon">${card.icon}</div>
                <h3>${card.title}</h3>
                <p>${card.desc}</p>
            `;
            el.onclick = () => {
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                selectedRogueCard = card;
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤é€‰æ‹©";
            };
            container.appendChild(el);
        });
        showLayer('card');
    }

    function confirmRogueSelection() {
        if (!selectedRogueCard) return;
        selectedRogueCard.effect(player);
        log(`é€‰æ‹©äº† [${selectedRogueCard.title}]`, '#8e44ad');
        if(selectedRogueCard.type !== 'green') {
             player.hp = Math.min(player.maxHp, player.hp + player.maxHp * 0.3);
             player.mp = Math.min(player.maxMp, player.mp + player.maxMp * 0.3);
        }
        updateUI();
        showLayer('battle');
        startNextBattle();
    }

    function showAttrPanel() {
        if(!player) return;
        document.getElementById('attrName').innerText = player.name;
        document.getElementById('attrClass').innerText = player.cls.name;
        document.getElementById('attrLvl').innerText = player.lvl;
        document.getElementById('attrHp').innerText = Math.floor(player.hp) + "/" + player.maxHp;
        document.getElementById('attrMp').innerText = Math.floor(player.mp) + "/" + player.maxMp;
        document.getElementById('attrAtk').innerText = player.atk;
        document.getElementById('attrDef').innerText = player.def;
        document.getElementById('attrSpd').innerText = player.spd;
        document.getElementById('attrCrit').innerText = Math.floor(player.critRate * 100) + "%";
        document.getElementById('attrCritDmg').innerText = Math.floor(player.critDmg * 100) + "%";
        showLayer('attr');
    }

    function closeAttrPanel() {
        showLayer('battle');
    }

    // --- ä¿®å¤ç‰ˆæ‰“æ¡©ç³»ç»Ÿ ---
    function startDamageTest() {
        if(!player || isTestingDamage) return;
        
        isTestingDamage = true;
        testTotalDamage = 0;
        testTimer = 10;
        
        // æ»¡è¡€å¼€å§‹æµ‹è¯•ï¼Œé˜²æ­¢æš´æ¯™
        player.hp = player.maxHp; 
        
        let originalEnemy = JSON.parse(JSON.stringify(enemy));
        
        let dummyHp = 9999999;
        let dummyAtk = enemy.atk; 
        let dummyDef = enemy.def;
        let dummySpd = enemy.spd;
        
        enemy = {
            name: "è®­ç»ƒæœ¨æ¡©",
            maxHp: dummyHp,
            hp: dummyHp,
            atk: dummyAtk,
            def: dummyDef,
            spd: dummySpd,
            visual: SVGS.stake
        };
        
        document.getElementById('eName').innerText = enemy.name;
        document.getElementById('eVisual').innerHTML = enemy.visual;
        updateUI();
        
        log("=== å¼€å§‹ä¼¤å®³æµ‹è¯• (10s) ===", '#3498db');
        log("æœ¨æ¡©å·²ç”Ÿæˆï¼Œå±æ€§åŒå½“å‰æ€ªç‰©ã€‚", '#7f8c8d');
        
        testInterval = setInterval(() => {
            testTimer--;
            if (testTimer <= 0) {
                endDamageTest(originalEnemy);
            } else {
                log(`æµ‹è¯•å‰©ä½™: ${testTimer}s`, '#bdc3c7');
            }
        }, 1000);
    }

    function endDamageTest(original) {
        clearInterval(testInterval);
        isTestingDamage = false;
        
        let dps = (testTotalDamage / 10).toFixed(1);
        log("=== æµ‹è¯•ç»“æŸ ===", '#3498db');
        log(`æ€»ä¼¤å®³: ${testTotalDamage}`, '#e67e22');
        log(`ç§’ä¼¤(DPS): ${dps}`, '#e74c3c');
        
        // æ¢å¤
        enemy = original;
        document.getElementById('eName').innerText = enemy.name;
        document.getElementById('eVisual').innerHTML = enemy.visual;
        
        // å…³é”®ä¿®å¤ï¼šæ¢å¤è¡€é‡ï¼Œå¼ºåˆ¶é‡å¯å¾ªç¯
        player.hp = player.maxHp; 
        updateUI();
        
        // å¼ºåˆ¶é‡æ–°å¼€å§‹æœ¬å±‚æˆ˜æ–—å¾ªç¯ï¼ˆç›¸å½“äºåˆ·æ–°æ€ªç‰©çŠ¶æ€ï¼‰
        // è¿™æ ·å¯ä»¥é¿å…â€œå¡ä½â€
        isPlayerTurn = player.spd >= enemy.spd;
        setTimeout(battleLoop, 1000);
    }

    function updateUI() {
        if(!player) return;
        const setBar = (id, cur, max) => {
            document.getElementById(id).style.width = Math.min(100, Math.max(0, cur/max*100)) + '%';
        };
        setBar('pHpBar', player.hp, player.maxHp);
        setBar('pMpBar', player.mp, player.maxMp);
        setBar('eHpBar', enemy ? enemy.hp : 0, enemy ? enemy.maxHp : 1);
        setBar('expFill', player.exp, player.maxExp);
        
        document.getElementById('expText').innerText = `${player.exp}/${player.maxExp}`;
        document.getElementById('levelText').innerText = gameLevel;
        document.getElementById('killText').innerText = killCount;
        document.getElementById('pLvVal').innerText = player.lvl;
    }

</script>
</body>
</html>