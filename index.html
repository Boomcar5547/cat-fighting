<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§çŒ«çŒ«æ–—æ¶é¾™ Ver4.01</title>
    <style>
        /* --- å…¨å±€æ ·å¼ (ä¸¥æ ¼å¯¹é½ Ver3.08) --- */
        body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; touch-action: none; user-select: none; }
        #gameContainer { position: relative; width: 100%; height: 100%; max-width: 480px; max-height: 900px; background: #fff; box-shadow: 0 0 30px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; }
        
        /* ç•Œé¢å±‚çº§ */
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.98); z-index: 10; padding: 20px; box-sizing: border-box; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .active { display: flex; }
        .layer-scroll { justify-content: flex-start; padding-top: 40px; padding-bottom: 60px; }

        /* åŸºç¡€ç»„ä»¶ (æ¢å¤åŸå§‹px) */
        h1 { color: #e67e22; text-shadow: 2px 2px #f1c40f; margin-bottom: 5px; text-align: center; flex-shrink: 0;}
        h2 { color: #2c3e50; margin-bottom: 20px; text-align: center; }
        .version { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; flex-shrink: 0;}
        input { padding: 12px; border: 2px solid #3498db; border-radius: 8px; width: 70%; text-align: center; font-size: 16px; margin-bottom: 20px; flex-shrink: 0;}
        
        /* æŒ‰é’®æ ·å¼ (æ¢å¤åŸå§‹ï¼Œç§»é™¤width:80%å’Œheight:60pxç­‰V4é”™è¯¯ä¿®æ”¹) */
        button { padding: 10px 25px; background: #e67e22; color: white; border: none; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #d35400; transition: all 0.1s; margin: 5px; flex-shrink: 0;}
        button:active { transform: translateY(4px); box-shadow: 0 0 0 #d35400; }
        button:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; transform: none; color: #fff; }
        
        .btn-blue { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-blue:active { transform: translateY(4px); box-shadow: 0 0 0 #2980b9; }
        .btn-green { background: #2ecc71; box-shadow: 0 4px 0 #27ae60; }
        .btn-green:active { transform: translateY(4px); box-shadow: 0 0 0 #27ae60; }
        .btn-gray { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; font-size: 14px; padding: 8px 20px; width: 70%; }
        .btn-purple { background: #9b59b6; box-shadow: 0 4px 0 #8e44ad; }
        
        .btn-home { position: absolute; top: 10px; left: 10px; width: 36px; height: 36px; border-radius: 50%; background: #fff; border: 2px solid #bdc3c7; color: #7f8c8d; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; padding: 0; margin: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* æ—¥å¿—ä¸å±æ€§ */
        .scroll-box { width: 100%; flex-grow: 1; background: #f9f9f9; border: 2px solid #bdc3c7; border-radius: 10px; padding: 15px; box-sizing: border-box; overflow-y: auto; margin-bottom: 20px; text-align: left; cursor: grab; min-height: 200px; }
        .log-block { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .log-ver { color: #e67e22; font-weight: 900; font-size: 16px; margin-bottom: 5px; }
        .log-date { color: #95a5a6; font-size: 12px; margin-bottom: 8px; }
        .log-list { padding-left: 20px; margin: 0; }
        .log-list li { font-size: 13px; color: #34495e; margin-bottom: 4px; line-height: 1.5; }
        .highlight { color: #c0392b; font-weight: bold; }
        .alert-box { background-color: #fce4ec; border: 1px solid #e91e63; color: #c2185b; padding: 10px; border-radius: 5px; font-size: 13px; margin-top: 10px; line-height: 1.5; }

        .attr-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px; color: #34495e; }
        .attr-val { color: #2980b9; font-family: monospace; font-size: 16px; }

        /* èŒä¸šé€‰æ‹© */
        .card-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; padding-bottom: 20px; }
        .class-card { background: white; border: 2px solid #bdc3c7; border-radius: 10px; padding: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
        .class-card:hover { border-color: #3498db; transform: scale(1.02); }
        .class-card h3 { margin: 5px 0; color: #2c3e50; font-size: 15px; }
        .svg-icon { width: 60px; height: 60px; margin: 5px auto; }
        .stats-text { font-size: 9px; color: #7f8c8d; text-align: left; line-height: 1.3; width: 100%; }
        .talent-text { font-size: 9px; color: #c0392b; margin-top: 5px; font-weight: bold; text-align: left; border-top: 1px dashed #eee; padding-top:5px; width: 100%; }

        /* æˆ˜æ–—ç•Œé¢ */
        #battleLayer { background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #90EE90 70%, #90EE90 100%); justify-content: space-between; padding: 0; overflow: hidden;}
        .cloud { position: absolute; background: white; border-radius: 50px; opacity: 0.8; animation: floatCloud 20s linear infinite; }
        @keyframes floatCloud { from { left: -100px; } to { left: 100%; } }
        .battle-hud { width: 100%; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; padding-left: 50px; box-sizing: border-box; display: flex; justify-content: space-between; font-size: 14px; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .battle-scene { flex-grow: 1; width: 100%; position: relative; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 25%; z-index: 2; }
        .fighter { width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; transition: transform 0.2s; }
        .fighter-svg { width: 100%; height: 100%; filter: drop-shadow(0 5px 2px rgba(0,0,0,0.2)); }
        .status-box { position: absolute; top: -40px; width: 100%; text-align: center; }
        .fighter-name { background: rgba(0,0,0,0.5); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 12px; display: inline-block; margin-bottom: 2px; }
        .bar-bg { width: 80px; height: 8px; background: #333; border-radius: 4px; margin: 1px auto; overflow: hidden; border:1px solid #fff;}
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.3s; }
        .mp-fill { height: 100%; background: #3498db; width: 100%; transition: width 0.3s; }

        .toolbar { position: absolute; bottom: 140px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 6; padding: 0 5px; }
        .tool-btn { width: 40px; height: 40px; background: #fff; border: 2px solid #bdc3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.1s; }
        .tool-btn:active { transform: scale(0.9); }
        .tool-btn svg { width: 22px; height: 22px; }

        .bottom-panel { width: 100%; background: #fff; padding: 10px; box-sizing: border-box; border-top: 4px solid #f1c40f; z-index: 5; }
        .exp-container { width: 100%; height: 15px; background: #bdc3c7; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .exp-fill { height: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); width: 0%; transition: width 0.5s; }
        .exp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; font-size: 10px; line-height: 15px; color: #333; font-weight: bold; }

        .floating-text { position: absolute; font-weight: 900; font-size: 28px; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0 #fff; z-index: 20; white-space: nowrap; left: 50%; transform: translateX(-50%); top: -40px; pointer-events: none; }
        @keyframes floatUp { 0% { top: -40px; opacity: 1; transform: translateX(-50%) scale(1); } 100% { top: -90px; opacity: 0; transform: translateX(-50%) scale(1.2); } }
        .slash-effect { position: absolute; width: 150px; height: 150px; background: transparent; border: 2px solid transparent; z-index: 15; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .slash-effect::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 4px; background: #e74c3c; transform: rotate(-45deg); box-shadow: 0 0 10px #c0392b; animation: slashAnim 0.3s forwards; }
        @keyframes slashAnim { 0% { width: 0; opacity: 0; } 50% { width: 100%; opacity: 1; } 100% { width: 100%; opacity: 0; } }

        .log-box { width: 100%; height: 120px; background: #f8f9fa; overflow-y: auto; padding: 10px; box-sizing: border-box; font-size: 12px; border-top: 1px solid #ccc; }
        .log-entry { margin-bottom: 3px; border-bottom: 1px dashed #eee; padding-bottom: 2px; line-height: 1.4;}
        
        #rogueContainer { display: flex; flex-direction: row; justify-content: space-between; align-items: stretch; width: 100%; gap: 10px; margin-bottom: 20px;}
        .rogue-card { flex: 1; border: 2px solid #ccc; border-radius: 8px; padding: 10px 5px; background: #fff; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .rogue-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        .rogue-card.selected { border: 3px solid #f1c40f; background: #fcf8e3; transform: scale(1.05); box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); }
        .card-icon { font-size: 32px; margin-bottom: 5px; }
        .card-white { border-top: 5px solid #bdc3c7; }
        .card-green { border-top: 5px solid #2ecc71; }
        .card-blue { border-top: 5px solid #3498db; }
        .card-purple { border-top: 5px solid #9b59b6; }
        .card-orange { border-top: 5px solid #e67e22; }

        /* å­˜æ¡£æ§½ä½ */
        .slot-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .save-slot { background: #fff; border: 2px solid #bdc3c7; border-radius: 10px; padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; position: relative; }
        .save-slot:hover { border-color: #3498db; transform: scale(1.01); }
        .save-slot.empty { border-style: dashed; background: #f9f9f9; color: #95a5a6; justify-content: center; }
        .slot-info { display: flex; flex-direction: column; align-items: flex-start; }
        .slot-title { font-weight: bold; color: #2c3e50; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .slot-detail { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .slot-icon { width: 30px; height: 30px; }
        .delete-btn { padding: 5px 10px; font-size: 12px; background: #e74c3c; border-radius: 5px; margin-left: 10px; z-index: 5; color: white;}
        
        /* --- V4.0 æ–°å¢å…ƒç´  (ä»…æ–°å¢ï¼Œä¸è¦†ç›–åŸæœ‰) --- */
        #reviveCount { font-size: 80px; color: #e74c3c; font-weight: bold; text-shadow: 2px 2px 0 #fff; margin: 20px 0; }
        
        .equip-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; background: #ecf0f1; border-radius: 8px; margin-bottom: 10px; }
        .item-slot { width: 100%; padding-bottom: 100%; position: relative; background: #bdc3c7; border-radius: 5px; cursor: pointer; border: 2px solid #95a5a6; }
        .item-slot.active { border-color: #f1c40f; background: #fff; }
        .item-slot.rare-white { border-color: #bdc3c7; background: #f0f0f0; }
        .item-slot.rare-green { border-color: #2ecc71; background: #e8f8f5; }
        .item-slot.rare-blue { border-color: #3498db; background: #ebf5fb; }
        .item-slot.rare-purple { border-color: #9b59b6; background: #f4ecf7; }
        .item-slot.rare-orange { border-color: #e67e22; background: #fef5e7; }
        .item-slot.rare-red { border-color: #e74c3c; background: #fdedec; box-shadow: 0 0 5px #e74c3c; } 
        .item-slot.rare-material { border-color: #7f8c8d; background: #d5d8dc; } 
        .item-icon { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .item-lvl { position: absolute; bottom: 1px; right: 2px; font-size: 8px; color: #333; font-weight: bold; }
        .item-count { position: absolute; top: 1px; left: 2px; font-size: 8px; color: #2c3e50; font-weight: bold; }
        
        .equip-panel { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; padding: 5px;}
        .equip-slot { width: 45px; height: 45px; background: #ecf0f1; border: 2px dashed #bdc3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .equip-slot.filled { border-style: solid; background: #fff; }
        .slot-label { position: absolute; top: -14px; font-size: 9px; color: #7f8c8d; white-space: nowrap; }

        .item-detail { background: #fff; border: 2px solid #34495e; padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 10px; min-height: 80px; }
        .item-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .item-stats { color: #2c3e50; line-height: 1.4; }
        .item-desc { color: #7f8c8d; font-style: italic; margin-top: 5px; font-size: 10px; }
        .mat-display { display:flex; justify-content:space-around; background:#34495e; color:#fff; padding:5px; border-radius:5px; margin-bottom:5px; font-size:12px; }
        
        .shop-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #bdc3c7; margin-bottom: 5px; border-radius: 5px; }
        .currency { color: #f1c40f; font-weight: bold; text-shadow: 1px 1px 0 #d35400; margin-right: 10px; }
    </style>
</head>
<body>

<div id="gameContainer">
    
    <div id="startLayer" class="layer active layer-scroll">
        <h1>å¤§çŒ«çŒ«æ–—æ¶é¾™</h1>
        <div class="version">Ver4.01.12172501beta</div>
        <svg width="150" height="150" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="#f1c40f" stroke="#e67e22" stroke-width="3"/>
            <path d="M30 30 L40 10 L55 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <path d="M70 30 L60 10 L45 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <circle cx="35" cy="45" r="5" fill="#2c3e50"/>
            <circle cx="65" cy="45" r="5" fill="#2c3e50"/>
            <path d="M45 60 Q50 70 55 60" stroke="#c0392b" stroke-width="3" fill="none"/>
            <path d="M10 50 L90 50" stroke="#bdc3c7" stroke-width="5" opacity="0.5"/>
        </svg>
        <br>
        <button class="btn-green" id="continueBtn" onclick="openSlotMenu('load')" disabled style="width:80%">è¯»å–å­˜æ¡£</button>
        <br>
        <button class="btn-blue" onclick="openSlotMenu('new')" style="width:70%">æ–°æ¸¸æˆ</button>
        <br>
        <button class="btn-gray" onclick="showLayer('changelogLayer')" style="width:70%">æ›´æ–°æ—¥å¿—</button>
    </div>

    <div id="slotLayer" class="layer layer-scroll">
        <h2 id="slotTitle">é€‰æ‹©å­˜æ¡£</h2>
        <div id="slotList" class="slot-container"></div>
        <button onclick="showLayer('startLayer')" style="margin-top:20px; background:#95a5a6;">è¿”å›</button>
    </div>

    <div id="nameInputLayer" class="layer">
        <h2>åˆ›å»ºè§’è‰²</h2>
        <input type="text" id="playerNameInput" placeholder="è¯·è¾“å…¥ä½ çš„å‹‡è€…å" maxlength="8">
        <button onclick="goToClassSelection()">ä¸‹ä¸€æ­¥</button>
        <button onclick="showLayer('startLayer')" style="background:#95a5a6;">å–æ¶ˆ</button>
    </div>

    <div id="classLayer" class="layer layer-scroll">
        <h2 style="color:#2c3e50; font-size: 20px;">è¯·é€‰æ‹©ä½ çš„èŒä¸š</h2>
        <div class="card-container" id="classContainer"></div>
        <button onclick="showLayer('nameInputLayer')" style="margin-top:20px; background:#95a5a6;">è¿”å›</button>
    </div>

    <div id="battleLayer" class="layer">
        <div class="cloud" style="top:20px; width:80px; height:30px; animation-duration:25s;"></div>
        <div class="cloud" style="top:60px; width:120px; height:40px; animation-duration:35s; animation-delay:-10s"></div>

        <button class="btn-home" onclick="goToMainMenu()" title="è¿”å›ä¸»èœå•">ğŸ </button>
        <div style="position:absolute; top:10px; right:10px; color:#f1c40f; font-weight:bold; text-shadow:1px 1px 0 #000;">
            ğŸ’° <span id="goldVal">0</span>
        </div>

        <div class="battle-hud">
            <div>ğŸ“ ç¬¬ <span id="levelText" style="color:#f1c40f; font-weight:bold">1</span> å±‚</div>
            <div>ğŸ’€ å‡»æ€: <span id="killText">0</span></div>
        </div>

        <div class="battle-scene">
            <div id="playerEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="pName">å‹‡è€…</div>
                    <div class="bar-bg"><div class="hp-fill" id="pHpBar"></div></div>
                    <div class="bar-bg" style="margin-top:1px; height:4px; border:none;"><div class="mp-fill" id="pMpBar"></div></div>
                    <div style="font-size:10px; color:#fff; text-shadow:1px 1px 0 #000;" id="pMpVal"></div>
                </div>
                <div id="pVisual" class="fighter-svg"></div>
            </div>
            <div id="enemyEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="eName">æ€ªç‰©</div>
                    <div class="bar-bg"><div class="hp-fill" id="eHpBar"></div></div>
                </div>
                <div id="eVisual" class="fighter-svg"></div>
            </div>
        </div>

        <div class="toolbar">
            <div class="tool-btn" onclick="showAttrPanel()" title="å±æ€§"><svg viewBox="0 0 24 24" fill="#34495e"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg></div>
            <div class="tool-btn" onclick="showInventory()" title="èƒŒåŒ…"><svg viewBox="0 0 24 24" fill="#e67e22"><path d="M12 2l-5.5 9h11z"/><path d="M10 12h4v4h-4z"/><path d="M4 14v8h16v-8l-2-3H6z"/></svg></div>
            <div class="tool-btn" onclick="startDamageTest()" title="æœ¨æ¡©" style="background:#c0392b; border-color:#c0392b;"><svg viewBox="0 0 24 24" fill="#fff"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4h2v4zm2-6H8V9h6v2z"/></svg></div>
            <div class="tool-btn" onclick="saveGame(true)" title="ä¿å­˜"><svg viewBox="0 0 24 24" fill="#2980b9"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></div>
        </div>

        <div class="bottom-panel">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                <span>EXP</span><span>LV.<span id="pLvVal">1</span></span>
            </div>
            <div class="exp-container"><div class="exp-fill" id="expFill"></div><div class="exp-text" id="expText">0/2</div></div>
        </div>
        <div class="log-box" id="battleLog"><div class="log-entry">æ¬¢è¿æ¥åˆ°å¤§çŒ«çŒ«çš„ä¸–ç•Œ...</div></div>
    </div>

    <div id="cardLayer" class="layer layer-scroll">
        <h2 style="color:#8e44ad; font-size:22px;">ğŸ å‘½è¿çš„é¦ˆèµ </h2>
        <div id="rogueContainer"></div>
        <button id="confirmCardBtn" onclick="confirmRogueSelection()" disabled style="width:80%; margin-top:20px;">ç¡®è®¤é€‰æ‹©</button>
    </div>

    <div id="gameOverLayer" class="layer">
        <h1 style="color: #c0392b;">ğŸ’” èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹</h1>
        <p id="goReason" style="font-size:18px; color:#34495e;">...</p>
        <div style="font-size: 60px; margin: 30px;">ğŸš‘</div>
        <div id="reviveCount">3</div>
        <p style="color:#7f8c8d; font-size:14px;">å¤§çŒ«çŒ«æ–½å±•äº†æ—¶é—´å›æº¯é­”æ³•ï¼<br>å³å°†è‡ªåŠ¨å¤æ´»...</p>
    </div>

    <div id="attrLayer" class="layer layer-scroll">
        <h2>è§’è‰²å±æ€§</h2>
        <div class="scroll-box" style="margin-bottom:20px;" id="attrContent"></div>
        <button onclick="closeAttrPanel()">è¿”å›æˆ˜æ–—</button>
    </div>
    
    <div id="inventoryLayer" class="layer">
        <h2>ğŸ’ èƒŒåŒ… & è£…å¤‡</h2>
        <div class="mat-display">
            <span>ğŸª¨ é­”é“çŸ¿: <span id="matOre">0</span></span>
            <span>ğŸ”® è§£å°çŸ³: <span id="matStone">0</span></span>
        </div>
        <div class="equip-panel">
            <div class="equip-slot" id="slot-weapon" onclick="unequipItem('weapon')"><div class="slot-label">æ­¦å™¨</div><div id="visual-weapon"></div></div>
            <div class="equip-slot" id="slot-offhand" onclick="unequipItem('offhand')"><div class="slot-label">å‰¯æ‰‹</div><div id="visual-offhand"></div></div>
            <div class="equip-slot" id="slot-helm" onclick="unequipItem('helm')"><div class="slot-label">å¤´ç›”</div><div id="visual-helm"></div></div>
            <div class="equip-slot" id="slot-shoulders" onclick="unequipItem('shoulders')"><div class="slot-label">æŠ¤è‚©</div><div id="visual-shoulders"></div></div>
            <div class="equip-slot" id="slot-armor" onclick="unequipItem('armor')"><div class="slot-label">ç›”ç”²</div><div id="visual-armor"></div></div>
            <div class="equip-slot" id="slot-belt" onclick="unequipItem('belt')"><div class="slot-label">è…°å¸¦</div><div id="visual-belt"></div></div>
            <div class="equip-slot" id="slot-boots" onclick="unequipItem('boots')"><div class="slot-label">é‹å­</div><div id="visual-boots"></div></div>
            <div class="equip-slot" id="slot-accessory" onclick="unequipItem('accessory')"><div class="slot-label">é¥°å“</div><div id="visual-accessory"></div></div>
            <div class="equip-slot" id="slot-ringL" onclick="unequipItem('ringL')"><div class="slot-label">å·¦æˆ’</div><div id="visual-ringL"></div></div>
            <div class="equip-slot" id="slot-ringR" onclick="unequipItem('ringR')"><div class="slot-label">å³æˆ’</div><div id="visual-ringR"></div></div>
        </div>
        <div class="item-detail" id="itemDetailBox">ç‚¹å‡»ç‰©å“æŸ¥çœ‹è¯¦æƒ…</div>
        <div class="equip-grid" id="bagGrid"></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-gray" onclick="changeBagPage(-1)">â—€</button>
            <span style="line-height:40px;">é¡µ <span id="bagPageNum">1</span> / 10</span>
            <button class="btn-gray" onclick="changeBagPage(1)">â–¶</button>
        </div>
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:5px;">
            <button class="btn-green" id="btnEquip" onclick="equipSelectedItem()" disabled>è£…å¤‡</button>
            <button class="btn-purple" id="btnUpgrade" onclick="upgradeExclusive()" style="display:none;">è§£å°</button>
            <button class="btn-purple" onclick="forgeExclusive()">é”»é€ ä¸“å±</button>
            <button class="btn-blue" onclick="trySynthesize()">ä¸€é”®åˆæˆ</button>
            <button class="btn-gray" onclick="closeInventory()">å…³é—­</button>
        </div>
    </div>
    
    <div id="shopLayer" class="layer">
        <h2 style="color:#f39c12">ğŸ›’ æµæµªçŒ«å•†äºº</h2>
        <p>ç¬¬ <span id="shopLevel"></span> å±‚è¡¥ç»™ç‚¹</p>
        <div class="scroll-box" id="shopContainer" style="height:300px;"></div>
        <button onclick="leaveShop()">ç¦»å¼€å•†åº—</button>
    </div>

    <div id="changelogLayer" class="layer layer-scroll">
        <h2>ç¼–å¹´å²</h2>
        <div class="scroll-box" id="changelogBox"></div>
        <button onclick="showLayer('startLayer')">è¿”å›ä¸»ç•Œé¢</button>
    </div>

</div>

<script>
    // --- 0. SVG (Ver3.08 Complex Version) ---
    const SVGS = {
        cat_resolute: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><rect x="30" y="15" width="20" height="25" rx="5" fill="none" stroke="#2c3e50" stroke-width="2"/><line x1="40" y1="15" x2="40" y2="40" stroke="#2c3e50" stroke-width="1"/><line x1="30" y1="27" x2="50" y2="27" stroke="#2c3e50" stroke-width="1"/><path d="M65 40 L90 10" stroke="#95a5a6" stroke-width="6"/><path d="M65 40 L90 10" stroke="#2c3e50" stroke-width="2"/><line x1="60" y1="45" x2="70" y2="35" stroke="#f1c40f" stroke-width="4"/></g></svg>`,
        cat_agile: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M70 40 L85 25" stroke="#3498db" stroke-width="4"/><path d="M10 40 L-5 25" stroke="#3498db" stroke-width="4"/></g></svg>`,
        cat_wise: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><line x1="75" y1="20" x2="75" y2="80" stroke="#8e44ad" stroke-width="4"/><circle cx="75" cy="20" r="8" fill="#e74c3c"/></g></svg>`,
        cat_berserk: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="30" x2="35" y2="38" stroke="#000" stroke-width="2"/><line x1="55" y1="30" x2="45" y2="38" stroke="#000" stroke-width="2"/><path d="M35 50 Q40 45 45 50" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M80 40 L80 70 M70 40 L90 40 L80 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/><path d="M0 40 L0 70 M-10 40 L10 40 L0 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/></g></svg>`,
        cat_blood: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M25 35 Q30 25 35 35" stroke="#e74c3c" stroke-width="3" fill="none"/><path d="M45 35 Q50 25 55 35" stroke="#e74c3c" stroke-width="3" fill="none"/><circle cx="30" cy="38" r="2" fill="#e74c3c"/><circle cx="50" cy="38" r="2" fill="#e74c3c"/><path d="M70 50 Q80 20 50 10" stroke="#c0392b" stroke-width="4" fill="none"/><line x1="70" y1="50" x2="80" y2="80" stroke="#95a5a6" stroke-width="3"/></g></svg>`,
        cat_mech: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><path d="M15 20 L65 20 L75 35 L75 70 L50 80 L25 70 L5 70 L5 35 Z" fill="#7f8c8d" stroke="#34495e" stroke-width="2"/><rect x="15" y="35" width="50" height="10" fill="#3498db"/><line x1="10" y1="20" x2="5" y2="0" stroke="#34495e" stroke-width="3"/><line x1="70" y1="20" x2="75" y2="0" stroke="#34495e" stroke-width="3"/><rect x="75" y="50" width="20" height="10" fill="#2c3e50"/><circle cx="95" cy="55" r="3" fill="#e74c3c"/></g></svg>`,
        monster_slime: `<svg viewBox="0 0 100 100"><path d="M20 80 Q20 20 50 20 Q80 20 80 80 Z" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/><circle cx="40" cy="50" r="5" fill="#000"/><circle cx="60" cy="50" r="5" fill="#000"/></svg>`,
        monster_bat: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="15" fill="#34495e"/><path d="M35 50 Q10 20 10 50 Q20 70 35 55" fill="#34495e"/><path d="M65 50 Q90 20 90 50 Q80 70 65 55" fill="#34495e"/><circle cx="45" cy="50" r="2" fill="#e74c3c"/><circle cx="55" cy="50" r="2" fill="#e74c3c"/></svg>`,
        monster_dragon: `<svg viewBox="0 0 100 100"><path d="M30 60 Q30 30 50 20 Q70 30 70 60" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/><path d="M50 20 L50 5" stroke="#e74c3c" stroke-width="4"/><circle cx="40" cy="45" r="4" fill="#f1c40f"/><circle cx="60" cy="45" r="4" fill="#f1c40f"/><path d="M40 70 Q50 80 60 70" stroke="#000" stroke-width="2" fill="none"/></svg>`,
        monster_evil_dragon: `<svg viewBox="0 0 100 100"><path d="M20 70 Q40 20 80 30 Q90 50 70 80 Q50 90 20 70 Z" fill="#2c3e50" stroke="#000" stroke-width="2"/><path d="M80 30 Q95 10 90 5 Q70 15 60 35" fill="#c0392b"/><path d="M30 40 Q40 50 30 60" stroke="#c0392b" stroke-width="3" fill="none"/><circle cx="65" cy="45" r="3" fill="#e74c3c"/><circle cx="75" cy="55" r="3" fill="#e74c3c"/><path d="M10 60 Q20 40 10 20" stroke="#2c3e50" stroke-width="4" fill="none"/></svg>`,
        stake: `<svg viewBox="0 0 100 100"><rect x="35" y="20" width="30" height="70" fill="#d35400" stroke="#5d4037" stroke-width="2"/><circle cx="50" cy="40" r="8" fill="#fff" opacity="0.8"/><circle cx="50" cy="40" r="3" fill="#000"/><path d="M35 20 L50 5 L65 20 Z" fill="#d35400" stroke="#5d4037" stroke-width="2"/></svg>`
    };

    // --- èŒä¸šå®šä¹‰ (æ¢å¤è¯¦ç»†æ–‡æœ¬) ---
    const CLASSES = [
        { id: 'resolute', name: 'åšæ¯…çŒ«', svg: SVGS.cat_resolute, color: '#95a5a6', base: {atk:32, mp:5, def:25, hp:200, spd:10}, growth: {atk:3, mp:1, def:15, hp:50, spd:1}, talent: 'ã€è†æ£˜ç”²å£³ã€‘è‹¥[çŒ«å¾¡]â‰¥[çŒ«å¨]x2åå¼¹[çŒ«å¾¡]x1ä¼¤å®³ï¼›è‹¥â‰¥x5ï¼Œåå¼¹[çŒ«å¾¡]x2+[çŒ«è¡€]x0.2ä¼¤å®³ã€‚åä¼¤å¯è§¦å‘æš´å‡»ã€‚' },
        { id: 'agile', name: 'çµæ´»çŒ«', svg: SVGS.cat_agile, color: '#f1c40f', base: {atk:40, mp:8, def:10, hp:80, spd:20}, growth: {atk:10, mp:2, def:3, hp:20, spd:4}, talent: 'ã€è¿…æ·è¿å‡»ã€‘æ”»å‡»åè¿½åŠ ä¸€æ®µ[çŒ«é€Ÿ]x1çš„çœŸå®ä¼¤å®³(ä¸çˆ†å‡»)ã€‚æ¯å‡10çº§ç³»æ•°+0.2ã€‚' },
        { id: 'wise', name: 'æ™ºæ…§çŒ«', svg: SVGS.cat_wise, color: '#9b59b6', base: {atk:45, mp:20, def:10, hp:70, spd:10}, growth: {atk:15, mp:10, def:3, hp:18, spd:2}, talent: 'ã€å¥¥æœ¯è¶…è½½ã€‘æ¶ˆè€—10%[çŒ«èƒ½]å¢ä¼¤ã€‚è‡´æ­»æ—¶æ¶ˆè€—[çŒ«èƒ½]æŠµæŒ¡ä¼¤å®³(å•åœºé™1æ¬¡)ã€‚' },
        { id: 'berserk', name: 'ç‹‚æš´çŒ«', svg: SVGS.cat_berserk, color: '#c0392b', base: {atk:50, mp:6, def:8, hp:100, spd:15}, growth: {atk:20, mp:1, def:3, hp:25, spd:2}, talent: 'ã€é²œè¡€æ¸´æœ›ã€‘æ¶ˆè€—20%[çŒ«è¡€]æ”»å‡»ï¼Œè¡€è¶Šå°‘ä¼¤è¶Šé«˜ï¼Œå¸¦10%å¸è¡€ã€‚' },
        { id: 'blood', name: 'è¡€éª‘çŒ«', svg: SVGS.cat_blood, color: '#8e44ad', base: {atk:25, mp:6, def:12, hp:200, spd:10}, growth: {atk:12, mp:1, def:3, hp:50, spd:1}, talent: 'ã€é­”è¡€å¥”æ¶Œã€‘æ¯ç§’ç¼çƒ§æ•Œæ–¹([çŒ«å¨]x0.8+[çŒ«è¡€]x0.2)ç‚¹çœŸå®ä¼¤å®³ï¼Œè¯¥ä¼¤å®³ä¸å¯çˆ†å‡»ã€‚' },
        { id: 'mech', name: 'æœºæ¢°çŒ«', svg: SVGS.cat_mech, color: '#34495e', base: {atk:30, mp:12, def:25, hp:120, spd:0}, growth: {atk:15, mp:4, def:3, hp:20, spd:0}, talent: 'ã€CAAATÎ©ç«ç®­å¼¹ã€‘æ— æ³•æ™®æ”»/äº«å—çŒ«é€Ÿã€‚æ¯0.2ç§’æ¶ˆè€—2%å½“å‰[çŒ«èƒ½]é€ æˆ[çŒ«å¨]x0.2+å‰©ä½™[çŒ«èƒ½]x0.7ä¼¤å®³ï¼Œå¯çˆ†å‡»ã€‚' }
    ];

    const CARDS = [
        { type: 'white', icon: 'âš”ï¸', title: 'åŠ›é‡è®­ç»ƒ', desc: 'çŒ«å¨ +10', effect: (p) => { p.atk += 10; } },
        { type: 'white', icon: 'â¤ï¸', title: 'ä½“èƒ½å¼ºåŒ–', desc: 'çŒ«è¡€ +60', effect: (p) => { p.maxHp += 60; p.hp += 60; } },
        { type: 'white', icon: 'ğŸ›¡ï¸', title: 'ç¡¬åŒ–çš®æ¯›', desc: 'çŒ«å¾¡ +10', effect: (p) => { p.def += 10; } },
        { type: 'white', icon: 'âš¡', title: 'æ•æ·æ­¥ä¼', desc: 'çŒ«é€Ÿ +5', effect: (p) => { p.spd += 5; } },
        { type: 'white', icon: 'ğŸ’§', title: 'å†¥æƒ³', desc: 'çŒ«èƒ½ +5', effect: (p) => { p.mp += 5; p.maxMp += 5; } },
        { type: 'green', icon: 'ğŸ¯', title: 'å¼±ç‚¹çœ‹ç ´', desc: 'æš´å‡»ç‡ +5%', effect: (p) => { p.critRate += 0.05; } },
        { type: 'green', icon: 'ğŸ’¥', title: 'è‡´å‘½ä¸€å‡»', desc: 'çˆ†ä¼¤ +10%', effect: (p) => { p.critDmg += 0.1; } },
        { type: 'green', icon: 'ğŸ’š', title: 'ç”Ÿå‘½æºæ³‰', desc: 'çŒ«è¡€ +200', effect: (p) => { p.maxHp += 200; p.hp += 200; } },
        { type: 'green', icon: 'ğŸ”°', title: 'é’¢é“æ„å¿—', desc: 'çŒ«å¾¡ +40', effect: (p) => { p.def += 40; } },
        { type: 'green', icon: 'ğŸ‘Ÿ', title: 'æé€Ÿ', desc: 'çŒ«é€Ÿ +12', effect: (p) => { p.spd += 12; } },
        { type: 'green', icon: 'ğŸ§ª', title: 'é­”åŠ›æ‰©å®¹', desc: 'çŒ«èƒ½ +15', effect: (p) => { p.mp += 15; p.maxMp += 15; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ‘ï¸', title: 'é¹°çœ¼', desc: 'æš´å‡» +8%', effect: (p) => { p.critRate += 0.08; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ’£', title: 'æ¯ç­æ‰“å‡»', desc: 'çˆ†ä¼¤ +20%', effect: (p) => { p.critDmg += 0.2; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ’—', title: 'æ³°å¦ä¹‹å¿ƒ', desc: 'çŒ«è¡€ +500', effect: (p) => { p.maxHp += 500; p.hp += 500; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ°', title: 'ä¸åŠ¨å¦‚å±±', desc: 'çŒ«å¾¡ +80', effect: (p) => { p.def += 80; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸš€', title: 'å…‰é€Ÿ', desc: 'çŒ«é€Ÿ +20', effect: (p) => { p.spd += 20; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸŒŒ', title: 'è™šç©ºé­”èƒ½', desc: 'çŒ«èƒ½ +30', effect: (p) => { p.mp += 30; p.maxMp += 30; } },
        { type: 'blue', minLvl: 100, unique: true, id: 'heal_kill', icon: 'ğŸ§›', title: 'ä»¥æˆ˜å…»æˆ˜', desc: 'èƒœåˆ©å›å¤60%æŸè€—', effect: (p) => { p.hasHealKill = true; } },
        { type: 'blue', minLvl: 100, unique: true, id: 'low_hp_spd', icon: 'ğŸ”¥', title: 'èƒŒæ°´ä¸€æˆ˜', desc: 'ä½è¡€é‡åŠ çŒ«é€Ÿ', effect: (p) => { p.hasLowHpSpd = true; } },
    ];

    // [Ver4.0] å­—å…¸
    const EQUIP_SLOTS = ['weapon', 'offhand', 'helm', 'shoulders', 'armor', 'belt', 'boots', 'accessory', 'ringL', 'ringR'];
    const QUALITIES = {
        white: { name:'ç ´æ—§', color:'#95a5a6', statMod:1.0, affixes:0 },
        green: { name:'ç²¾è‰¯', color:'#2ecc71', statMod:1.1, affixes:1 },
        blue: { name:'ç¨€æœ‰', color:'#3498db', statMod:1.2, affixes:2 },
        purple: { name:'å²è¯—', color:'#9b59b6', statMod:1.35, affixes:3 },
        orange: { name:'ä¼ è¯´', color:'#e67e22', statMod:1.5, affixes:4 },
        red: { name:'ä¸“å±', color:'#e74c3c', statMod:2.0, affixes:5 }
    };
    const AFFIX_POOL = [
        { id:'atk', text:'çŒ«å¨+', w:10 }, { id:'def', text:'çŒ«å¾¡+', w:10 }, { id:'hp', text:'çŒ«è¡€+', w:10 },
        { id:'spd', text:'çŒ«é€Ÿ+', w:5 }, { id:'mp', text:'çŒ«èƒ½+', w:5 },
        { id:'crit', text:'æš´å‡»+', w:3, val:0.01 }, { id:'critDmg', text:'çˆ†ä¼¤+', w:3, val:0.05 },
        { id:'regenHp', text:'å›è¡€+', w:3 }, { id:'regenMp', text:'å›è“+', w:3 }
    ];
    const MATERIALS = {
        ore: { id:'ore', name:'é­”é“çŸ¿', color:'#7f8c8d', desc:'ç”¨äºé“¸é€ è£…å¤‡' },
        stone: { id:'stone', name:'è§£å°çŸ³', color:'#9b59b6', desc:'ç”¨äºæå‡ä¸“å±è£…å¤‡é˜¶æ®µ' }
    };
    const EXCLUSIVE_STATS = {
        resolute: { atk:0.5, def:3.5, hp:2.0, spd:0.2, mp:0.1 }, 
        agile:    { atk:1.5, def:0.5, hp:1.0, spd:2.0, mp:0.5 },
        wise:     { atk:2.0, def:0.5, hp:1.0, spd:0.5, mp:3.0 },
        berserk:  { atk:1.5, def:0.5, hp:5.0, spd:1.0, mp:0.1 },
        blood:    { atk:1.0, def:1.5, hp:3.0, spd:0.5, mp:0.5 },
        mech:     { atk:1.2, def:1.2, hp:1.5, spd:0,   mp:2.5 }
    };
    const EXCLUSIVE_GEAR = {
        resolute: { id:'exclusive_resolute', slot:'offhand', name:'åšæ¯…çŒ«ã®å¹æ¯', desc:'é«˜é˜²åä¼¤å€ç‡+50%, 7å€é˜²è§¦å‘æ ¸çˆ†åä¼¤' },
        agile: { id:'exclusive_agile', slot:'boots', name:'çµæ´»çŒ«ã®æ­¥ä¼', desc:'å¤©èµ‹çœŸå®ä¼¤å®³å¯æš´å‡»' },
        wise: { id:'exclusive_wise', slot:'accessory', name:'æ™ºæ…§çŒ«ã®ä½è¯­', desc:'å‡çº§æˆé•¿å¤§å¹…æå‡, è€—è“å¢ä¼¤ç³»æ•°1.0%->1.2%' },
        berserk: { id:'exclusive_berserk', slot:'belt', name:'ç‹‚æš´çŒ«ã®æ‹¥æŠ±', desc:'æ¯è€—1è¡€è¿½åŠ 1ä¼¤å®³(å¯æš´å‡»)' },
        blood: { id:'exclusive_blood', slot:'offhand', name:'è¡€éª‘çŒ«ã®å®ˆæœ›', desc:'ç¼çƒ§å…¬å¼åŠ å…¥çŒ«å¾¡åŠ æˆ' },
        mech: { id:'exclusive_mech', slot:'helm', name:'æœºæ¢°çŒ«ã®å‡è§†', desc:'è½°ç‚¸é¢‘ç‡ 0.2s -> 0.15s' }
    };

    // --- å…¨å±€å˜é‡ ---
    let player = null;
    let enemy = null;
    let gameLevel = 1;
    let killCount = 0;
    let stageCount = 0; 
    let stageType = 'minion'; 
    let isPlayerTurn = true;
    let isPendingRogue = false;
    let selectedRogueCard = null;
    let isGameActive = false;
    let currentSlotId = null; 
    let lastBossType = null;
    
    let bloodInterval = null;
    let mechInterval = null;
    let battleLoopId = null; 
    let testInterval = null;

    // UI æ˜ å°„ [Fix: strict match to HTML IDs]
    const layers = {
        start: document.getElementById('startLayer'),
        slot: document.getElementById('slotLayer'),
        name: document.getElementById('nameInputLayer'), // KEY 'name' -> ID 'nameInputLayer'
        select: document.getElementById('classLayer'),
        battle: document.getElementById('battleLayer'),
        card: document.getElementById('cardLayer'),
        over: document.getElementById('gameOverLayer'),
        changelog: document.getElementById('changelogLayer'),
        attr: document.getElementById('attrLayer'),
        inventory: document.getElementById('inventoryLayer'),
        shop: document.getElementById('shopLayer')
    };

    window.onload = function() {
        const legacySave = localStorage.getItem('bigCatQuestSave');
        const slot0 = localStorage.getItem('bigCatQuest_slot_0');
        if (legacySave && !slot0) {
            localStorage.setItem('bigCatQuest_slot_0', legacySave);
        }
        checkSave();
        const slider = document.getElementById('changelogBox');
        let isDown = false; let startY; let scrollTop;
        if (slider) {
            slider.addEventListener('mousedown', (e) => { isDown = true; startY = e.pageY - slider.offsetTop; scrollTop = slider.scrollTop; });
            slider.addEventListener('mouseleave', () => { isDown = false; });
            slider.addEventListener('mouseup', () => { isDown = false; });
            slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const y = e.pageY - slider.offsetTop; const walk = (y - startY) * 2; slider.scrollTop = scrollTop - walk; });
        }
    };

    function showLayer(name) {
        Object.values(layers).forEach(l => { if(l) l.classList.remove('active'); });
        if(layers[name]) layers[name].classList.add('active');
        else { console.error("Layer missing: " + name); alert("ç•Œé¢è·³è½¬é”™è¯¯: " + name); }
    }

    // --- å­˜æ¡£ç³»ç»Ÿ ---
    function migrateSaveData(p) {
        // [Ver4.05 Fix] ç¡®ä¿ p.equips å­˜åœ¨
        if(!p.gold) p.gold = 0;
        if(!p.inventory) p.inventory = [];
        if(!p.equips) p.equips = {}; 
        
        EQUIP_SLOTS.forEach(slot => {
            if(!p.equips[slot]) p.equips[slot] = null;
        });
        
        p.maxInventory = 160; 
        return p;
    }

    function saveGame() {
        if (!player || currentSlotId === null) return;
        const data = {
            player: player,
            clsId: player.cls.id,
            gameLevel: gameLevel,
            killCount: killCount,
            stageCount: stageCount,
            stageType: stageType,
            timestamp: new Date().toLocaleString()
        };
        localStorage.setItem(`bigCatQuest_slot_${currentSlotId}`, JSON.stringify(data));
    }

    function loadGameFromSlot(data) {
        try {
            // [Ver4.05 Fix] å…¼å®¹æ—§å­˜æ¡£
            player = migrateSaveData(data.player);
            player.cls = CLASSES.find(c => c.id === data.clsId);
            
            // å¦‚æœèŒä¸šIDå˜äº†å¯¼è‡´æ‰¾ä¸åˆ°ï¼Œå›é€€åˆ°åšæ¯…çŒ«é˜²æ­¢å´©
            if (!player.cls) {
                console.warn("Class ID mismatch, defaulting to resolute");
                player.cls = CLASSES[0];
            }

            gameLevel = data.gameLevel;
            killCount = data.killCount;
            stageCount = data.stageCount;
            stageType = data.stageType;
            
            if(player.critRate === undefined) player.critRate = 0;
            if(player.critDmg === undefined) player.critDmg = 1.5;
            if(!player.uniqueCards) player.uniqueCards = [];
            
            // æ¢å¤ UI
            document.getElementById('pName').innerText = player.name;
            document.getElementById('pVisual').innerHTML = player.cls.svg;
            updateUI();
            showLayer('battle');
            startNextBattle();
        } catch(e) {
            console.error(e);
            alert("å­˜æ¡£æ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨é‡ç½®è¯¥æ§½ä½ã€‚");
            localStorage.removeItem(`bigCatQuest_slot_${currentSlotId}`);
            openSlotMenu('load');
        }
    }

    function openSlotMenu(mode) {
        const container = document.getElementById('slotList');
        container.innerHTML = '';
        for(let i=0; i<3; i++) {
            const saveStr = localStorage.getItem(`bigCatQuest_slot_${i}`);
            const el = document.createElement('div');
            el.className = 'save-slot';
            
            if(saveStr) {
                try {
                    const d = JSON.parse(saveStr);
                    const cls = CLASSES.find(c => c.id === d.clsId);
                    const icon = cls ? cls.svg : 'â“';
                    const name = cls ? cls.name : 'æœªçŸ¥';
                    el.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="slot-icon">${icon}</div>
                            <div class="slot-info">
                                <div class="slot-title">${name} <span style="font-size:12px; color:#27ae60">Lv.${d.player.lvl}</span></div>
                                <div class="slot-detail">ç¬¬ ${d.gameLevel} å±‚ | ${d.timestamp.split(' ')[0]}</div>
                            </div>
                        </div>
                    `;
                    const del = document.createElement('div');
                    del.innerHTML = 'ğŸ—‘ï¸'; del.className = 'delete-btn';
                    del.onclick = (e) => { e.stopPropagation(); if(confirm("åˆ é™¤?")) { localStorage.removeItem(`bigCatQuest_slot_${i}`); openSlotMenu(mode); } };
                    el.appendChild(del);
                    
                    el.onclick = () => {
                        currentSlotId = i;
                        if(mode==='load') loadGameFromSlot(d); 
                        else if(confirm("è¦†ç›–?")) showLayer('name'); 
                    };
                } catch(e) {
                    el.innerHTML = '<div>å­˜æ¡£æŸå</div>';
                    el.onclick = () => { if(confirm("è¦†ç›–æŸåå­˜æ¡£?")) { currentSlotId = i; showLayer('name'); } };
                }
            } else {
                el.innerHTML = '<div>+ ç©ºæ§½ä½</div>'; el.className += ' empty';
                el.onclick = () => { 
                    currentSlotId = i; 
                    showLayer('name'); 
                };
            }
            container.appendChild(el);
        }
        showLayer('slot');
    }

    // --- æ ¸å¿ƒæµç¨‹ ---
    function goToClassSelection() {
        const name = document.getElementById('playerNameInput').value.trim();
        if (!name) { alert("å¤§ä¾ è¯·ç•™åï¼"); return; }
        const container = document.getElementById('classContainer');
        container.innerHTML = '';
        CLASSES.forEach(cls => {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.innerHTML = `
                <div class="svg-icon">${cls.svg}</div>
                <h3 style="color:${cls.color || '#333'}">${cls.name}</h3>
                <div class="stats-text">
                    å¨: ${cls.base.atk} <span style="color:#27ae60">(+${cls.growth.atk})</span> èƒ½: ${cls.base.mp} <span style="color:#27ae60">(+${cls.growth.mp})</span><br>
                    å¾¡: ${cls.base.def} <span style="color:#27ae60">(+${cls.growth.def})</span> è¡€: ${cls.base.hp} <span style="color:#27ae60">(+${cls.growth.hp})</span><br>
                    é€Ÿ: ${cls.base.spd} <span style="color:#27ae60">(+${cls.growth.spd})</span>
                </div>
                <div class="talent-text">${cls.talent}</div>
            `;
            card.onclick = () => initGame(name, cls);
            container.appendChild(card);
        });
        showLayer('select');
    }

    function initGame(name, cls) {
        player = {
            name: name, cls: cls, lvl: 1, exp: 0, maxExp: 2,
            maxHp: cls.base.hp, hp: cls.base.hp, maxMp: cls.base.mp, mp: cls.base.mp,
            atk: cls.base.atk, def: cls.base.def, spd: cls.base.spd,
            critRate: 0, critDmg: 1.5,
            uniqueCards: [], hasHealKill: false, hasLowHpSpd: false,
            // V4.0 åˆå§‹åŒ–
            gold: 0, inventory: [], maxInventory: 160,
            equips: { weapon:null, offhand:null, helm:null, shoulders:null, armor:null, belt:null, boots:null, accessory:null, ringL:null, ringR:null }
        };
        gameLevel = 1; killCount = 0; stageCount = 0; stageType = 'minion';
        
        document.getElementById('pName').innerText = player.name;
        document.getElementById('pVisual').innerHTML = cls.svg;
        
        saveGame();
        log("å†’é™©å¼€å§‹ï¼", '#f39c12');
        showRogueSelection(true); 
    }

    function startNextBattle() {
        isGameActive = true;
        clearAllTimers();

        // å•†åº—é€»è¾‘
        if (gameLevel > 1 && gameLevel % 8 === 0 && stageCount === 0 && !isPendingRogue) {
            isGameActive = false;
            openShop();
            return;
        }

        if (isPendingRogue) {
            isPendingRogue = false;
            showRogueSelection();
            return;
        }

        player.shieldUsed = false;
        generateEnemy();
        updateUI();
        
        let titleColor = '#3498db';
        if (stageType === 'evil_dragon') titleColor = '#c0392b';
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<br><strong style="color:${titleColor}">=== ç¬¬ ${gameLevel} å±‚ ===</strong>`;
        document.getElementById('battleLog').appendChild(div);
        
        // èŒä¸šè¢«åŠ¨
        if (player.cls.id === 'blood') {
            bloodInterval = setInterval(() => {
                if(!isGameActive) return;
                let dot = Math.floor(getPlayerStat('atk') * 0.8 + getPlayerStat('hp') * 0.2);
                if (hasEquip('exclusive_blood')) { 
                    dot = Math.floor(getPlayerStat('atk') * 1.0 + getPlayerStat('hp') * 0.25 + getPlayerStat('def') * 0.8);
                }
                enemy.hp -= dot;
                floatText(`-${dot}`, document.getElementById('enemyEl'), '#8e44ad', '20px');
                updateUI();
                if(enemy.hp <= 0) checkResult();
            }, 1000);
        }
        if (player.cls.id === 'mech') {
            let freq = hasEquip('exclusive_mech') ? 150 : 200; 
            mechInterval = setInterval(() => {
                if(!isGameActive) return;
                let cost = player.mp * 0.02; 
                if (player.mp > 0) {
                    player.mp = Math.max(0, player.mp - cost);
                    let dmgBase = getPlayerStat('atk') * 0.25 + player.mp * 0.75;
                    let isCrit = Math.random() < getPlayerStat('critRate');
                    let dmg = Math.floor(dmgBase * (isCrit ? getPlayerStat('critDmg') : 1));
                    enemy.hp -= Math.max(1, dmg);
                    floatText(dmg, document.getElementById('enemyEl'), isCrit?'#e74c3c':'#fff', '16px');
                    updateUI();
                    if(enemy.hp <= 0) checkResult();
                }
            }, freq);
        }

        if (player.cls.id !== 'mech') {
            battleLoopId = setTimeout(battleLoop, 800);
        }
    }

    // --- æˆ˜æ–—é€»è¾‘ ---
    function getPlayerStat(key) {
        let val = player[key];
        if (key === 'hp') val = player.maxHp;
        
        for(let k in player.equips) {
            let eq = player.equips[k];
            if(eq) {
                if(eq.quality === 'red') {
                    val += getDynamicStat(eq, key);
                } else {
                    if(eq.stats && eq.stats[key]) val += eq.stats[key];
                }
                if(eq.affixes) {
                    eq.affixes.forEach(aff => {
                        if(aff.id === key) val += aff.val;
                    });
                }
            }
        }
        return val;
    }
    
    function getDynamicStat(item, statKey) {
        if(!item || item.quality !== 'red') return 0;
        let coef = EXCLUSIVE_STATS[player.cls.id][statKey] || 0;
        let base = Math.floor(gameLevel * coef);
        let bonus = Math.floor(base * 0.1 * (item.upgradeLevel || 0));
        return base + bonus;
    }

    function hasEquip(id) {
        for(let k in player.equips) {
            if(player.equips[k] && player.equips[k].uid === id) return true;
        }
        return false;
    }

    function generateEnemy() {
        if (stageCount >= 5) {
            if (stageType === 'minion') stageType = 'elite'; 
        } else { stageType = 'minion'; }
        if (stageType === 'boss') { stageType = 'minion'; stageCount = 0; }
        if (!player.eliteKills) player.eliteKills = 0;
        if (stageCount >= 5) {
            if ((player.eliteKills + 1) % 5 === 0 && player.eliteKills > 0) stageType = 'boss';
            else stageType = 'elite';
        }

        if (gameLevel % 100 === 0) { stageType = 'evil_dragon'; }

        let baseHp = 80 + (gameLevel * 25);
        let baseAtk = 15 + (gameLevel * 4);
        let baseDef = 5 + (gameLevel * 1); 
        let baseSpd = 10 + (gameLevel * 1.5); 

        let typeName = 'å°æ€ª';
        let svg = SVGS.monster_slime;
        let hpMult = 1.0, atkMult = 1.0, defMult = 1.0;

        if (stageType === 'elite') { typeName = 'ã€ç²¾è‹±ã€‘'; svg = SVGS.monster_bat; hpMult = 2.5; atkMult = 1.3; defMult = 1.2; } 
        else if (stageType === 'boss') { typeName = 'ã€é­”ç‹ã€‘'; svg = SVGS.monster_dragon; hpMult = 5.5; atkMult = 1.5; defMult = 1.4; }
        else if (stageType === 'evil_dragon') { typeName = 'ã€é‚ªé¾™ã€‘'; svg = SVGS.monster_evil_dragon; hpMult = 7.0; atkMult = 1.7; defMult = 1.6; }

        enemy = {
            name: typeName, type: stageType, visual: svg,
            maxHp: Math.floor(baseHp * hpMult * (0.9 + Math.random()*0.2)),
            hp: 0,
            atk: Math.floor(baseAtk * atkMult),
            def: Math.floor(baseDef * defMult),
            spd: Math.floor(baseSpd)
        };
        enemy.hp = enemy.maxHp;
        
        document.getElementById('eName').innerText = enemy.name;
        document.getElementById('eVisual').innerHTML = svg;
    }

    function battleLoop() {
        if(!isGameActive) return;
        if(enemy.hp <= 0) { checkResult(); return; }
        if(player.hp <= 0) { checkResult(); return; }
        
        let pSpd = getPlayerStat('spd');
        if(player.hasLowHpSpd) pSpd *= (1 + (player.maxHp - player.hp)/player.maxHp * 0.6);
        
        if (pSpd >= enemy.spd) {
            performPlayerAttack();
            if(enemy.hp > 0 && pSpd >= enemy.spd * 2 && Math.random()>0.4) {
                 setTimeout(performPlayerAttack, 400); 
            } else {
                 setTimeout(performEnemyAttack, 800);
            }
        } else {
            performEnemyAttack();
            if(player.hp > 0) setTimeout(performPlayerAttack, 800);
        }
    }

    function performPlayerAttack() {
        if(enemy.hp <= 0) return;
        
        const pEl = document.getElementById('playerEl');
        pEl.style.transform = 'translateX(30px)';
        setTimeout(() => pEl.style.transform = 'translateX(0)', 200);
        showSlash(document.getElementById('enemyEl'));

        let atk = getPlayerStat('atk');
        let crit = getPlayerStat('critRate');
        let cdmg = getPlayerStat('critDmg');
        
        if(player.cls.id === 'wise') {
             let cost = Math.floor(player.mp * 0.1);
             let bonus = hasEquip('exclusive_wise') ? 0.012 : 0.01;
             atk *= (1 + cost * bonus);
             player.mp -= cost;
        }
        if(player.cls.id === 'berserk') {
             let cost = Math.floor(player.hp * 0.2);
             player.hp -= cost; 
             atk *= (1 + (player.maxHp-player.hp)/player.maxHp);
             if(hasEquip('exclusive_berserk')) {
                 let extra = cost; 
                 enemy.hp -= Math.max(1, extra - enemy.def); 
                 floatText("+" + extra, document.getElementById('enemyEl'), '#c0392b');
             }
        }
        if(player.cls.id === 'agile') {
             // çµæ´»çŒ«è¢«åŠ¨1: é¢å¤–åŠ æˆ
        }

        let isCrit = Math.random() < crit;
        let dmg = Math.max(1, Math.floor(atk * (isCrit ? cdmg : 1) - enemy.def));
        
        if(player.cls.id === 'resolute' && hasEquip('exclusive_resolute')) {
            if(getPlayerStat('def') >= atk * 2) dmg = Math.floor(dmg * 1.5);
        }

        enemy.hp -= dmg;
        floatText(isCrit ? "æš´å‡» "+dmg : dmg, document.getElementById('enemyEl'), isCrit?'#e74c3c':'#fff', isCrit?'32px':'24px');
        updateUI();

        if(player.cls.id === 'agile' && enemy.hp > 0) {
            setTimeout(()=>{
                let extra = getPlayerStat('spd') * (1 + Math.floor(player.lvl/10)*0.2);
                let canCrit = hasEquip('exclusive_agile');
                let exCrit = canCrit && Math.random() < crit;
                if(exCrit) extra *= cdmg;
                enemy.hp -= Math.floor(extra);
                floatText("+" + Math.floor(extra), document.getElementById('enemyEl'), '#f1c40f', '28px');
                updateUI();
                if(enemy.hp <= 0) checkResult();
            }, 300);
        } else if (enemy.hp <= 0) {
            checkResult();
        }
    }

    function performEnemyAttack() {
        if(enemy.hp <= 0) return;
        
        const eEl = document.getElementById('enemyEl');
        eEl.style.transform = 'translateX(-30px)';
        setTimeout(() => eEl.style.transform = 'translateX(0)', 200);
        showSlash(document.getElementById('playerEl'));

        let penRate = 0.1;
        if(enemy.type === 'elite') penRate = 0.25;
        if(enemy.type === 'boss') penRate = 0.40;
        if(enemy.type === 'evil_dragon') penRate = 0.50;
        
        let def = getPlayerStat('def');
        let rawDmg = enemy.atk - def;
        let penDmg = enemy.atk * penRate;
        let dmg = Math.max(1, Math.floor(Math.max(rawDmg, penDmg)));
        
        if(player.hp - dmg <= 0 && player.cls.id === 'wise' && player.mp > dmg/2 && !player.shieldUsed) {
            player.mp -= Math.ceil(dmg/2);
            dmg = 0; player.shieldUsed = true;
            log("ğŸ›¡ï¸ [å¥¥æœ¯] æŠ¤ç›¾æŠµæŒ¡!", "#3498db");
        }

        player.hp -= dmg;
        floatText(dmg, document.getElementById('playerEl'), '#c0392b');
        updateUI();

        if(player.cls.id === 'resolute' && player.hp > 0) {
            let reflect = 0;
            let atk = getPlayerStat('atk');
            if(def >= atk * 5) reflect = def * 2 + player.hp * 0.2;
            else if(def >= atk * 2) reflect = def;
            
            if(hasEquip('exclusive_resolute') && def >= atk * 7) {
                reflect = def * 3 + player.hp * 0.35;
                reflect *= 1.5;
            }

            if(reflect > 0) {
                let isCrit = Math.random() < getPlayerStat('critRate');
                reflect = reflect * (isCrit ? getPlayerStat('critDmg') : 1);
                enemy.hp -= Math.floor(reflect);
                floatText("åä¼¤ " + Math.floor(reflect), document.getElementById('enemyEl'), '#e67e22');
            }
        }
        
        if(enemy.type === 'evil_dragon' && player.hp > 0) {
             let db = Math.floor(player.maxHp * 0.07);
             setTimeout(()=>{ player.hp -= db; floatText(db, document.getElementById('playerEl'), '#f1c40f'); updateUI(); if(player.hp<=0) checkResult(); }, 400);
        }

        if(player.hp <= 0) checkResult();
        else if (isGameActive && enemy.hp > 0) battleLoopId = setTimeout(battleLoop, 800);
    }

    function checkResult() {
        if(enemy.hp <= 0) {
            clearAllTimers();
            document.getElementById('eName').innerText = "å·²å‡»è´¥";
            killCount++; stageCount++;
            
            let gain = player.lvl + 1;
            player.exp += gain;
            while(player.exp >= player.maxExp) { player.lvl++; player.maxExp = player.lvl * 2; log("å‡çº§! ç­‰çº§ " + player.lvl, "#f1c40f"); floatText("LV UP!", document.getElementById('playerEl'), '#f1c40f', '32px');}
            
            let gold = gameLevel * 5 + Math.floor(Math.random()*10);
            if(enemy.type !== 'minion') gold *= 3;
            player.gold += gold;
            log(`è·å¾— ${gold} é‡‘å¸`, '#f1c40f');
            
            let dropRate = 0.01;
            if(enemy.type === 'elite') dropRate = 0.1;
            if(enemy.type === 'boss' || enemy.type === 'evil_dragon') dropRate = 1.0;
            
            if(Math.random() < dropRate) generateLoot(enemy.type);

            let healPct = 0.1;
            if (Object.values(player.equips).some(eq => eq && eq.quality === 'red')) healPct += 0.1;
            if (player.hasHealKill) healPct += 0.6; // fix heal kill
            
            player.hp = Math.min(player.maxHp, player.hp + player.maxHp * healPct);
            player.mp = Math.min(player.maxMp, player.mp + player.maxMp * healPct);
            
            saveGame();
            updateUI();
            
            if(enemy.type === 'boss' || enemy.type === 'evil_dragon') {
                isPendingRogue = true; 
                stageCount = 0;
            } else if (enemy.type === 'elite') {
                player.eliteKills = (player.eliteKills||0) + 1;
                isPendingRogue = true; 
                stageCount = 0;
            }

            battleLoopId = setTimeout(startNextBattle, 1500);

        } else if(player.hp <= 0) {
            clearAllTimers();
            player.hp = 0; isGameActive = false; updateUI();
            document.getElementById('goReason').innerText = `åœ¨ç¬¬ ${gameLevel} å±‚è¢« ${enemy.name} å‡»è´¥`;
            document.getElementById('reviveCount').innerText = "3";
            showLayer('over');
            let cd = 3;
            let timer = setInterval(()=>{ cd--; document.getElementById('reviveCount').innerText = cd; if(cd<=0) { clearInterval(timer); revivePlayer(); } }, 1000);
        }
    }

    function revivePlayer() {
        gameLevel = Math.max(1, gameLevel - 5);
        player.hp = player.maxHp; player.mp = player.maxMp;
        stageCount = 0;
        log("=== æ—¶å…‰å€’æµï¼Œé‡æ–°å¼€å§‹ ===", '#3498db');
        saveGame();
        showLayer('battle');
        if(battleLoopId) clearTimeout(battleLoopId);
        startNextBattle();
    }

    function showRogueSelection(first = false) {
        selectedRogueCard = null;
        const container = document.getElementById('rogueContainer');
        const btn = document.getElementById('confirmCardBtn');
        btn.disabled = true;
        btn.innerText = "è¯·é€‰æ‹©ä¸€é¡¹";
        container.innerHTML = '';
        
        let pool = CARDS.filter(c => {
            if (c.unique && player.uniqueCards && player.uniqueCards.includes(c.id)) return false;
            if (c.minLvl && gameLevel < c.minLvl) return false;
            return true;
        });
        
        if (lastBossType === 'boss') pool = pool.filter(c => c.type !== 'white');
        else if (lastBossType === 'evil_dragon') pool = pool.filter(c => c.type !== 'white' && c.type !== 'green');
        
        const shuffled = pool.sort(() => 0.5 - Math.random());
        const choices = shuffled.slice(0, 3);

        choices.forEach(card => {
            const el = document.createElement('div');
            el.className = `rogue-card card-${card.type}`;
            el.innerHTML = `
                <div class="card-icon">${card.icon || 'ğŸ'}</div>
                <h3>${card.title}</h3>
                <p>${card.desc || '...'}</p>
            `;
            el.onclick = () => {
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                selectedRogueCard = card;
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤é€‰æ‹©";
            };
            container.appendChild(el);
        });
        showLayer('card');
    }

    function confirmRogueSelection() {
        if (!selectedRogueCard) return;
        selectedRogueCard.effect(player);
        if (selectedRogueCard.unique) {
            if(!player.uniqueCards) player.uniqueCards = [];
            player.uniqueCards.push(selectedRogueCard.id);
        }
        log(`é€‰æ‹©äº† [${selectedRogueCard.title}]`, '#8e44ad');
        if(selectedRogueCard.type !== 'green' && !selectedRogueCard.unique) {
             player.hp = Math.min(player.maxHp, player.hp + player.maxHp * 0.3);
             player.mp = Math.min(player.maxMp, player.mp + player.maxMp * 0.3);
        }
        updateUI();
        showLayer('battle');
        startNextBattle();
    }

    function showAttrPanel() {
        if(!player) return;
        document.getElementById('attrName').innerText = player.name;
        document.getElementById('attrClass').innerText = player.cls.name;
        document.getElementById('attrLvl').innerText = player.lvl;
        document.getElementById('attrHp').innerText = Math.floor(player.hp) + "/" + player.maxHp;
        let displayMp = (Math.floor(player.mp * 10) / 10).toFixed(1);
        if(player.cls.id !== 'mech') displayMp = Math.floor(player.mp);
        document.getElementById('attrMp').innerText = displayMp + "/" + player.maxMp;
        document.getElementById('attrAtk').innerText = getPlayerStat('atk'); // V4 Stat
        document.getElementById('attrDef').innerText = getPlayerStat('def');
        document.getElementById('attrSpd').innerText = getPlayerStat('spd');
        document.getElementById('attrCrit').innerText = Math.floor(getPlayerStat('critRate') * 100) + "%";
        document.getElementById('attrCritDmg').innerText = Math.floor(getPlayerStat('critDmg') * 100) + "%";
        showLayer('attr');
    }

    function closeAttrPanel() { showLayer('battle'); }

    function startDamageTest() {
        isTestingDamage = true; isGameActive = true;
        testTotalDamage = 0; testTimer = 10;
        player.hp = player.maxHp; player.mp = player.maxMp;
        document.getElementById('eName').innerText = "è®­ç»ƒæœ¨æ¡©";
        enemy = { hp: 99999999, atk:enemy.atk, def:enemy.def, spd:enemy.spd, visual: SVGS.stake };
        document.getElementById('eVisual').innerHTML = enemy.visual;
        log("=== å¼€å§‹ä¼¤å®³æµ‹è¯• (10s) ===", '#3498db');
        
        if(player.cls.id === 'blood') bloodInterval = setInterval(() => { let dot=Math.floor(getPlayerStat('atk')*0.8+getPlayerStat('hp')*0.2); testTotalDamage+=dot; floatText("-"+dot,document.getElementById('enemyEl'),'#8e44ad'); }, 1000);
        if(player.cls.id === 'mech') mechInterval = setInterval(() => { 
             let cost=player.mp*0.02; if(player.mp>0){ player.mp-=cost; let dmg=Math.floor(getPlayerStat('atk')*0.25+player.mp*0.75); testTotalDamage+=dmg; floatText(dmg,document.getElementById('enemyEl'),'#fff'); }
        }, 200);

        testInterval = setInterval(() => {
            testTimer--;
            if (testTimer <= 0) { endDamageTest(); } 
            else { log(`æµ‹è¯•å‰©ä½™: ${testTimer}s`, '#bdc3c7'); }
        }, 1000);
        
        if(player.cls.id !== 'mech') battleLoopId = setTimeout(battleLoop, 800);
    }

    function endDamageTest() {
        clearAllTimers();
        isTestingDamage = false;
        let dps = (testTotalDamage / 10).toFixed(1);
        alert(`=== ä¼¤å®³æµ‹è¯•æŠ¥å‘Š ===\næ€»ä¼¤å®³: ${testTotalDamage}\nç§’ä¼¤(DPS): ${dps}`);
        log(`æ€»ä¼¤å®³: ${testTotalDamage}`, '#e67e22');
        player.hp = player.maxHp; player.mp = player.maxMp;
        startNextBattle(); 
    }
    
    function checkSave() {
         let has = false;
         for(let i=0; i<3; i++) if(localStorage.getItem(`bigCatQuest_slot_${i}`)) has=true;
         document.getElementById('continueBtn').disabled = !has;
    }
    function updateUI() {
        if(!player) return;
        document.getElementById('pHpBar').style.width = (player.hp/player.maxHp*100)+'%';
        document.getElementById('pMpBar').style.width = (player.mp/player.maxMp*100)+'%';
        document.getElementById('eHpBar').style.width = (enemy.hp/enemy.maxHp*100)+'%';
        document.getElementById('goldVal').innerText = player.gold;
        let displayMp = (Math.floor(player.mp * 10) / 10).toFixed(1);
        if(player.cls.id !== 'mech') displayMp = Math.floor(player.mp);
        document.getElementById('pMpVal').innerText = `MP: ${displayMp}`;
    }
    function goToMainMenu() { saveGame(); location.reload(); }

    // --- V4.0 Functions ---
    function generateLoot(type) {
        let oreChance = type === 'minion' ? 0.2 : (type === 'elite' ? 0.5 : 1.0);
        if(Math.random() < oreChance) { pushMaterial('ore', Math.floor(Math.random()*3)+1); log("è·å¾—é­”é“çŸ¿", "#7f8c8d"); }
        if(type === 'boss' && Math.random() < 0.5) { pushMaterial('stone', 1); log("è·å¾—è§£å°çŸ³", "#9b59b6"); }
        
        let q = 'white';
        let r = Math.random();
        if(type === 'minion' && r<0.01) q = 'green';
        if(type === 'elite') { if(r<0.25) q='green'; else if(r<0.3) q='blue'; }
        if(type === 'boss') { if(r<0.5) q='green'; else if(r<0.9) q='blue'; else q='purple'; }
        
        if(player.inventory.length < player.maxInventory) {
            let item = createItem(gameLevel, q);
            player.inventory.push(item);
            log(`è·å¾— [${QUALITIES[q].name}] ${item.name}`, QUALITIES[q].color);
        }
    }
    function pushMaterial(id, qty) {
        let f = player.inventory.find(i=>i.type==='material' && i.id===id);
        if(f) f.qty = (f.qty||0)+qty;
        else if(player.inventory.length < player.maxInventory) player.inventory.push({type:'material', ...MATERIALS[id], qty:qty});
    }
    function createItem(lvl, qKey) {
        let q = QUALITIES[qKey];
        let type = EQUIP_SLOTS[Math.floor(Math.random()*EQUIP_SLOTS.length)];
        let base = Math.floor(lvl * 0.5 * q.statMod) + 1;
        let item = { uid: Date.now()+Math.random(), name: type, type: type, quality: qKey, level: lvl, stats:{}, affixes:[] };
        if(type==='weapon') item.stats.atk = base * 2;
        if(type==='armor') { item.stats.def = base; item.stats.hp = base*10; }
        if(type==='helm') { item.stats.def = base; item.stats.mp = base*2; }
        // Simple generation for now
        return item;
    }
    
    // Inventory UI Logic (Simplified for stability)
    let bagPage = 0;
    function showInventory() { isGameActive=false; clearAllTimers(); showLayer('inventory'); renderBag(); }
    function renderBag() {
        document.getElementById('matOre').innerText = player.inventory.find(i=>i.id==='ore')?.qty || 0;
        document.getElementById('matStone').innerText = player.inventory.find(i=>i.id==='stone')?.qty || 0;
        let grid = document.getElementById('bagGrid'); grid.innerHTML = '';
        let start = bagPage * 16;
        for(let i=start; i<start+16; i++) {
            let d = document.createElement('div'); d.className = 'item-slot';
            if(player.inventory[i]) {
                let it = player.inventory[i];
                if(it.type === 'material') { d.classList.add('rare-material'); d.innerHTML = `<div class="item-icon">${it.id==='ore'?'ğŸª¨':'ğŸ”®'}</div><div class="item-count">${it.qty}</div>`; }
                else { d.classList.add('rare-'+it.quality); d.innerHTML = `<div class="item-icon">ğŸ“¦</div><div class="item-lvl">Lv${it.level}</div>`; }
                d.onclick = () => selectItem(i);
            }
            grid.appendChild(d);
        }
        document.getElementById('bagPageNum').innerText = bagPage + 1;
        renderEquips();
    }
    let selectedIdx = -1;
    function selectItem(idx) {
        selectedIdx = idx;
        let it = player.inventory[idx];
        document.getElementById('itemDetailBox').innerHTML = `<div class="item-title" style="color:${it.color||'#333'}">${it.name}</div>`;
        document.getElementById('btnEquip').disabled = (it.type === 'material');
    }
    function equipSelectedItem() {
        if(selectedIdx === -1) return;
        let item = player.inventory[selectedIdx];
        if(item.type === 'material') return;
        if(player.equips[item.type]) player.inventory.push(player.equips[item.type]);
        player.equips[item.type] = item;
        player.inventory.splice(selectedIdx, 1);
        selectedIdx = -1; renderBag(); saveGame();
    }
    function unequipItem(slot) {
        if(player.equips[slot]) {
            if(player.inventory.length < player.maxInventory) {
                player.inventory.push(player.equips[slot]);
                player.equips[slot] = null;
                renderBag();
            } else alert("èƒŒåŒ…æ»¡");
        }
    }
    function renderEquips() {
        EQUIP_SLOTS.forEach(slot => {
            let el = document.getElementById('visual-'+slot);
            if(player.equips[slot]) { el.innerText = 'ğŸ“¦'; el.parentElement.style.borderColor = 'gold'; }
            else { el.innerText = ''; el.parentElement.style.borderColor = '#bdc3c7'; }
        });
    }
    function changeBagPage(d) { bagPage = Math.max(0, Math.min(9, bagPage+d)); renderBag(); }
    function closeInventory() { isGameActive=true; showLayer('battle'); startNextBattle(); }
    function forgeExclusive() { alert("æš‚æœªå¼€æ”¾"); }
    function trySynthesize() { alert("æš‚æœªå¼€æ”¾"); }
    function upgradeExclusive() { alert("æš‚æœªå¼€æ”¾"); }
    function openShop() { showLayer('shop'); document.getElementById('shopContainer').innerHTML = 'å•†åº—ä¼‘æ¯ä¸­...'; }
    function leaveShop() { isGameActive=true; showLayer('battle'); startNextBattle(); }

    function renderChangelog() {
        document.getElementById('changelogBox').innerHTML = `
            <div class="log-block"><div class="log-ver">Ver 4.05</div><div class="log-date">èµç½ªä¿®å¤</div><ul class="log-list"><li>ç•Œé¢ç´ æå®Œå…¨å›æ»šè‡³Ver3.08æ ‡å‡†ã€‚</li><li>ä¿®å¤å­˜æ¡£è¯»å–é€»è¾‘ã€‚</li><li>ä¿ç•™V4.0æ•°æ®ç»“æ„ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.03</div><div class="log-date">ä¸“å±è§‰é†’</div><ul class="log-list"><li>ä¸“å±è£…å¤‡ç³»ç»Ÿä¸Šçº¿ï¼šåŠ¨æ€æˆé•¿ã€æ— é™å¼ºåŒ–ã€èŒä¸šç‰¹åŒ–ã€‚</li><li>é”»é€ åŠŸèƒ½å®è£…ï¼šæ¶ˆè€—çŸ¿çŸ³æ‰“é€ ç¥å™¨ã€‚</li><li>æˆ˜åç»­èˆªï¼šä¸“å±è£…å¤‡æä¾›10%åŒå›ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.02</div><div class="log-date">ææ–™è¡¥å®Œ</div><ul class="log-list"><li>å®è£…ææ–™ç³»ç»Ÿï¼šé­”é“çŸ¿ã€è§£å°çŸ³ã€‚</li><li>æ‰è½é€»è¾‘å‡çº§ï¼šæ”¯æŒå¤šé‡æ‰è½ï¼ˆé‡‘å¸+ææ–™+è£…å¤‡ï¼‰ã€‚</li><li>èƒŒåŒ…æ‰©å®¹ä¸åˆ†ç±»æ˜¾ç¤ºä¼˜åŒ–ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.01</div><div class="log-date">å¤§æ‰©å®¹</div><ul class="log-list"><li>èƒŒåŒ…ä¸Šé™æå‡è‡³160æ ¼ï¼ˆ10é¡µï¼‰ã€‚</li><li>æ–°å¢è£…å¤‡æ§½ï¼šæŠ¤è‚©ã€å·¦æˆ’ã€å³æˆ’ã€‚</li><li>å­˜æ¡£è‡ªåŠ¨è¿ç§»ç³»ç»Ÿä¸Šçº¿ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.00</div><div class="log-date">å¤§ç¾å˜</div><ul class="log-list"><li>å®è£…è£…å¤‡ç³»ç»Ÿï¼šèƒŒåŒ…ã€è£…å¤‡æ ã€éšæœºæ‰è½ã€‚</li><li>å®è£…ä¸“å±è£…å¤‡ï¼š6å¤§èŒä¸šä¸“å±ç¥å™¨ã€‚</li><li>å®è£…å•†åº—ä¸é‡‘å¸ç³»ç»Ÿã€‚</li><li>æˆ˜æ–—é€»è¾‘é‡æ„ï¼šå®Œç¾ä¿®å¤å¡æ­»BUGã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 3.10</div><div class="log-date">ç¨³å®šä¿®å¤</div><ul class="log-list"><li>ä¿®å¤ç²¾è‹±æ€ªå¡æ­»ã€‚</li><li>è‡ªåŠ¨å¤æ´»å®è£…ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 1.0~3.09</div><div class="log-date">å†å²ç‰ˆæœ¬</div><ul class="log-list"><li>åŸºç¡€ç©æ³•ã€èŒä¸šã€å¤©èµ‹ã€å¡ç‰Œè‚‰é¸½è¿­ä»£å®Œæˆã€‚</li></ul></div>
        `;
    }
</script>
</body>
</html>