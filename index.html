<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§çŒ«çŒ«æ–—æ¶é¾™ Ver4.04</title>
    <style>
        /* --- 1. å…¨å±€ä¸åŸºç¡€ (å®Œå…¨æ¢å¤ Ver3.08) --- */
        body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; touch-action: none; user-select: none; }
        #gameContainer { position: relative; width: 100%; height: 100%; max-width: 480px; max-height: 900px; background: #fff; box-shadow: 0 0 30px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; }
        
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.98); z-index: 10; padding: 20px; box-sizing: border-box; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .active { display: flex; }
        .layer-scroll { justify-content: flex-start; padding-top: 40px; padding-bottom: 60px; }

        h1 { color: #e67e22; text-shadow: 2px 2px #f1c40f; margin-bottom: 5px; text-align: center; flex-shrink: 0;}
        h2 { color: #2c3e50; margin-bottom: 20px; text-align: center; }
        .version { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; flex-shrink: 0;}
        input { padding: 12px; border: 2px solid #3498db; border-radius: 8px; width: 70%; text-align: center; font-size: 16px; margin-bottom: 20px; flex-shrink: 0;}
        
        button { padding: 10px 25px; background: #e67e22; color: white; border: none; border-radius: 20px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #d35400; transition: all 0.1s; margin: 5px; flex-shrink: 0;}
        button:active { transform: translateY(4px); box-shadow: 0 0 0 #d35400; }
        button:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; transform: none; color: #fff; }
        
        .btn-blue { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-blue:active { transform: translateY(4px); box-shadow: 0 0 0 #2980b9; }
        .btn-green { background: #2ecc71; box-shadow: 0 4px 0 #27ae60; width: 70%; }
        .btn-green:active { transform: translateY(4px); box-shadow: 0 0 0 #27ae60; }
        .btn-gray { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; font-size: 14px; padding: 8px 20px; width: 70%; }
        .btn-purple { background: #9b59b6; box-shadow: 0 4px 0 #8e44ad; } /* V4æ–°å¢ */

        .btn-home { position: absolute; top: 10px; left: 10px; width: 36px; height: 36px; border-radius: 50%; background: #fff; border: 2px solid #bdc3c7; color: #7f8c8d; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; padding: 0; margin: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- å­˜æ¡£æ§½ä½ (Strict Ver3.08) --- */
        .slot-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .save-slot { background: #fff; border: 2px solid #bdc3c7; border-radius: 10px; padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; position: relative; }
        .save-slot:hover { border-color: #3498db; transform: scale(1.01); }
        .save-slot.empty { border-style: dashed; background: #f9f9f9; color: #95a5a6; justify-content: center; }
        .slot-info { display: flex; flex-direction: column; align-items: flex-start; }
        .slot-title { font-weight: bold; color: #2c3e50; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .slot-detail { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .slot-icon { width: 30px; height: 30px; }
        .delete-btn { padding: 5px 10px; font-size: 12px; background: #e74c3c; border-radius: 5px; margin-left: 10px; z-index: 5; color: white; width: auto; box-shadow: none; margin: 5px; }

        /* --- æˆ˜æ–—ç•Œé¢ --- */
        #battleLayer { background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #90EE90 70%, #90EE90 100%); justify-content: space-between; padding: 0; overflow: hidden;}
        .cloud { position: absolute; background: white; border-radius: 50px; opacity: 0.8; animation: floatCloud 20s linear infinite; }
        @keyframes floatCloud { from { left: -100px; } to { left: 100%; } }
        .battle-hud { width: 100%; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; padding-left: 50px; box-sizing: border-box; display: flex; justify-content: space-between; font-size: 14px; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .battle-scene { flex-grow: 1; width: 100%; position: relative; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 25%; z-index: 2; }
        .fighter { width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; transition: transform 0.2s; }
        .fighter-svg { width: 100%; height: 100%; filter: drop-shadow(0 5px 2px rgba(0,0,0,0.2)); }
        .status-box { position: absolute; top: -40px; width: 100%; text-align: center; }
        .fighter-name { background: rgba(0,0,0,0.5); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 12px; display: inline-block; margin-bottom: 2px; }
        .bar-bg { width: 80px; height: 8px; background: #333; border-radius: 4px; margin: 1px auto; overflow: hidden; border:1px solid #fff;}
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.3s; }
        .mp-fill { height: 100%; background: #3498db; width: 100%; transition: width 0.3s; }

        .toolbar { position: absolute; bottom: 140px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 6; padding: 0 5px; flex-wrap: wrap; }
        .tool-btn { width: 40px; height: 40px; background: #fff; border: 2px solid #bdc3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.1s; }
        .tool-btn:active { transform: scale(0.9); }
        .tool-btn svg { width: 22px; height: 22px; }

        .bottom-panel { width: 100%; background: #fff; padding: 10px; box-sizing: border-box; border-top: 4px solid #f1c40f; z-index: 5; }
        .exp-container { width: 100%; height: 15px; background: #bdc3c7; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .exp-fill { height: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); width: 0%; transition: width 0.5s; }
        .exp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; font-size: 10px; line-height: 15px; color: #333; font-weight: bold; }

        .floating-text { position: absolute; font-weight: 900; font-size: 28px; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0 #fff; z-index: 20; white-space: nowrap; left: 50%; transform: translateX(-50%); top: -40px; pointer-events: none;}
        @keyframes floatUp { 0% { top: -40px; opacity: 1; transform: translateX(-50%) scale(1); } 100% { top: -90px; opacity: 0; transform: translateX(-50%) scale(1.2); } }
        .slash-effect { position: absolute; width: 150px; height: 150px; background: transparent; border: 2px solid transparent; z-index: 15; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .slash-effect::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 4px; background: #e74c3c; transform: rotate(-45deg); box-shadow: 0 0 10px #c0392b; animation: slashAnim 0.3s forwards; }
        @keyframes slashAnim { 0% { width: 0; opacity: 0; } 50% { width: 100%; opacity: 1; } 100% { width: 100%; opacity: 0; } }
        .log-box { width: 100%; height: 120px; background: #f8f9fa; overflow-y: auto; padding: 10px; box-sizing: border-box; font-size: 12px; border-top: 1px solid #ccc; }
        .log-entry { margin-bottom: 3px; border-bottom: 1px dashed #eee; padding-bottom: 2px; line-height: 1.4;}

        /* --- V4.0 æ–°å¢: èƒŒåŒ…ä¸å•†åº—æ ·å¼ --- */
        .equip-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; background: #ecf0f1; border-radius: 8px; margin-bottom: 10px; }
        .item-slot { width: 100%; padding-bottom: 100%; position: relative; background: #bdc3c7; border-radius: 5px; cursor: pointer; border: 2px solid #95a5a6; }
        .item-slot.active { border-color: #f1c40f; background: #fff; }
        .item-slot.rare-white { border-color: #bdc3c7; background: #f0f0f0; }
        .item-slot.rare-green { border-color: #2ecc71; background: #e8f8f5; }
        .item-slot.rare-blue { border-color: #3498db; background: #ebf5fb; }
        .item-slot.rare-purple { border-color: #9b59b6; background: #f4ecf7; }
        .item-slot.rare-orange { border-color: #e67e22; background: #fef5e7; }
        .item-slot.rare-red { border-color: #e74c3c; background: #fdedec; box-shadow: 0 0 5px #e74c3c; } 
        .item-slot.rare-material { border-color: #7f8c8d; background: #d5d8dc; } 
        .item-icon { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .item-lvl { position: absolute; bottom: 1px; right: 2px; font-size: 8px; color: #333; font-weight: bold; }
        .item-count { position: absolute; top: 1px; left: 2px; font-size: 8px; color: #2c3e50; font-weight: bold; }
        
        .equip-panel { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; padding: 5px;}
        .equip-slot { width: 45px; height: 45px; background: #ecf0f1; border: 2px dashed #bdc3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .equip-slot.filled { border-style: solid; background: #fff; }
        .slot-label { position: absolute; top: -14px; font-size: 9px; color: #7f8c8d; white-space: nowrap; }

        .item-detail { background: #fff; border: 2px solid #34495e; padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 10px; min-height: 80px; }
        .item-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .item-stats { color: #2c3e50; line-height: 1.4; }
        .item-desc { color: #7f8c8d; font-style: italic; margin-top: 5px; font-size: 10px; }
        .mat-display { display:flex; justify-content:space-around; background:#34495e; color:#fff; padding:5px; border-radius:5px; margin-bottom:5px; font-size:12px; }

        .shop-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #bdc3c7; margin-bottom: 5px; border-radius: 5px; }
        .currency { color: #f1c40f; font-weight: bold; text-shadow: 1px 1px 0 #d35400; margin-right: 10px; }

        /* å…¶ä»– */
        .scroll-box { width: 100%; flex-grow: 1; background: #f9f9f9; border: 2px solid #bdc3c7; border-radius: 10px; padding: 15px; box-sizing: border-box; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        .log-block { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .highlight { color: #c0392b; font-weight: bold; }
        #reviveCount { font-size: 80px; color: #e74c3c; font-weight: bold; text-shadow: 2px 2px 0 #fff; margin: 20px 0; }
        
        .card-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; padding-bottom: 20px; }
        .class-card, .rogue-card { background: white; border: 2px solid #bdc3c7; border-radius: 10px; padding: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
        .class-card:hover, .rogue-card:hover { border-color: #3498db; transform: scale(1.02); }
        .rogue-card.selected { border: 3px solid #f1c40f; background: #fcf8e3; transform: scale(1.05); }
        .card-white { border-top: 5px solid #bdc3c7; }
        .card-green { border-top: 5px solid #2ecc71; }
        .card-blue { border-top: 5px solid #3498db; }
        .card-purple { border-top: 5px solid #9b59b6; }
        .card-orange { border-top: 5px solid #e67e22; }
        .attr-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px; color: #34495e; }
        .attr-val { color: #2980b9; font-family: monospace; font-size: 16px; }

    </style>
</head>
<body>

<div id="gameContainer">
    <div id="startLayer" class="layer active layer-scroll">
        <h1>å¤§çŒ«çŒ«æ–—æ¶é¾™</h1>
        <div class="version">Ver4.04.12172505beta</div>
        <svg width="150" height="150" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="#f1c40f" stroke="#e67e22" stroke-width="3"/>
            <path d="M30 30 L40 10 L55 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <path d="M70 30 L60 10 L45 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <circle cx="35" cy="45" r="5" fill="#2c3e50"/>
            <circle cx="65" cy="45" r="5" fill="#2c3e50"/>
            <path d="M45 60 Q50 70 55 60" stroke="#c0392b" stroke-width="3" fill="none"/>
            <path d="M10 50 L90 50" stroke="#bdc3c7" stroke-width="5" opacity="0.5"/>
        </svg>
        <br>
        <button class="btn-green" onclick="openSlotMenu('load')" style="width:70%">è¯»å–å­˜æ¡£</button>
        <button class="btn-blue" onclick="openSlotMenu('new')" style="width:70%">æ–°æ¸¸æˆ</button>
        <button class="btn-gray" onclick="showLayer('changelog')" style="width:70%">æ›´æ–°æ—¥å¿—</button>
    </div>

    <div id="slotLayer" class="layer layer-scroll">
        <h2 id="slotTitle">é€‰æ‹©å­˜æ¡£</h2>
        <div id="slotList" class="slot-container"></div>
        <button onclick="showLayer('start')" style="margin-top:20px; background:#95a5a6;">è¿”å›</button>
    </div>

    <div id="nameInputLayer" class="layer">
        <h2>åˆ›å»ºè§’è‰²</h2>
        <input type="text" id="playerNameInput" placeholder="è¯·è¾“å…¥ä½ çš„å‹‡è€…å" maxlength="8">
        <button onclick="goToClassSelection()">ä¸‹ä¸€æ­¥</button>
        <button onclick="showLayer('start')" style="background:#95a5a6;">å–æ¶ˆ</button>
    </div>

    <div id="classLayer" class="layer layer-scroll">
        <h2>é€‰æ‹©èŒä¸š</h2>
        <div class="card-container" id="classContainer"></div>
        <button onclick="showLayer('nameInputLayer')" style="margin-top:20px; background:#95a5a6;">è¿”å›</button>
    </div>

    <div id="battleLayer" class="layer">
        <div class="cloud" style="top:20px; width:80px; height:30px; animation-duration:25s;"></div>
        <div class="cloud" style="top:60px; width:120px; height:40px; animation-duration:35s; animation-delay:-10s"></div>
        
        <button class="btn-home" onclick="goToMainMenu()" title="è¿”å›ä¸»èœå•">ğŸ </button>
        <div style="position:absolute; top:10px; right:10px; color:#f1c40f; font-weight:bold; text-shadow:1px 1px 0 #000;">
            ğŸ’° <span id="goldVal">0</span>
        </div>

        <div class="battle-hud">
            <div>ğŸ“ ç¬¬ <span id="levelText" style="color:#f1c40f; font-weight:bold">1</span> å±‚</div>
            <div>ğŸ’€ å‡»æ€: <span id="killText">0</span></div>
        </div>

        <div class="battle-scene">
            <div id="playerEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="pName">å‹‡è€…</div>
                    <div class="bar-bg"><div class="hp-fill" id="pHpBar"></div></div>
                    <div class="bar-bg" style="margin-top:1px; height:4px; border:none;"><div class="mp-fill" id="pMpBar"></div></div>
                    <div style="font-size:10px; color:#fff; text-shadow:1px 1px 0 #000;" id="pMpVal"></div>
                </div>
                <div id="pVisual" class="fighter-svg"></div>
            </div>
            <div id="enemyEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="eName">æ€ªç‰©</div>
                    <div class="bar-bg"><div class="hp-fill" id="eHpBar"></div></div>
                </div>
                <div id="eVisual" class="fighter-svg"></div>
            </div>
        </div>

        <div class="toolbar">
            <div class="tool-btn" onclick="showAttrPanel()" title="å±æ€§"><svg viewBox="0 0 24 24" fill="#34495e"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg></div>
            <div class="tool-btn" onclick="showInventory()" title="èƒŒåŒ…"><svg viewBox="0 0 24 24" fill="#e67e22"><path d="M12 2l-5.5 9h11z"/><path d="M10 12h4v4h-4z"/><path d="M4 14v8h16v-8l-2-3H6z"/></svg></div>
            <div class="tool-btn" onclick="startDamageTest()" title="æœ¨æ¡©" style="background:#c0392b; border-color:#c0392b;"><svg viewBox="0 0 24 24" fill="#fff"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4h2v4zm2-6H8V9h6v2z"/></svg></div>
            <div class="tool-btn" onclick="saveGame(true)" title="ä¿å­˜"><svg viewBox="0 0 24 24" fill="#2980b9"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg></div>
        </div>

        <div class="bottom-panel">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                <span>EXP</span><span>LV.<span id="pLvVal">1</span></span>
            </div>
            <div class="exp-container"><div class="exp-fill" id="expFill"></div><div class="exp-text" id="expText">0/2</div></div>
        </div>
        <div class="log-box" id="battleLog"><div class="log-entry">æ¬¢è¿æ¥åˆ°å¤§çŒ«çŒ«çš„ä¸–ç•Œ...</div></div>
    </div>

    <div id="cardLayer" class="layer layer-scroll">
        <h2 style="color:#8e44ad">ğŸ å‘½è¿çš„é¦ˆèµ </h2>
        <div id="rogueContainer"></div>
        <button id="confirmCardBtn" onclick="confirmRogueSelection()" disabled style="width:80%; margin-top:20px;">ç¡®è®¤é€‰æ‹©</button>
    </div>

    <div id="gameOverLayer" class="layer">
        <h1 style="color: #c0392b;">ğŸ’” èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹</h1>
        <p id="goReason" style="font-size:18px;">...</p>
        <div id="reviveCount">3</div>
        <p style="color:#7f8c8d; font-size:14px;">å¤§çŒ«çŒ«æ–½å±•æ—¶é—´å›æº¯é­”æ³•ï¼<br>å³å°†å¤æ´»...</p>
    </div>

    <div id="attrLayer" class="layer layer-scroll">
        <h2>è§’è‰²å±æ€§</h2>
        <div class="scroll-box" style="margin-bottom:20px;" id="attrContent"></div>
        <button onclick="closeAttrPanel()">è¿”å›</button>
    </div>

    <div id="inventoryLayer" class="layer">
        <h2>ğŸ’ èƒŒåŒ… & è£…å¤‡</h2>
        <div class="mat-display">
            <span>ğŸª¨ é­”é“çŸ¿: <span id="matOre">0</span></span>
            <span>ğŸ”® è§£å°çŸ³: <span id="matStone">0</span></span>
        </div>
        <div class="equip-panel">
            <div class="equip-slot" id="slot-weapon" onclick="unequipItem('weapon')"><div class="slot-label">æ­¦å™¨</div><div id="visual-weapon"></div></div>
            <div class="equip-slot" id="slot-offhand" onclick="unequipItem('offhand')"><div class="slot-label">å‰¯æ‰‹</div><div id="visual-offhand"></div></div>
            <div class="equip-slot" id="slot-helm" onclick="unequipItem('helm')"><div class="slot-label">å¤´ç›”</div><div id="visual-helm"></div></div>
            <div class="equip-slot" id="slot-shoulders" onclick="unequipItem('shoulders')"><div class="slot-label">æŠ¤è‚©</div><div id="visual-shoulders"></div></div>
            <div class="equip-slot" id="slot-armor" onclick="unequipItem('armor')"><div class="slot-label">ç›”ç”²</div><div id="visual-armor"></div></div>
            <div class="equip-slot" id="slot-belt" onclick="unequipItem('belt')"><div class="slot-label">è…°å¸¦</div><div id="visual-belt"></div></div>
            <div class="equip-slot" id="slot-boots" onclick="unequipItem('boots')"><div class="slot-label">é‹å­</div><div id="visual-boots"></div></div>
            <div class="equip-slot" id="slot-accessory" onclick="unequipItem('accessory')"><div class="slot-label">é¥°å“</div><div id="visual-accessory"></div></div>
            <div class="equip-slot" id="slot-ringL" onclick="unequipItem('ringL')"><div class="slot-label">å·¦æˆ’</div><div id="visual-ringL"></div></div>
            <div class="equip-slot" id="slot-ringR" onclick="unequipItem('ringR')"><div class="slot-label">å³æˆ’</div><div id="visual-ringR"></div></div>
        </div>
        <div class="item-detail" id="itemDetailBox">ç‚¹å‡»ç‰©å“æŸ¥çœ‹è¯¦æƒ…</div>
        <div class="equip-grid" id="bagGrid"></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-gray" onclick="changeBagPage(-1)">â—€</button>
            <span style="line-height:40px;">é¡µ <span id="bagPageNum">1</span> / 10</span>
            <button class="btn-gray" onclick="changeBagPage(1)">â–¶</button>
        </div>
        <div style="margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center;">
            <button class="btn-green" id="btnEquip" onclick="equipSelectedItem()" disabled>è£…å¤‡</button>
            <button class="btn-purple" id="btnUpgrade" onclick="upgradeExclusive()" style="display:none;">è§£å°</button>
            <button class="btn-purple" onclick="forgeExclusive()">é”»é€ ä¸“å±</button>
            <button class="btn-blue" onclick="trySynthesize()">ä¸€é”®åˆæˆ</button>
            <button class="btn-gray" onclick="closeInventory()">å…³é—­</button>
        </div>
    </div>

    <div id="shopLayer" class="layer">
        <h2 style="color:#f39c12">ğŸ›’ æµæµªçŒ«å•†äºº</h2>
        <p>ç¬¬ <span id="shopLevel"></span> å±‚è¡¥ç»™ç‚¹</p>
        <div class="scroll-box" id="shopContainer" style="height:300px;"></div>
        <button onclick="leaveShop()">ç¦»å¼€å•†åº—</button>
    </div>
    
    <div id="changelogLayer" class="layer layer-scroll">
        <h2>ç¼–å¹´å²</h2>
        <div class="scroll-box" id="changelogBox"></div>
        <button onclick="showLayer('start')">è¿”å›</button>
    </div>

</div>

<script>
    // --- å¸¸é‡å®šä¹‰ (ä¿æŒ V4.03) ---
    const SVGS = {
        cat_resolute: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><rect x="30" y="15" width="20" height="25" rx="5" fill="none" stroke="#2c3e50" stroke-width="2"/><line x1="40" y1="15" x2="40" y2="40" stroke="#2c3e50" stroke-width="1"/><line x1="30" y1="27" x2="50" y2="27" stroke="#2c3e50" stroke-width="1"/><path d="M65 40 L90 10" stroke="#95a5a6" stroke-width="6"/><path d="M65 40 L90 10" stroke="#2c3e50" stroke-width="2"/><line x1="60" y1="45" x2="70" y2="35" stroke="#f1c40f" stroke-width="4"/></g></svg>`,
        cat_agile: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M70 40 L85 25" stroke="#3498db" stroke-width="4"/><path d="M10 40 L-5 25" stroke="#3498db" stroke-width="4"/></g></svg>`,
        cat_wise: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><line x1="75" y1="20" x2="75" y2="80" stroke="#8e44ad" stroke-width="4"/><circle cx="75" cy="20" r="8" fill="#e74c3c"/></g></svg>`,
        cat_berserk: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="30" x2="35" y2="38" stroke="#000" stroke-width="2"/><line x1="55" y1="30" x2="45" y2="38" stroke="#000" stroke-width="2"/><path d="M35 50 Q40 45 45 50" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M80 40 L80 70 M70 40 L90 40 L80 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/><path d="M0 40 L0 70 M-10 40 L10 40 L0 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/></g></svg>`,
        cat_blood: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M25 35 Q30 25 35 35" stroke="#e74c3c" stroke-width="3" fill="none"/><path d="M45 35 Q50 25 55 35" stroke="#e74c3c" stroke-width="3" fill="none"/><circle cx="30" cy="38" r="2" fill="#e74c3c"/><circle cx="50" cy="38" r="2" fill="#e74c3c"/><path d="M70 50 Q80 20 50 10" stroke="#c0392b" stroke-width="4" fill="none"/><line x1="70" y1="50" x2="80" y2="80" stroke="#95a5a6" stroke-width="3"/></g></svg>`,
        cat_mech: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><path d="M15 20 L65 20 L75 35 L75 70 L50 80 L25 70 L5 70 L5 35 Z" fill="#7f8c8d" stroke="#34495e" stroke-width="2"/><rect x="15" y="35" width="50" height="10" fill="#3498db"/><line x1="10" y1="20" x2="5" y2="0" stroke="#34495e" stroke-width="3"/><line x1="70" y1="20" x2="75" y2="0" stroke="#34495e" stroke-width="3"/><rect x="75" y="50" width="20" height="10" fill="#2c3e50"/><circle cx="95" cy="55" r="3" fill="#e74c3c"/></g></svg>`,
        monster_slime: `<svg viewBox="0 0 100 100"><path d="M20 80 Q20 20 50 20 Q80 20 80 80 Z" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/><circle cx="40" cy="50" r="5" fill="#000"/><circle cx="60" cy="50" r="5" fill="#000"/></svg>`,
        monster_bat: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="15" fill="#34495e"/><path d="M35 50 Q10 20 10 50 Q20 70 35 55" fill="#34495e"/><path d="M65 50 Q90 20 90 50 Q80 70 65 55" fill="#34495e"/><circle cx="45" cy="50" r="2" fill="#e74c3c"/><circle cx="55" cy="50" r="2" fill="#e74c3c"/></svg>`,
        monster_dragon: `<svg viewBox="0 0 100 100"><path d="M30 60 Q30 30 50 20 Q70 30 70 60" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/><path d="M50 20 L50 5" stroke="#e74c3c" stroke-width="4"/><circle cx="40" cy="45" r="4" fill="#f1c40f"/><circle cx="60" cy="45" r="4" fill="#f1c40f"/><path d="M40 70 Q50 80 60 70" stroke="#000" stroke-width="2" fill="none"/></svg>`,
        monster_evil_dragon: `<svg viewBox="0 0 100 100"><path d="M20 70 Q40 20 80 30 Q90 50 70 80 Q50 90 20 70 Z" fill="#2c3e50" stroke="#000" stroke-width="2"/><path d="M80 30 Q95 10 90 5 Q70 15 60 35" fill="#c0392b"/><path d="M30 40 Q40 50 30 60" stroke="#c0392b" stroke-width="3" fill="none"/><circle cx="65" cy="45" r="3" fill="#e74c3c"/><circle cx="75" cy="55" r="3" fill="#e74c3c"/><path d="M10 60 Q20 40 10 20" stroke="#2c3e50" stroke-width="4" fill="none"/></svg>`,
        stake: `<svg viewBox="0 0 100 100"><rect x="35" y="20" width="30" height="70" fill="#d35400" stroke="#5d4037" stroke-width="2"/><circle cx="50" cy="40" r="8" fill="#fff" opacity="0.8"/><circle cx="50" cy="40" r="3" fill="#000"/><path d="M35 20 L50 5 L65 20 Z" fill="#d35400" stroke="#5d4037" stroke-width="2"/></svg>`
    };

    const CLASSES = [
        { id: 'resolute', name: 'åšæ¯…çŒ«', svg: SVGS.cat_resolute, base: {atk:32, mp:5, def:25, hp:200, spd:10}, growth: {atk:3, mp:1, def:15, hp:50, spd:1}, talent:'ã€è†æ£˜ã€‘é«˜é˜²åä¼¤(â‰¥2å€/5å€)' },
        { id: 'agile', name: 'çµæ´»çŒ«', svg: SVGS.cat_agile, base: {atk:40, mp:8, def:10, hp:80, spd:20}, growth: {atk:10, mp:2, def:3, hp:20, spd:4}, talent:'ã€è¿…æ·ã€‘è¿½åŠ çœŸå®ä¼¤å®³' },
        { id: 'wise', name: 'æ™ºæ…§çŒ«', svg: SVGS.cat_wise, base: {atk:45, mp:20, def:10, hp:70, spd:10}, growth: {atk:15, mp:10, def:3, hp:18, spd:2}, talent:'ã€å¥¥æœ¯ã€‘è€—è“å¢ä¼¤/æŠµæŒ¡' },
        { id: 'berserk', name: 'ç‹‚æš´çŒ«', svg: SVGS.cat_berserk, base: {atk:50, mp:6, def:8, hp:100, spd:15}, growth: {atk:20, mp:1, def:3, hp:25, spd:2}, talent:'ã€è¡€æ€’ã€‘è€—è¡€å¢ä¼¤å¸è¡€' },
        { id: 'blood', name: 'è¡€éª‘çŒ«', svg: SVGS.cat_blood, base: {atk:25, mp:6, def:12, hp:200, spd:10}, growth: {atk:12, mp:1, def:3, hp:50, spd:1}, talent:'ã€é­”è¡€ã€‘æ¯ç§’çœŸå®ç¼çƒ§' },
        { id: 'mech', name: 'æœºæ¢°çŒ«', svg: SVGS.cat_mech, base: {atk:30, mp:12, def:25, hp:120, spd:0}, growth: {atk:15, mp:4, def:3, hp:20, spd:0}, talent:'ã€ç«ç®­ã€‘è€—è“å¼¹å¹•è½°ç‚¸' }
    ];

    const CARDS = [
        { type: 'white', title: 'åŠ›é‡', effect: p=>p.atk+=10 }, { type: 'white', title: 'ç”Ÿå‘½', effect: p=>{p.maxHp+=60;p.hp+=60;} },
        { type: 'white', title: 'é˜²å¾¡', effect: p=>p.def+=10 }, { type: 'white', title: 'é€Ÿåº¦', effect: p=>p.spd+=5 },
        { type: 'white', title: 'é­”åŠ›', effect: p=>{p.mp+=5;p.maxMp+=5;} },
        { type: 'green', title: 'æš´å‡»', effect: p=>p.critRate+=0.05 }, { type: 'green', title: 'çˆ†ä¼¤', effect: p=>p.critDmg+=0.1 },
        { type: 'green', title: 'å¤§ç”Ÿå‘½', effect: p=>{p.maxHp+=200;p.hp+=200;} }, { type: 'green', title: 'å¤§é˜²å¾¡', effect: p=>p.def+=40 },
        { type: 'blue', minLvl:100, title: 'æ³°å¦', effect: p=>{p.maxHp+=500;p.hp+=500;} }, { type: 'blue', minLvl:100, title: 'å…‰é€Ÿ', effect: p=>p.spd+=20 },
        { type: 'blue', unique:true, id:'heal_kill', title: 'ä»¥æˆ˜å…»æˆ˜', effect: p=>p.hasHealKill=true },
        { type: 'blue', unique:true, id:'low_hp_spd', title: 'èƒŒæ°´ä¸€æˆ˜', effect: p=>p.hasLowHpSpd=true }
    ];

    // [Ver4.0] æ•°æ®å­—å…¸
    const EQUIP_SLOTS = ['weapon', 'offhand', 'helm', 'shoulders', 'armor', 'belt', 'boots', 'accessory', 'ringL', 'ringR'];
    const QUALITIES = {
        white: { name:'ç ´æ—§', color:'#95a5a6', statMod:1.0, affixes:0 },
        green: { name:'ç²¾è‰¯', color:'#2ecc71', statMod:1.1, affixes:1 },
        blue: { name:'ç¨€æœ‰', color:'#3498db', statMod:1.2, affixes:2 },
        purple: { name:'å²è¯—', color:'#9b59b6', statMod:1.35, affixes:3 },
        orange: { name:'ä¼ è¯´', color:'#e67e22', statMod:1.5, affixes:4 },
        red: { name:'ä¸“å±', color:'#e74c3c', statMod:2.0, affixes:5 }
    };
    const AFFIX_POOL = [
        { id:'atk', text:'çŒ«å¨+', w:10 }, { id:'def', text:'çŒ«å¾¡+', w:10 }, { id:'hp', text:'çŒ«è¡€+', w:10 },
        { id:'spd', text:'çŒ«é€Ÿ+', w:5 }, { id:'mp', text:'çŒ«èƒ½+', w:5 },
        { id:'crit', text:'æš´å‡»+', w:3, val:0.01 }, { id:'critDmg', text:'çˆ†ä¼¤+', w:3, val:0.05 },
        { id:'regenHp', text:'å›è¡€+', w:3 }, { id:'regenMp', text:'å›è“+', w:3 }
    ];
    const MATERIALS = {
        ore: { id:'ore', name:'é­”é“çŸ¿', color:'#7f8c8d', desc:'ç”¨äºé“¸é€ è£…å¤‡' },
        stone: { id:'stone', name:'è§£å°çŸ³', color:'#9b59b6', desc:'ç”¨äºæå‡ä¸“å±è£…å¤‡é˜¶æ®µ' }
    };
    const EXCLUSIVE_STATS = {
        resolute: { atk:0.5, def:3.5, hp:2.0, spd:0.2, mp:0.1 }, 
        agile:    { atk:1.5, def:0.5, hp:1.0, spd:2.0, mp:0.5 },
        wise:     { atk:2.0, def:0.5, hp:1.0, spd:0.5, mp:3.0 },
        berserk:  { atk:1.5, def:0.5, hp:5.0, spd:1.0, mp:0.1 },
        blood:    { atk:1.0, def:1.5, hp:3.0, spd:0.5, mp:0.5 },
        mech:     { atk:1.2, def:1.2, hp:1.5, spd:0,   mp:2.5 }
    };
    const EXCLUSIVE_GEAR = {
        resolute: { id:'exclusive_resolute', slot:'offhand', name:'åšæ¯…çŒ«ã®å¹æ¯', desc:'é«˜é˜²åä¼¤å€ç‡+50%, 7å€é˜²è§¦å‘æ ¸çˆ†åä¼¤' },
        agile: { id:'exclusive_agile', slot:'boots', name:'çµæ´»çŒ«ã®æ­¥ä¼', desc:'å¤©èµ‹çœŸå®ä¼¤å®³å¯æš´å‡»' },
        wise: { id:'exclusive_wise', slot:'accessory', name:'æ™ºæ…§çŒ«ã®ä½è¯­', desc:'å‡çº§æˆé•¿å¤§å¹…æå‡, è€—è“å¢ä¼¤ç³»æ•°1.0%->1.2%' },
        berserk: { id:'exclusive_berserk', slot:'belt', name:'ç‹‚æš´çŒ«ã®æ‹¥æŠ±', desc:'æ¯è€—1è¡€è¿½åŠ 1ä¼¤å®³(å¯æš´å‡»)' },
        blood: { id:'exclusive_blood', slot:'offhand', name:'è¡€éª‘çŒ«ã®å®ˆæœ›', desc:'ç¼çƒ§å…¬å¼åŠ å…¥çŒ«å¾¡åŠ æˆ' },
        mech: { id:'exclusive_mech', slot:'helm', name:'æœºæ¢°çŒ«ã®å‡è§†', desc:'è½°ç‚¸é¢‘ç‡ 0.2s -> 0.15s' }
    };

    // --- å…¨å±€å˜é‡ ---
    let player = null;
    let enemy = null;
    let gameLevel = 1;
    let killCount = 0;
    let stageCount = 0; 
    let stageType = 'minion'; 
    let isPlayerTurn = true;
    let isPendingRogue = false;
    let selectedRogueCard = null;
    let isGameActive = false;
    let currentSlotId = null; 
    
    // å®šæ—¶å™¨
    let bloodInterval = null;
    let mechInterval = null;
    let battleLoopId = null; 
    let testInterval = null;

    // UI æ˜ å°„
    const layers = {
        start: document.getElementById('startLayer'),
        slot: document.getElementById('slotLayer'),
        name: document.getElementById('nameInputLayer'),
        select: document.getElementById('classLayer'),
        battle: document.getElementById('battleLayer'),
        card: document.getElementById('cardLayer'),
        over: document.getElementById('gameOverLayer'),
        changelog: document.getElementById('changelogLayer'),
        attr: document.getElementById('attrLayer'),
        inventory: document.getElementById('inventoryLayer'),
        shop: document.getElementById('shopLayer')
    };

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        checkSave();
        renderChangelog();
    };

    function showLayer(name) {
        Object.values(layers).forEach(l => l.classList.remove('active'));
        if(layers[name]) layers[name].classList.add('active');
    }

    // --- å­˜æ¡£ç³»ç»Ÿ ---
    function migrateSaveData(p) {
        // V4.0å…¼å®¹
        if(!p.gold) p.gold = 0;
        if(!p.inventory) p.inventory = [];
        if(!p.equips) p.equips = { weapon:null, offhand:null, helm:null, shoulders:null, armor:null, belt:null, boots:null, accessory:null, ringL:null, ringR:null };
        // ç¡®ä¿å­—æ®µè¡¥å…¨
        if(!p.equips.shoulders) p.equips.shoulders = null;
        if(!p.equips.ringL) p.equips.ringL = null;
        if(!p.equips.ringR) p.equips.ringR = null;
        p.maxInventory = 160; 
        return p;
    }

    function saveGame() {
        if (!player || currentSlotId === null) return;
        const data = {
            player: player,
            clsId: player.cls.id,
            gameLevel: gameLevel,
            killCount: killCount,
            stageCount: stageCount,
            stageType: stageType,
            timestamp: new Date().toLocaleString()
        };
        localStorage.setItem(`bigCatQuest_slot_${currentSlotId}`, JSON.stringify(data));
    }

    function loadGameFromSlot(data) {
        try {
            player = migrateSaveData(data.player);
            player.cls = CLASSES.find(c => c.id === data.clsId);
            gameLevel = data.gameLevel;
            killCount = data.killCount;
            stageCount = data.stageCount;
            stageType = data.stageType;
            
            if(player.critRate === undefined) player.critRate = 0;
            if(player.critDmg === undefined) player.critDmg = 1.5;
            
            updateUI();
            showLayer('battle');
            startNextBattle();
        } catch(e) {
            console.error(e);
            alert("å­˜æ¡£æ•°æ®å¼‚å¸¸ï¼Œå¯èƒ½éœ€è¦é‡ç½®ã€‚");
        }
    }

    function openSlotMenu(mode) {
        const container = document.getElementById('slotList');
        container.innerHTML = '';
        for(let i=0; i<3; i++) {
            const saveStr = localStorage.getItem(`bigCatQuest_slot_${i}`);
            const el = document.createElement('div');
            el.className = 'save-slot';
            
            if(saveStr) {
                // è¯»å–å­˜æ¡£é¢„è§ˆ (Ver3.08 logic)
                try {
                    const d = JSON.parse(saveStr);
                    const cls = CLASSES.find(c => c.id === d.clsId);
                    const icon = cls ? cls.svg : 'â“';
                    const name = cls ? cls.name : 'æœªçŸ¥';
                    el.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="slot-icon">${icon}</div>
                            <div class="slot-info">
                                <div class="slot-title">${name} <span style="font-size:12px; color:#27ae60">Lv.${d.player.lvl}</span></div>
                                <div class="slot-detail">ç¬¬ ${d.gameLevel} å±‚ | ${d.timestamp.split(' ')[0]}</div>
                            </div>
                        </div>
                    `;
                    const del = document.createElement('div');
                    del.innerHTML = 'ğŸ—‘ï¸'; del.className = 'delete-btn';
                    del.onclick = (e) => { e.stopPropagation(); if(confirm("åˆ é™¤?")) { localStorage.removeItem(`bigCatQuest_slot_${i}`); openSlotMenu(mode); } };
                    el.appendChild(del);
                    
                    el.onclick = () => {
                        currentSlotId = i;
                        if(mode==='load') loadGameFromSlot(d); 
                        else if(confirm("è¦†ç›–?")) showLayer('nameInputLayer');
                    };
                } catch(e) {
                    el.innerHTML = '<div>å­˜æ¡£æŸå</div>';
                    el.onclick = () => { if(confirm("è¦†ç›–æŸåå­˜æ¡£?")) { currentSlotId = i; showLayer('nameInputLayer'); } };
                }
            } else {
                el.innerHTML = '<div>+ ç©ºæ§½ä½</div>'; el.className += ' empty';
                el.onclick = () => { currentSlotId = i; showLayer('nameInputLayer'); };
            }
            container.appendChild(el);
        }
        showLayer('slot');
    }

    // --- æ ¸å¿ƒæµç¨‹ ---
    function goToClassSelection() {
        const name = document.getElementById('playerNameInput').value.trim();
        if (!name) { alert("å¤§ä¾ è¯·ç•™åï¼"); return; }
        const container = document.getElementById('classContainer');
        container.innerHTML = '';
        CLASSES.forEach(cls => {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.innerHTML = `<div class="svg-icon">${cls.svg}</div><h3 style="color:${cls.color || '#333'}">${cls.name}</h3><div class="stats-text">HP:${cls.base.hp} MP:${cls.base.mp}</div><div class="talent-text">${cls.talent}</div>`;
            card.onclick = () => initGame(name, cls);
            container.appendChild(card);
        });
        showLayer('select');
    }

    function initGame(name, cls) {
        player = {
            name: name, cls: cls, lvl: 1, exp: 0, maxExp: 2,
            maxHp: cls.base.hp, hp: cls.base.hp, maxMp: cls.base.mp, mp: cls.base.mp,
            atk: cls.base.atk, def: cls.base.def, spd: cls.base.spd,
            critRate: 0, critDmg: 1.5,
            uniqueCards: [], hasHealKill: false, hasLowHpSpd: false,
            // V4.0 åˆå§‹åŒ–
            gold: 0, inventory: [], maxInventory: 160,
            equips: { weapon:null, offhand:null, helm:null, shoulders:null, armor:null, belt:null, boots:null, accessory:null, ringL:null, ringR:null }
        };
        gameLevel = 1; killCount = 0; stageCount = 0; stageType = 'minion';
        saveGame();
        showLayer('battle');
        startNextBattle();
    }

    function startNextBattle() {
        isGameActive = true;
        clearAllTimers();

        // å•†åº—é€»è¾‘ (æ¯8å±‚)
        if (gameLevel > 1 && gameLevel % 8 === 0 && stageCount === 0 && !isPendingRogue) {
            isGameActive = false;
            openShop();
            return;
        }

        if (isPendingRogue) {
            isPendingRogue = false;
            showRogueSelection();
            return;
        }

        player.shieldUsed = false;
        generateEnemy();
        updateUI();
        
        let titleColor = '#3498db';
        if (stageType === 'evil_dragon') titleColor = '#c0392b';
        log(`<br><strong style="color:${titleColor}">=== ç¬¬ ${gameLevel} å±‚ ===</strong>`);
        
        // èŒä¸šè¢«åŠ¨
        if (player.cls.id === 'blood') {
            bloodInterval = setInterval(() => {
                if(!isGameActive) return;
                let dot = Math.floor(getPlayerStat('atk') * 0.8 + getPlayerStat('hp') * 0.2);
                if (hasEquip('exclusive_blood')) { 
                    dot = Math.floor(getPlayerStat('atk') * 1.0 + getPlayerStat('hp') * 0.25 + getPlayerStat('def') * 0.8);
                }
                enemy.hp -= dot;
                floatText(`-${dot}`, document.getElementById('enemyEl'), '#8e44ad', '20px');
                updateUI();
                if(enemy.hp <= 0) checkResult();
            }, 1000);
        }
        if (player.cls.id === 'mech') {
            let freq = hasEquip('exclusive_mech') ? 150 : 200; 
            mechInterval = setInterval(() => {
                if(!isGameActive) return;
                let cost = player.mp * 0.02; 
                if (player.mp > 0) {
                    player.mp = Math.max(0, player.mp - cost);
                    let dmgBase = getPlayerStat('atk') * 0.25 + player.mp * 0.75;
                    let isCrit = Math.random() < getPlayerStat('critRate');
                    let dmg = Math.floor(dmgBase * (isCrit ? getPlayerStat('critDmg') : 1));
                    enemy.hp -= Math.max(1, dmg);
                    floatText(dmg, document.getElementById('enemyEl'), isCrit?'#e74c3c':'#fff', '16px');
                    updateUI();
                    if(enemy.hp <= 0) checkResult();
                }
            }, freq);
        }

        if (player.cls.id !== 'mech') {
            battleLoopId = setTimeout(battleLoop, 800);
        }
    }

    // --- æˆ˜æ–—é€»è¾‘ ---
    function getPlayerStat(key) {
        let val = player[key];
        if (key === 'hp') val = player.maxHp;
        
        for(let k in player.equips) {
            let eq = player.equips[k];
            if(eq) {
                if(eq.quality === 'red') {
                    val += getDynamicStat(eq, key);
                } else {
                    if(eq.stats && eq.stats[key]) val += eq.stats[key];
                }
                if(eq.affixes) {
                    eq.affixes.forEach(aff => {
                        if(aff.id === key) val += aff.val;
                    });
                }
            }
        }
        return val;
    }
    
    function getDynamicStat(item, statKey) {
        if(!item || item.quality !== 'red') return 0;
        let coef = EXCLUSIVE_STATS[player.cls.id][statKey] || 0;
        let base = Math.floor(gameLevel * coef);
        let bonus = Math.floor(base * 0.1 * (item.upgradeLevel || 0));
        return base + bonus;
    }

    function hasEquip(id) {
        for(let k in player.equips) {
            if(player.equips[k] && player.equips[k].uid === id) return true;
        }
        return false;
    }

    function generateEnemy() {
        if (gameLevel % 100 === 0) { stageType = 'evil_dragon'; }
        else if (stageCount >= 5) {
            if ((player.eliteKills||0 + 1) % 5 === 0) stageType = 'boss'; else stageType = 'elite';
        } else { stageType = 'minion'; }
        
        let hpMult = 1, atkMult = 1, svg = SVGS.monster_slime, name = 'å°æ€ª';
        if (stageType === 'elite') { hpMult=2.5; atkMult=1.3; svg=SVGS.monster_bat; name='ç²¾è‹±'; }
        if (stageType === 'boss') { hpMult=5.5; atkMult=1.5; svg=SVGS.monster_dragon; name='é­”ç‹'; }
        if (stageType === 'evil_dragon') { hpMult=7.0; atkMult=1.7; svg=SVGS.monster_evil_dragon; name='é‚ªé¾™'; }
        
        let baseHp = 80 + (gameLevel * 25);
        let baseAtk = 15 + (gameLevel * 4);
        let baseDef = 5 + (gameLevel * 1);
        
        enemy = {
            name: name, type: stageType, visual: svg,
            maxHp: Math.floor(baseHp * hpMult), hp: Math.floor(baseHp * hpMult),
            atk: Math.floor(baseAtk * atkMult), def: Math.floor(baseDef * 1.2), spd: 10 + gameLevel
        };
        document.getElementById('eName').innerText = name;
        document.getElementById('eVisual').innerHTML = svg;
    }

    function battleLoop() {
        if(!isGameActive) return;
        if(enemy.hp <= 0) { checkResult(); return; }
        if(player.hp <= 0) { checkResult(); return; }
        
        let pSpd = getPlayerStat('spd');
        if(player.hasLowHpSpd) pSpd *= (1 + (player.maxHp - player.hp)/player.maxHp * 0.6);
        
        if (pSpd >= enemy.spd) {
            performPlayerAttack();
            if(enemy.hp > 0 && pSpd >= enemy.spd * 2 && Math.random()>0.4) {
                 setTimeout(performPlayerAttack, 400); 
            } else {
                 setTimeout(performEnemyAttack, 800);
            }
        } else {
            performEnemyAttack();
            if(player.hp > 0) setTimeout(performPlayerAttack, 800);
        }
    }

    function performPlayerAttack() {
        if(enemy.hp <= 0) return;
        let atk = getPlayerStat('atk');
        let crit = getPlayerStat('critRate');
        let cdmg = getPlayerStat('critDmg');
        
        if(player.cls.id === 'wise') {
             let cost = Math.floor(player.mp * 0.1);
             let bonus = hasEquip('exclusive_wise') ? 0.012 : 0.01;
             atk *= (1 + cost * bonus);
             player.mp -= cost;
        }
        if(player.cls.id === 'berserk') {
             let cost = Math.floor(player.hp * 0.2);
             player.hp -= cost; 
             atk *= (1 + (player.maxHp-player.hp)/player.maxHp);
             if(hasEquip('exclusive_berserk')) {
                 let extra = cost; 
                 enemy.hp -= Math.max(1, extra - enemy.def); 
                 floatText("+" + extra, document.getElementById('enemyEl'), '#c0392b');
             }
        }
        
        let isCrit = Math.random() < crit;
        let dmg = Math.max(1, Math.floor(atk * (isCrit ? cdmg : 1) - enemy.def));
        
        if(player.cls.id === 'resolute' && hasEquip('exclusive_resolute')) {
            if(getPlayerStat('def') >= atk * 2) dmg = Math.floor(dmg * 1.5);
        }

        enemy.hp -= dmg;
        floatText(isCrit ? "æš´å‡» "+dmg : dmg, document.getElementById('enemyEl'), isCrit?'#e74c3c':'#fff', isCrit?'24px':'18px');
        updateUI();

        if(player.cls.id === 'agile' && enemy.hp > 0) {
            setTimeout(()=>{
                let extra = getPlayerStat('spd') * (1 + Math.floor(player.lvl/10)*0.2);
                let canCrit = hasEquip('exclusive_agile');
                let exCrit = canCrit && Math.random() < crit;
                if(exCrit) extra *= cdmg;
                enemy.hp -= Math.floor(extra);
                floatText("+" + Math.floor(extra), document.getElementById('enemyEl'), '#f1c40f');
                updateUI();
                if(enemy.hp <= 0) checkResult();
            }, 300);
        } else if (enemy.hp <= 0) {
            checkResult();
        }
    }

    function performEnemyAttack() {
        if(enemy.hp <= 0) return;
        
        // V3.11 ç©¿é€é€»è¾‘
        let penRate = 0.1;
        if(enemy.type === 'elite') penRate = 0.25;
        if(enemy.type === 'boss') penRate = 0.40;
        if(enemy.type === 'evil_dragon') penRate = 0.50;
        
        let def = getPlayerStat('def');
        let dmg = Math.max(1, Math.floor(Math.max(enemy.atk - def, enemy.atk * penRate)));
        
        if(player.hp - dmg <= 0 && player.cls.id === 'wise' && player.mp > dmg/2 && !player.shieldUsed) {
            player.mp -= Math.ceil(dmg/2);
            dmg = 0; player.shieldUsed = true;
            log("æŠ¤ç›¾æŠµæŒ¡!", "#3498db");
        }

        player.hp -= dmg;
        floatText(dmg, document.getElementById('playerEl'), '#c0392b');
        updateUI();

        if(player.cls.id === 'resolute' && player.hp > 0) {
            let reflect = 0;
            let atk = getPlayerStat('atk');
            if(def >= atk * 5) reflect = def * 2 + player.hp * 0.2;
            else if(def >= atk * 2) reflect = def;
            
            if(hasEquip('exclusive_resolute') && def >= atk * 7) {
                reflect = def * 3 + player.hp * 0.35;
                reflect *= 1.5;
            }

            if(reflect > 0) {
                let isCrit = Math.random() < getPlayerStat('critRate');
                reflect = reflect * (isCrit ? getPlayerStat('critDmg') : 1);
                enemy.hp -= Math.floor(reflect);
                floatText("åä¼¤ " + Math.floor(reflect), document.getElementById('enemyEl'), '#e67e22');
            }
        }
        
        if(enemy.type === 'evil_dragon' && player.hp > 0) {
             setTimeout(()=>{ player.hp -= Math.floor(player.maxHp * 0.07); updateUI(); if(player.hp<=0) checkResult(); }, 400);
        }

        if(player.hp <= 0) checkResult();
        else if (isGameActive && enemy.hp > 0) battleLoopId = setTimeout(battleLoop, 800);
    }

    function checkResult() {
        if(enemy.hp <= 0) {
            clearAllTimers();
            document.getElementById('eName').innerText = "å·²å‡»è´¥";
            killCount++; stageCount++;
            
            let gain = player.lvl + 1;
            player.exp += gain;
            while(player.exp >= player.maxExp) { player.lvl++; player.maxExp = player.lvl * 2; log("å‡çº§!", "#f1c40f"); }
            
            let gold = gameLevel * 5 + Math.floor(Math.random()*10);
            if(enemy.type !== 'minion') gold *= 3;
            player.gold += gold;
            log(`è·å¾— ${gold} é‡‘å¸`, '#f1c40f');
            
            let dropRate = 0.01;
            if(enemy.type === 'elite') dropRate = 0.1;
            if(enemy.type === 'boss' || enemy.type === 'evil_dragon') dropRate = 1.0;
            
            if(Math.random() < dropRate) generateLoot(enemy.type);

            // [Ver4.03] ä¸“å±ç»­èˆª
            let healPct = 0.1;
            if (Object.values(player.equips).some(eq => eq && eq.quality === 'red')) healPct += 0.1;
            player.hp = Math.min(player.maxHp, player.hp + player.maxHp * healPct);
            player.mp = Math.min(player.maxMp, player.mp + player.maxMp * healPct);
            
            saveGame();
            updateUI();
            
            if(enemy.type === 'boss' || enemy.type === 'evil_dragon') {
                isPendingRogue = true; 
                stageCount = 0;
            } else if (enemy.type === 'elite') {
                player.eliteKills = (player.eliteKills||0) + 1;
                isPendingRogue = true; 
                stageCount = 0;
            }

            battleLoopId = setTimeout(startNextBattle, 1500);

        } else if(player.hp <= 0) {
            clearAllTimers();
            player.hp = 0; isGameActive = false; updateUI();
            document.getElementById('goReason').innerText = `åœ¨ç¬¬ ${gameLevel} å±‚å€’ä¸‹...`;
            document.getElementById('reviveCount').innerText = "3";
            showLayer('over');
            let cd = 3;
            let timer = setInterval(()=>{ cd--; document.getElementById('reviveCount').innerText = cd; if(cd<=0) { clearInterval(timer); revivePlayer(); } }, 1000);
        }
    }

    function revivePlayer() {
        gameLevel = Math.max(1, gameLevel - 5);
        player.hp = player.maxHp; player.mp = player.maxMp;
        stageCount = 0;
        showLayer('battle');
        startNextBattle();
    }

    // --- Ver4.0 è£…å¤‡ç³»ç»Ÿ ---
    function generateLoot(type) {
        let oreChance = type === 'minion' ? 0.2 : (type === 'elite' ? 0.5 : 1.0);
        if(Math.random() < oreChance) {
             let qty = Math.floor(Math.random() * 3) + 1;
             pushMaterial('ore', qty);
             log(`è·å¾— é­”é“çŸ¿ x${qty}`, '#7f8c8d');
        }
        if(type === 'boss' && Math.random() < 0.5) { pushMaterial('stone', 1); log(`è·å¾— è§£å°çŸ³ x1`, '#9b59b6'); }
        if(type === 'evil_dragon') { pushMaterial('stone', 2); log(`è·å¾— è§£å°çŸ³ x2`, '#9b59b6'); }

        let q = 'white';
        let r = Math.random();
        if(type === 'minion') { if(r < 0.01) q = 'green'; }
        if(type === 'elite') { if(r < 0.25) q = 'green'; else if(r < 0.3) q = 'blue'; }
        if(type === 'boss') { if(r < 0.5) q = 'green'; else if(r < 0.9) q = 'blue'; else q = 'purple'; }
        
        let item = createItem(gameLevel, q);
        if(player.inventory.length < player.maxInventory) {
            player.inventory.push(item);
            log(`è·å¾—: [${QUALITIES[q].name}] ${item.name}`, QUALITIES[q].color);
        } else {
            log(`èƒŒåŒ…æ»¡ï¼Œä¸¢å¼ƒè£…å¤‡`, '#7f8c8d');
        }
    }
    
    function pushMaterial(id, qty) {
        let found = player.inventory.find(i => i.type === 'material' && i.id === id);
        if(found) found.qty = (found.qty || 1) + qty;
        else if(player.inventory.length < player.maxInventory) player.inventory.push({ type:'material', ...MATERIALS[id], qty:qty });
    }
    
    function getMatCount(id) {
        let found = player.inventory.find(i => i.type === 'material' && i.id === id);
        return found ? (found.qty||1) : 0;
    }
    function consumeMat(id, qty) {
        let idx = player.inventory.findIndex(i => i.type === 'material' && i.id === id);
        if(idx === -1) return false;
        if(player.inventory[idx].qty >= qty) {
            player.inventory[idx].qty -= qty;
            if(player.inventory[idx].qty <= 0) player.inventory.splice(idx, 1);
            return true;
        }
        return false;
    }

    function createItem(lvl, qualityKey) {
        let q = QUALITIES[qualityKey];
        let type = EQUIP_SLOTS[Math.floor(Math.random() * EQUIP_SLOTS.length)];
        let baseVal = Math.floor(lvl * 0.5 * q.statMod) + 1;
        let item = {
            uid: Date.now() + Math.random(),
            name: type, type: type, quality: qualityKey, level: lvl,
            stats: {}, affixes: []
        };
        if(type==='weapon') item.stats.atk = baseVal * 2;
        if(type==='armor') { item.stats.def = baseVal; item.stats.hp = baseVal * 10; }
        if(type==='helm') { item.stats.def = baseVal; item.stats.mp = baseVal * 2; }
        if(type==='shoulders') { item.stats.def = Math.floor(baseVal*0.8); item.stats.hp = baseVal * 5; }
        if(type==='boots') item.stats.spd = Math.floor(baseVal/2);
        
        for(let i=0; i<q.affixes; i++) {
            let af = AFFIX_POOL[Math.floor(Math.random() * AFFIX_POOL.length)];
            let val = Math.floor(baseVal * 0.3) + 1;
            if(af.val) val = af.val; 
            item.affixes.push({ id: af.id, text: af.text, val: val });
        }
        return item;
    }
    
    // UI: èƒŒåŒ…
    let bagPage = 0;
    function showInventory() {
        isGameActive = false; clearAllTimers();
        showLayer('inventory');
        renderBag();
        renderEquips();
    }
    function renderBag() {
        const grid = document.getElementById('bagGrid');
        grid.innerHTML = '';
        document.getElementById('matOre').innerText = getMatCount('ore');
        document.getElementById('matStone').innerText = getMatCount('stone');
        
        let start = bagPage * 16;
        for(let i=start; i<start+16; i++) {
            let el = document.createElement('div');
            el.className = 'item-slot';
            if(player.inventory[i]) {
                let it = player.inventory[i];
                if(it.type === 'material') {
                    el.classList.add('rare-material');
                    el.innerHTML = `<div class="item-icon">${it.id==='ore'?'ğŸª¨':'ğŸ”®'}</div><div class="item-count">${it.qty||1}</div>`;
                } else {
                    el.classList.add('rare-'+it.quality);
                    el.innerHTML = `<div class="item-icon">${getIcon(it.type)}</div><div class="item-lvl">Lv${it.level}</div>`;
                }
                el.onclick = () => selectItem(i);
            }
            grid.appendChild(el);
        }
        document.getElementById('bagPageNum').innerText = bagPage + 1;
    }
    function getIcon(type) {
        const icons = { weapon:'âš”ï¸', offhand:'ğŸ›¡ï¸', helm:'ğŸª–', shoulders:'ğŸ¦¾', armor:'ğŸ‘•', belt:'ğŸ—ï¸', boots:'ğŸ‘¢', accessory:'ğŸ“¿', ringL:'ğŸ’', ringR:'ğŸ’' };
        return icons[type] || 'ğŸ“¦';
    }
    let selectedIdx = -1;
    function selectItem(idx) {
        selectedIdx = idx;
        let it = player.inventory[idx];
        let btnEq = document.getElementById('btnEquip');
        let btnUp = document.getElementById('btnUpgrade');
        btnEq.style.display = 'inline-block'; btnUp.style.display = 'none';
        
        if(it.type === 'material') {
             document.getElementById('itemDetailBox').innerHTML = `<div class="item-title" style="color:${it.color}">${it.name}</div><div class="item-desc">${it.desc}</div>`;
             document.getElementById('btnEquip').disabled = true;
             return;
        }
        
        let html = `<div class="item-title" style="color:${QUALITIES[it.quality].color}">${it.name} <span style="font-size:10px">Lv.${it.level} ${QUALITIES[it.quality].name}</span></div>`;
        html += `<div class="item-stats">`;
        
        if(it.quality === 'red') { 
            let lv = it.upgradeLevel || 0;
            let cost = 3 * (lv + 1);
            html += `é˜¶æ®µ: +${lv}<br>`;
            for(let k in EXCLUSIVE_STATS[player.cls.id]) {
                let base = getDynamicStat(it, k);
                let rawBase = Math.floor(gameLevel * EXCLUSIVE_STATS[player.cls.id][k]);
                let bonus = base - rawBase;
                if(base > 0) html += `${k.toUpperCase()}: ${rawBase} <span style="color:#2ecc71">(+${bonus})</span><br>`;
            }
            btnEq.disabled = false;
            btnUp.style.display = 'inline-block';
            btnUp.innerText = `è§£å° (-${cost}çŸ³)`;
        } else {
            for(let k in it.stats) html += `åŸºç¡€ ${k.toUpperCase()} +${it.stats[k]}<br>`;
            it.affixes.forEach(af => html += `è¯æ¡ ${af.text} ${af.val}<br>`);
            btnEq.disabled = false;
        }
        html += `</div>`;
        if(it.desc) html += `<div class="item-desc">${it.desc}</div>`;
        document.getElementById('itemDetailBox').innerHTML = html;
    }
    
    function forgeExclusive() {
        let costOre = 110;
        let costStone = 3;
        if (getMatCount('ore') >= costOre && getMatCount('stone') >= costStone) {
            if(player.inventory.some(i=>i.quality==='red') || Object.values(player.equips).some(i=>i&&i.quality==='red')) {
                alert("ä½ å·²ç»æ‹¥æœ‰ä¸“å±è£…å¤‡äº†(æ¯äººé™ä¸€ä»¶)");
                return;
            }
            if(consumeMat('ore', costOre) && consumeMat('stone', costStone)) {
                let def = EXCLUSIVE_GEAR[player.cls.id];
                let item = {
                    uid: 'exclusive_' + player.cls.id,
                    name: def.name, type: def.slot, quality: 'red', level: 1, upgradeLevel: 0,
                    desc: def.desc, stats:{}, affixes:[]
                };
                player.inventory.push(item);
                alert("ä¸“å±ç¥å…µé”»é€ å®Œæˆï¼");
                renderBag();
                saveGame();
            }
        } else {
            alert(`ææ–™ä¸è¶³ï¼éœ€è¦ é­”é“çŸ¿x${costOre}, è§£å°çŸ³x${costStone}`);
        }
    }
    
    function upgradeExclusive() {
        if(selectedIdx === -1) return;
        let it = player.inventory[selectedIdx];
        if(it.quality !== 'red') return;
        
        let cost = 3 * ((it.upgradeLevel||0) + 1);
        if(getMatCount('stone') >= cost) {
            if(consumeMat('stone', cost)) {
                it.upgradeLevel = (it.upgradeLevel||0) + 1;
                alert(`è§£å°æˆåŠŸï¼å½“å‰é˜¶æ®µ +${it.upgradeLevel}`);
                selectItem(selectedIdx); 
                renderBag();
                saveGame();
            }
        } else {
            alert(`è§£å°çŸ³ä¸è¶³ (éœ€è¦ ${cost})`);
        }
    }

    function equipSelectedItem() {
        if(selectedIdx === -1) return;
        let item = player.inventory[selectedIdx];
        if(item.type === 'material') return; 
        
        if(player.equips[item.type]) player.inventory.push(player.equips[item.type]);
        player.equips[item.type] = item;
        player.inventory.splice(selectedIdx, 1);
        selectedIdx = -1;
        renderBag(); renderEquips();
        document.getElementById('itemDetailBox').innerHTML = 'å·²è£…å¤‡';
        saveGame();
    }
    function unequipItem(slot) {
        if(player.equips[slot]) {
            if(player.inventory.length < player.maxInventory) {
                player.inventory.push(player.equips[slot]);
                player.equips[slot] = null;
                renderBag(); renderEquips();
            } else { alert("èƒŒåŒ…å·²æ»¡"); }
        }
    }
    function renderEquips() {
        for(let slot of EQUIP_SLOTS) {
            let el = document.getElementById('visual-'+slot);
            let item = player.equips[slot];
            if(item) {
                el.innerText = getIcon(slot);
                el.parentElement.style.borderColor = QUALITIES[item.quality] ? QUALITIES[item.quality].color : '#bdc3c7';
            } else {
                el.innerText = '';
                el.parentElement.style.borderColor = '#bdc3c7';
            }
        }
    }
    function changeBagPage(dir) {
        let maxPage = 9; 
        bagPage += dir;
        if(bagPage < 0) bagPage = 0;
        if(bagPage > maxPage) bagPage = maxPage;
        renderBag();
    }
    function closeInventory() {
        isGameActive = true;
        showLayer('battle');
        startNextBattle();
    }
    
    // åˆæˆ (3åˆ1)
    function trySynthesize() {
        // ç®€å•åˆå¹¶é€»è¾‘ï¼šéå†èƒŒåŒ…ï¼Œæ‰¾åˆ°3ä¸ªåŒå“è´¨åŒç±»å‹çš„
        let counts = {};
        let toRemove = [];
        let crafted = false;

        // 1. ç»Ÿè®¡
        for(let i=0; i<player.inventory.length; i++) {
            let it = player.inventory[i];
            if(!it || it.type === 'material' || it.quality === 'orange' || it.quality === 'red') continue;
            let key = it.quality + '_' + it.type;
            if(!counts[key]) counts[key] = [];
            counts[key].push(i);
        }

        // 2. åˆæˆ
        for(let key in counts) {
            let idxs = counts[key];
            while(idxs.length >= 3) {
                let quality = key.split('_')[0];
                let nextQ = { white:'green', green:'blue', blue:'purple', purple:'orange' }[quality];
                if(nextQ) {
                    // æ ‡è®°åˆ é™¤å‰3ä¸ª
                    let consumed = idxs.splice(0, 3);
                    toRemove.push(...consumed);
                    // ç”Ÿæˆæ–°ç‰©å“
                    let newItem = createItem(gameLevel, nextQ);
                    player.inventory.push(newItem);
                    crafted = true;
                } else break;
            }
        }

        // 3. æ¸…ç†
        if(crafted) {
            toRemove.sort((a,b)=>b-a); // ä»åå¾€å‰åˆ 
            toRemove.forEach(idx => player.inventory.splice(idx, 1));
            alert("åˆæˆå®Œæˆï¼");
            renderBag();
            saveGame();
        } else {
            alert("æ²¡æœ‰å¯åˆæˆçš„è£…å¤‡ (éœ€3ä»¶åŒå“è´¨åŒéƒ¨ä½)");
        }
    }
    
    // å•†åº—
    function openShop() {
        showLayer('shop');
        let box = document.getElementById('shopContainer');
        box.innerHTML = '';
        document.getElementById('shopLevel').innerText = gameLevel;
        for(let i=0; i<3; i++) {
            let item = createItem(gameLevel, Math.random()>0.5 ? 'green' : 'blue');
            let price = item.level * 100 * (item.quality==='blue'?2:1);
            let el = document.createElement('div');
            el.className = 'shop-row';
            el.innerHTML = `<div><span style="color:${QUALITIES[item.quality].color}">${item.name}</span> <span style="font-size:10px">Lv${item.level}</span></div><button class="btn-green" onclick="buyItem(${i}, ${price})">ğŸ’° ${price}</button>`;
            if(!window.shopItems) window.shopItems = [];
            window.shopItems[i] = item;
            box.appendChild(el);
        }
    }
    window.buyItem = function(idx, price) {
        if(player.gold >= price) {
            if(player.inventory.length < player.maxInventory) {
                player.gold -= price;
                player.inventory.push(window.shopItems[idx]);
                alert("è´­ä¹°æˆåŠŸ!"); updateUI();
            } else alert("èƒŒåŒ…å·²æ»¡");
        } else alert("é‡‘å¸ä¸è¶³");
    };
    function leaveShop() {
        isGameActive = true;
        showLayer('battle');
        startNextBattle();
    }

    // --- è¾…åŠ© ---
    function clearAllTimers() {
        if(bloodInterval) clearInterval(bloodInterval);
        if(mechInterval) clearInterval(mechInterval);
        if(battleLoopId) clearTimeout(battleLoopId);
        if(testInterval) clearInterval(testInterval);
    }
    
    function startDamageTest() {
        isTestingDamage = true; isGameActive = true;
        testTotalDamage = 0; testTimer = 10;
        player.hp = player.maxHp; player.mp = player.maxMp;
        document.getElementById('eName').innerText = "æœ¨æ¡©";
        enemy = { hp: 99999999, atk:0, def:0, spd:0, visual: SVGS.stake };
        document.getElementById('eVisual').innerHTML = enemy.visual;
        
        testInterval = setInterval(() => {
            testTimer--;
            if (testTimer <= 0) {
                clearAllTimers(); isTestingDamage = false;
                alert(`DPS: ${(testTotalDamage/10).toFixed(1)}`);
                startNextBattle();
            }
        }, 1000);
        battleLoopId = setTimeout(battleLoop, 800);
    }
    
    function checkSave() {
         let has = false;
         for(let i=0; i<3; i++) if(localStorage.getItem(`bigCatQuest_slot_${i}`)) has=true;
         document.getElementById('continueBtn').disabled = !has;
    }
    function updateUI() {
        if(!player) return;
        document.getElementById('pHpBar').style.width = (player.hp/player.maxHp*100)+'%';
        document.getElementById('pMpBar').style.width = (player.mp/player.maxMp*100)+'%';
        document.getElementById('eHpBar').style.width = (enemy.hp/enemy.maxHp*100)+'%';
        document.getElementById('goldVal').innerText = player.gold;
    }
    function goToMainMenu() { saveGame(); location.reload(); }

    function renderChangelog() {
        let log = document.getElementById('changelogBox');
        log.innerHTML = `
            <div class="log-block"><div class="log-ver">Ver 4.04</div><div class="log-date">ç´§æ€¥ä¿®å¤</div><ul class="log-list"><li>ç•Œé¢UIï¼šæ¢å¤ç»å…¸150pxå›¾æ ‡ä¸å¸ƒå±€ã€‚</li><li>å­˜æ¡£ä¿®å¤ï¼šè‡ªåŠ¨è¡¥å…¨æ—§å­˜æ¡£ç¼ºå¤±æ•°æ®ï¼Œè§£å†³ç™½å±ã€‚</li><li>äº¤äº’ä¼˜åŒ–ï¼šæ¢å¤ç‚¹å‡»æ§½ä½å³è¯»å–çš„é€»è¾‘ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.03</div><div class="log-date">ä¸“å±è§‰é†’</div><ul class="log-list"><li>ä¸“å±è£…å¤‡ç³»ç»Ÿä¸Šçº¿ï¼šåŠ¨æ€æˆé•¿ã€æ— é™å¼ºåŒ–ã€èŒä¸šç‰¹åŒ–ã€‚</li><li>é”»é€ åŠŸèƒ½å®è£…ï¼šæ¶ˆè€—çŸ¿çŸ³æ‰“é€ ç¥å™¨ã€‚</li><li>æˆ˜åç»­èˆªï¼šä¸“å±è£…å¤‡æä¾›10%åŒå›ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.02</div><div class="log-date">ææ–™è¡¥å®Œ</div><ul class="log-list"><li>å®è£…ææ–™ç³»ç»Ÿï¼šé­”é“çŸ¿ã€è§£å°çŸ³ã€‚</li><li>æ‰è½é€»è¾‘å‡çº§ï¼šæ”¯æŒå¤šé‡æ‰è½ï¼ˆé‡‘å¸+ææ–™+è£…å¤‡ï¼‰ã€‚</li><li>èƒŒåŒ…æ‰©å®¹ä¸åˆ†ç±»æ˜¾ç¤ºä¼˜åŒ–ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.01</div><div class="log-date">å¤§æ‰©å®¹</div><ul class="log-list"><li>èƒŒåŒ…ä¸Šé™æå‡è‡³160æ ¼ï¼ˆ10é¡µï¼‰ã€‚</li><li>æ–°å¢è£…å¤‡æ§½ï¼šæŠ¤è‚©ã€å·¦æˆ’ã€å³æˆ’ã€‚</li><li>å­˜æ¡£è‡ªåŠ¨è¿ç§»ç³»ç»Ÿä¸Šçº¿ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 4.00</div><div class="log-date">å¤§ç¾å˜</div><ul class="log-list"><li>å®è£…è£…å¤‡ç³»ç»Ÿï¼šèƒŒåŒ…ã€è£…å¤‡æ ã€éšæœºæ‰è½ã€‚</li><li>å®è£…ä¸“å±è£…å¤‡ï¼š6å¤§èŒä¸šä¸“å±ç¥å™¨ã€‚</li><li>å®è£…å•†åº—ä¸é‡‘å¸ç³»ç»Ÿã€‚</li><li>æˆ˜æ–—é€»è¾‘é‡æ„ï¼šå®Œç¾ä¿®å¤å¡æ­»BUGã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 3.10</div><div class="log-date">ç¨³å®šä¿®å¤</div><ul class="log-list"><li>ä¿®å¤ç²¾è‹±æ€ªå¡æ­»ã€‚</li><li>è‡ªåŠ¨å¤æ´»å®è£…ã€‚</li></ul></div>
            <div class="log-block"><div class="log-ver">Ver 1.0~3.09</div><div class="log-date">å†å²ç‰ˆæœ¬</div><ul class="log-list"><li>åŸºç¡€ç©æ³•ã€èŒä¸šã€å¤©èµ‹ã€å¡ç‰Œè‚‰é¸½è¿­ä»£å®Œæˆã€‚</li></ul></div>
        `;
    }
</script>
</body>
</html>