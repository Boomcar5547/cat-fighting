<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§çŒ«çŒ«æ–—æ¶é¾™ Ver3.10</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px;
            max-height: 900px;
            background: #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- ç•Œé¢å±‚çº§ --- */
        .layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.98);
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .active { display: flex; }
        
        .layer-scroll {
            justify-content: flex-start;
            padding-top: 40px;
            padding-bottom: 60px;
        }

        /* --- åŸºç¡€ç»„ä»¶ --- */
        h1 { color: #e67e22; text-shadow: 2px 2px #f1c40f; margin-bottom: 5px; text-align: center; flex-shrink: 0;}
        h2 { color: #2c3e50; margin-bottom: 20px; text-align: center; }
        .version { color: #7f8c8d; font-size: 12px; margin-bottom: 20px; flex-shrink: 0;}
        input { padding: 12px; border: 2px solid #3498db; border-radius: 8px; width: 70%; text-align: center; font-size: 16px; margin-bottom: 20px; flex-shrink: 0;}
        
        button { padding: 12px 25px; background: #e67e22; color: white; border: none; border-radius: 20px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #d35400; transition: all 0.1s; margin: 10px; flex-shrink: 0; width: 70%; }
        button:active { transform: translateY(4px); box-shadow: 0 0 0 #d35400; }
        button:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; transform: none; color: #fff; }
        
        .btn-blue { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-blue:active { transform: translateY(4px); box-shadow: 0 0 0 #2980b9; }
        .btn-green { background: #2ecc71; box-shadow: 0 4px 0 #27ae60; }
        .btn-green:active { transform: translateY(4px); box-shadow: 0 0 0 #27ae60; }
        .btn-gray { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; font-size: 14px; padding: 8px 20px; }
        
        .btn-home {
            position: absolute; top: 10px; left: 10px; width: 36px; height: 36px; border-radius: 50%;
            background: #fff; border: 2px solid #bdc3c7; color: #7f8c8d; font-size: 20px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            z-index: 20; padding: 0; margin: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- å­˜æ¡£æ§½ä½æ ·å¼ --- */
        .slot-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .save-slot {
            background: #fff;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            position: relative;
        }
        .save-slot:hover { border-color: #3498db; transform: scale(1.01); }
        .save-slot.empty { border-style: dashed; background: #f9f9f9; color: #95a5a6; justify-content: center; }
        .slot-info { display: flex; flex-direction: column; align-items: flex-start; }
        .slot-title { font-weight: bold; color: #2c3e50; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .slot-detail { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .slot-icon { width: 30px; height: 30px; }
        .delete-btn {
            padding: 5px 10px; font-size: 12px; background: #e74c3c; border-radius: 5px; margin-left: 10px; z-index: 5; color: white; width: auto; box-shadow: none;
        }

        /* --- æ—¥å¿— & å±æ€§ --- */
        .scroll-box {
            width: 100%;
            flex-grow: 1;
            background: #f9f9f9;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            margin-bottom: 20px;
            text-align: left;
            cursor: grab;
            min-height: 200px;
        }
        .scroll-box:active { cursor: grabbing; }
        .log-block { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
        .log-ver { color: #e67e22; font-weight: 900; font-size: 16px; margin-bottom: 5px; }
        .log-date { color: #95a5a6; font-size: 12px; margin-bottom: 8px; }
        .log-list { padding-left: 20px; margin: 0; }
        .log-list li { font-size: 13px; color: #34495e; margin-bottom: 4px; line-height: 1.5; }
        .highlight { color: #c0392b; font-weight: bold; }
        .apology { color: #c0392b; font-weight: bold; background: #fadbd8; padding: 10px; border-radius: 5px; margin-top: 5px; border: 1px solid #e6b0aa; font-size: 13px; line-height: 1.5; }

        .attr-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 14px; color: #34495e; }
        .attr-val { color: #2980b9; font-family: monospace; font-size: 16px; }

        /* --- èŒä¸šé€‰æ‹© --- */
        .card-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; padding-bottom: 20px; }
        .class-card { background: white; border: 2px solid #bdc3c7; border-radius: 10px; padding: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
        .class-card:hover { border-color: #3498db; transform: scale(1.02); }
        .class-card h3 { margin: 5px 0; color: #2c3e50; font-size: 15px; }
        .svg-icon { width: 60px; height: 60px; margin: 5px auto; }
        .stats-text { font-size: 9px; color: #7f8c8d; text-align: left; line-height: 1.3; width: 100%; }
        .talent-text { font-size: 9px; color: #c0392b; margin-top: 5px; font-weight: bold; text-align: left; border-top: 1px dashed #eee; padding-top:5px; width: 100%; }

        /* --- æˆ˜æ–—ç•Œé¢ --- */
        #battleLayer { background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #90EE90 70%, #90EE90 100%); justify-content: space-between; padding: 0; overflow: hidden;}
        .cloud { position: absolute; background: white; border-radius: 50px; opacity: 0.8; animation: floatCloud 20s linear infinite; }
        @keyframes floatCloud { from { left: -100px; } to { left: 100%; } }
        .battle-hud { width: 100%; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; padding-left: 50px; box-sizing: border-box; display: flex; justify-content: space-between; font-size: 14px; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .battle-scene { flex-grow: 1; width: 100%; position: relative; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 25%; z-index: 2; }
        .fighter { width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; transition: transform 0.2s; }
        .fighter-svg { width: 100%; height: 100%; filter: drop-shadow(0 5px 2px rgba(0,0,0,0.2)); }
        .status-box { position: absolute; top: -40px; width: 100%; text-align: center; }
        .fighter-name { background: rgba(0,0,0,0.5); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 12px; display: inline-block; margin-bottom: 2px; }
        .bar-bg { width: 80px; height: 8px; background: #333; border-radius: 4px; margin: 1px auto; overflow: hidden; border:1px solid #fff;}
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.3s; }
        .mp-fill { height: 100%; background: #3498db; width: 100%; transition: width 0.3s; }

        .toolbar { position: absolute; bottom: 140px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 6; padding: 0 5px; }
        .tool-btn { width: 40px; height: 40px; background: #fff; border: 2px solid #bdc3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.1s; }
        .tool-btn:active { transform: scale(0.9); }
        .tool-btn svg { width: 22px; height: 22px; }

        .bottom-panel { width: 100%; background: #fff; padding: 10px; box-sizing: border-box; border-top: 4px solid #f1c40f; z-index: 5; }
        .exp-container { width: 100%; height: 15px; background: #bdc3c7; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        .exp-fill { height: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); width: 0%; transition: width 0.5s; }
        .exp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; font-size: 10px; line-height: 15px; color: #333; font-weight: bold; }

        .floating-text { position: absolute; font-weight: 900; font-size: 20px; animation: floatUp 0.8s ease-out forwards; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff; z-index: 20; white-space: nowrap; left: 50%; transform: translateX(-50%); top: -40px; pointer-events: none;}
        @keyframes floatUp { 0% { top: -40px; opacity: 1; transform: translateX(-50%) scale(1); } 100% { top: -90px; opacity: 0; transform: translateX(-50%) scale(1.2); } }

        .slash-effect { position: absolute; width: 150px; height: 150px; background: transparent; border: 2px solid transparent; z-index: 15; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .slash-effect::before { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 4px; background: #e74c3c; transform: rotate(-45deg); box-shadow: 0 0 10px #c0392b; animation: slashAnim 0.3s forwards; }
        @keyframes slashAnim { 0% { width: 0; opacity: 0; } 50% { width: 100%; opacity: 1; } 100% { width: 100%; opacity: 0; } }

        .log-box { width: 100%; height: 120px; background: #f8f9fa; overflow-y: auto; padding: 10px; box-sizing: border-box; font-size: 12px; border-top: 1px solid #ccc; }
        .log-entry { margin-bottom: 3px; border-bottom: 1px dashed #eee; padding-bottom: 2px; line-height: 1.4;}
        
        #rogueContainer { display: flex; flex-direction: row; justify-content: space-between; align-items: stretch; width: 100%; gap: 10px; margin-bottom: 20px;}
        .rogue-card { flex: 1; border: 2px solid #ccc; border-radius: 8px; padding: 10px 5px; background: #fff; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .rogue-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
        .rogue-card.selected { border: 3px solid #f1c40f; background: #fcf8e3; transform: scale(1.05); box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); }
        .card-icon { font-size: 32px; margin-bottom: 5px; }
        .card-white { border-top: 5px solid #bdc3c7; }
        .card-green { border-top: 5px solid #2ecc71; }
        .card-blue { border-top: 5px solid #3498db; }
        .card-purple { border-top: 5px solid #9b59b6; }
        .card-orange { border-top: 5px solid #e67e22; }

    </style>
</head>
<body>

<div id="gameContainer">
    
    <div id="startLayer" class="layer active layer-scroll">
        <h1>å¤§çŒ«çŒ«æ–—æ¶é¾™</h1>
        <div class="version">Ver3.10.12122501beta</div>
        <svg width="150" height="150" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" fill="#f1c40f" stroke="#e67e22" stroke-width="3"/>
            <path d="M30 30 L40 10 L55 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <path d="M70 30 L60 10 L45 30 Z" fill="#f1c40f" stroke="#e67e22" stroke-width="2"/>
            <circle cx="35" cy="45" r="5" fill="#2c3e50"/>
            <circle cx="65" cy="45" r="5" fill="#2c3e50"/>
            <path d="M45 60 Q50 70 55 60" stroke="#c0392b" stroke-width="3" fill="none"/>
            <path d="M10 50 L90 50" stroke="#bdc3c7" stroke-width="5" opacity="0.5"/>
        </svg>
        <br>
        <button class="btn-green" id="continueBtn" onclick="openSlotMenu('load')" disabled>æš‚æ— å­˜æ¡£</button>
        <br>
        <button class="btn-blue" onclick="openSlotMenu('new')" style="width:70%">æ–°æ¸¸æˆ</button>
        <br>
        <button class="btn-gray" onclick="showLayer('changelog')" style="width:70%">æ›´æ–°æ—¥å¿—</button>
    </div>

    <div id="slotLayer" class="layer layer-scroll">
        <h2 id="slotTitle">é€‰æ‹©å­˜æ¡£</h2>
        <div id="slotList" class="slot-container"></div>
        <button onclick="showLayer('start')" style="margin-top:20px; background:#95a5a6;">è¿”å›</button>
    </div>
    
    <div id="nameInputLayer" class="layer">
        <h2>åˆ›å»ºè§’è‰²</h2>
        <input type="text" id="playerNameInput" placeholder="è¯·è¾“å…¥ä½ çš„å‹‡è€…å" maxlength="8">
        <button onclick="goToClassSelection()">ä¸‹ä¸€æ­¥</button>
        <button onclick="showLayer('slot')" style="background:#95a5a6;">å–æ¶ˆ</button>
    </div>

    <div id="changelogLayer" class="layer layer-scroll">
        <h2>æ›´æ–°æ—¥å¿—</h2>
        <div class="scroll-box" id="changelogBox">
            <div class="log-block">
                <div class="log-ver">Ver 3.10.12122501beta</div>
                <div class="log-date">è‡´å‘½ä¿®å¤</div>
                <ul class="log-list">
                    <li><span class="highlight">äº¤äº’ä¿®å¤</span>ï¼šä¿®å¤äº†ç‚¹å‡»[è¯»å–å­˜æ¡£]/[æ–°æ¸¸æˆ]æ— ååº”çš„Bugï¼ˆç”±äºå†…éƒ¨IDå¼•ç”¨é”™è¯¯å¯¼è‡´ï¼‰ã€‚</li>
                    <li><span class="highlight">é€»è¾‘å›å½’</span>ï¼šå­˜æ¡£é€‰æ‹©ç•Œé¢æ¢å¤ä¸ºâ€œç‚¹å‡»å³ç”Ÿæ•ˆâ€çš„ç¨³å®šé€»è¾‘ã€‚</li>
                </ul>
            </div>
             <div class="log-block">
                <div class="log-ver">Ver 3.09</div>
                <div class="log-date">è§£æ”¾åŒæ‰‹</div>
                <ul class="log-list">
                    <li>å…¨è‡ªåŠ¨å¤æ´»æœºåˆ¶ï¼šç©å®¶æ­»äº¡å3ç§’è‡ªåŠ¨å›é€€5å±‚å¹¶å¼€å§‹æˆ˜æ–—ã€‚</li>
                    <li>æ—¥å¿—é‡æ„ï¼šè¡¥å…¨æ‰€æœ‰å†å²æ›´æ–°è¯¦æƒ…ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 3.06~3.08</div>
                <div class="log-date">ç¨³å®šæ€§ä¼˜åŒ–</div>
                <ul class="log-list">
                    <li>æœºæ¢°çŒ«ä¿®å¤ï¼šæµ®ç‚¹æ•°æ‰£è“ï¼Œæ°¸ä¸å¡æ­»ã€‚</li>
                    <li>å¤šå­˜æ¡£ä¿®å¤ï¼šæ§½ä½é”å®šé€»è¾‘ä¿®æ­£ã€‚</li>
                    <li>æœºæ¢°çŒ«ç«ç®­å¼¹ä¼¤å®³å€ç‡ä¸Šè°ƒ (0.25/0.75)ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 3.05</div>
                <div class="log-date">é‚ªé¾™é™ä¸´</div>
                <ul class="log-list">
                    <li>æ–°å¢ç™¾å±‚BOSSã€é‚ªé¾™ã€‘ï¼Œæ‹¥æœ‰çœŸå®ä¼¤å®³é¾™æ¯ã€‚</li>
                    <li>æ–°å¢æ€ªç‰©ç©¿é€æœºåˆ¶ã€‚</li>
                    <li>æ‰è½ä¼˜åŒ–ï¼šBOSSæˆ˜åä¸å†æ‰è½ç™½å¡ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 3.04</div>
                <div class="log-date">ç‰ˆæœ¬ä¿®æ­£</div>
                <ul class="log-list">
                    <li>ä¿®å¤ç‰ˆæœ¬å·æ··ä¹±ã€‚</li>
                    <li>æ•´åˆç¾æœ¯èµ„æºã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 3.0</div>
                <div class="log-date">èŒä¸šè§‰é†’</div>
                <ul class="log-list">
                    <li>æ–°å¢è¡€éª‘çŒ«ã€æœºæ¢°çŒ«ã€‚</li>
                    <li>å¡ç‰Œæ± é‡æ„ï¼Œæ–°å¢å”¯ä¸€å¡ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 2.1</div>
                <div class="log-date">å¤šå­˜æ¡£</div>
                <ul class="log-list">
                    <li>æ”¯æŒ3ä¸ªç‹¬ç«‹å­˜æ¡£æ§½ä½ã€‚</li>
                </ul>
            </div>
            <div class="log-block">
                <div class="log-ver">Ver 2.0</div>
                <div class="log-date">å­˜æ¡£ç³»ç»Ÿ</div>
                <ul class="log-list">
                    <li>æ–°å¢è‡ªåŠ¨/æ‰‹åŠ¨å­˜æ¡£åŠŸèƒ½ã€‚</li>
                </ul>
            </div>
             <div class="log-block">
                <div class="log-ver">Ver 1.0~1.9</div>
                <div class="log-date">æ—©æœŸç‰ˆæœ¬</div>
                <ul class="log-list">
                    <li>åŸºç¡€ç©æ³•ä¸èŒä¸šæ„å»ºã€‚</li>
                    <li>å¡ç‰Œè‚‰é¸½ç³»ç»Ÿã€‚</li>
                    <li>SVGç¾æœ¯å‡çº§ã€‚</li>
                </ul>
            </div>
        </div>
        <button onclick="showLayer('start')">è¿”å›ä¸»ç•Œé¢</button>
    </div>

    <div id="classLayer" class="layer layer-scroll">
        <h2 style="color:#2c3e50; font-size: 20px;">è¯·é€‰æ‹©ä½ çš„èŒä¸š</h2>
        <div class="card-container" id="classContainer"></div>
        <button onclick="showLayer('name')" style="margin-top:20px; background:#95a5a6;">è¿”å›</button>
    </div>

    <div id="battleLayer" class="layer">
        <div class="cloud" style="top:20px; width:80px; height:30px; animation-duration:25s;"></div>
        <div class="cloud" style="top:60px; width:120px; height:40px; animation-duration:35s; animation-delay:-10s"></div>

        <button class="btn-home" onclick="goToMainMenu()" title="è¿”å›ä¸»èœå•">ğŸ </button>

        <div class="battle-hud">
            <div>ğŸ“ ç¬¬ <span id="levelText" style="color:#f1c40f; font-weight:bold">1</span> å±‚</div>
            <div>ğŸ’€ å‡»æ€: <span id="killText">0</span></div>
        </div>

        <div class="battle-scene">
            <div id="playerEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="pName">å‹‡è€…</div>
                    <div class="bar-bg"><div class="hp-fill" id="pHpBar"></div></div>
                    <div class="bar-bg" style="margin-top:1px; height:4px; border:none;"><div class="mp-fill" id="pMpBar"></div></div>
                    <div style="font-size:10px; color:#fff; text-shadow:1px 1px 0 #000;" id="pMpVal"></div>
                </div>
                <div id="pVisual" class="fighter-svg"></div>
            </div>
            <div id="enemyEl" class="fighter">
                <div class="status-box">
                    <div class="fighter-name" id="eName">æ€ªç‰©</div>
                    <div class="bar-bg"><div class="hp-fill" id="eHpBar"></div></div>
                </div>
                <div id="eVisual" class="fighter-svg"></div>
            </div>
        </div>

        <div class="toolbar">
            <div class="tool-btn" onclick="showAttrPanel()" title="è§’è‰²å±æ€§">
                <svg viewBox="0 0 24 24" fill="#34495e"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
            </div>
            <div class="tool-btn" onclick="alert('èƒŒåŒ…ç³»ç»Ÿæš‚æœªå®è£…ï¼Œæ•¬è¯·æœŸå¾…ï¼')" title="èƒŒåŒ…">
                <svg viewBox="0 0 24 24" fill="#e67e22"><path d="M12 2l-5.5 9h11z"/><path d="M10 12h4v4h-4z"/><path d="M4 14v8h16v-8l-2-3H6z"/></svg>
            </div>
            <div class="tool-btn" onclick="alert('è£…å¤‡ç³»ç»Ÿæš‚æœªå®è£…ï¼Œæ•¬è¯·æœŸå¾…ï¼')" title="è£…å¤‡">
                <svg viewBox="0 0 24 24" fill="#95a5a6"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
            </div>
            <div class="tool-btn" onclick="startDamageTest()" title="ä¼¤å®³æµ‹è¯•">
                <svg viewBox="0 0 24 24" fill="#c0392b"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4h2v4zm2-6H8V9h6v2z"/></svg>
            </div>
            <div class="tool-btn" onclick="saveGame(true)" title="ä¿å­˜è¿›åº¦">
                <svg viewBox="0 0 24 24" fill="#2980b9"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
            </div>
        </div>

        <div class="bottom-panel">
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px;">
                <span>EXP</span>
                <span>LV.<span id="pLvVal">1</span></span>
            </div>
            <div class="exp-container">
                <div class="exp-fill" id="expFill"></div>
                <div class="exp-text" id="expText">0/2</div>
            </div>
        </div>
        <div class="log-box" id="battleLog">
            <div class="log-entry">æ¬¢è¿æ¥åˆ°å¤§çŒ«çŒ«çš„ä¸–ç•Œ...</div>
        </div>
    </div>

    <div id="cardLayer" class="layer layer-scroll">
        <h2 style="color:#8e44ad; font-size:22px;">ğŸ å‘½è¿çš„é¦ˆèµ </h2>
        <p style="color:#7f8c8d; font-size:12px; margin-bottom:15px;">è¯·ç‚¹å‡»å¡ç‰Œé€‰ä¸­ï¼Œç„¶åç¡®è®¤</p>
        <div id="rogueContainer"></div>
        <button id="confirmCardBtn" onclick="confirmRogueSelection()" disabled style="width:80%; margin-top:20px;">ç¡®è®¤é€‰æ‹©</button>
    </div>

    <div id="gameOverLayer" class="layer">
        <h1 style="color: #c0392b;">ğŸ’” èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹</h1>
        <p id="goReason" style="font-size:18px; color:#34495e;">...</p>
        <button onclick="revivePlayer()">å¤æ´»</button>
    </div>

    <div id="attrLayer" class="layer layer-scroll">
        <h2>è§’è‰²å±æ€§</h2>
        <div class="scroll-box" style="margin-bottom:20px;">
            <div class="attr-row"><span class="attr-label">åç§°</span><span class="attr-val" id="attrName">---</span></div>
            <div class="attr-row"><span class="attr-label">èŒä¸š</span><span class="attr-val" id="attrClass">---</span></div>
            <div class="attr-row"><span class="attr-label">ç­‰çº§</span><span class="attr-val" id="attrLvl">1</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«è¡€ (HP)</span><span class="attr-val" id="attrHp">---</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«èƒ½ (MP)</span><span class="attr-val" id="attrMp">---</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«å¨ (Atk)</span><span class="attr-val" id="attrAtk">0</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«å¾¡ (Def)</span><span class="attr-val" id="attrDef">0</span></div>
            <div class="attr-row"><span class="attr-label">çŒ«é€Ÿ (Spd)</span><span class="attr-val" id="attrSpd">0</span></div>
            <div class="attr-row"><span class="attr-label">æš´å‡»ç‡</span><span class="attr-val" id="attrCrit">0%</span></div>
            <div class="attr-row"><span class="attr-label">æš´å‡»ä¼¤å®³</span><span class="attr-val" id="attrCritDmg">150%</span></div>
        </div>
        <button onclick="closeAttrPanel()">è¿”å›æˆ˜æ–—</button>
    </div>

</div>

<script>
    // --- 0. SVG ç»˜å›¾åº“ (LOCKED) ---
    const SVGS = {
        cat_resolute: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#bdc3c7" stroke="#2c3e50" stroke-width="2"/><rect x="30" y="15" width="20" height="25" rx="5" fill="none" stroke="#2c3e50" stroke-width="2"/><line x1="40" y1="15" x2="40" y2="40" stroke="#2c3e50" stroke-width="1"/><line x1="30" y1="27" x2="50" y2="27" stroke="#2c3e50" stroke-width="1"/><path d="M65 40 L90 10" stroke="#95a5a6" stroke-width="6"/><path d="M65 40 L90 10" stroke="#2c3e50" stroke-width="2"/><line x1="60" y1="45" x2="70" y2="35" stroke="#f1c40f" stroke-width="4"/></g></svg>`,
        cat_agile: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#f1c40f" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M70 40 L85 25" stroke="#3498db" stroke-width="4"/><path d="M10 40 L-5 25" stroke="#3498db" stroke-width="4"/></g></svg>`,
        cat_wise: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#9b59b6" stroke="#2c3e50" stroke-width="2"/><circle cx="30" cy="35" r="3" fill="#2c3e50"/><circle cx="50" cy="35" r="3" fill="#2c3e50"/><path d="M35 45 Q40 50 45 45" stroke="#2c3e50" stroke-width="2" fill="none"/><line x1="75" y1="20" x2="75" y2="80" stroke="#8e44ad" stroke-width="4"/><circle cx="75" cy="20" r="8" fill="#e74c3c"/></g></svg>`,
        cat_berserk: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#c0392b" stroke="#2c3e50" stroke-width="2"/><line x1="25" y1="30" x2="35" y2="38" stroke="#000" stroke-width="2"/><line x1="55" y1="30" x2="45" y2="38" stroke="#000" stroke-width="2"/><path d="M35 50 Q40 45 45 50" stroke="#2c3e50" stroke-width="2" fill="none"/><path d="M80 40 L80 70 M70 40 L90 40 L80 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/><path d="M0 40 L0 70 M-10 40 L10 40 L0 50 Z" fill="#7f8c8d" stroke="#000" stroke-width="1"/></g></svg>`,
        cat_blood: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><circle cx="40" cy="40" r="30" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M20 20 L10 0 L35 15 Z" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M60 20 L70 0 L45 15 Z" fill="#2c3e50" stroke="#c0392b" stroke-width="2"/><path d="M25 35 Q30 25 35 35" stroke="#e74c3c" stroke-width="3" fill="none"/><path d="M45 35 Q50 25 55 35" stroke="#e74c3c" stroke-width="3" fill="none"/><circle cx="30" cy="38" r="2" fill="#e74c3c"/><circle cx="50" cy="38" r="2" fill="#e74c3c"/><path d="M70 50 Q80 20 50 10" stroke="#c0392b" stroke-width="4" fill="none"/><line x1="70" y1="50" x2="80" y2="80" stroke="#95a5a6" stroke-width="3"/></g></svg>`,
        cat_mech: `<svg viewBox="0 0 100 100"><g transform="translate(10,10)"><path d="M15 20 L65 20 L75 35 L75 70 L50 80 L25 70 L5 70 L5 35 Z" fill="#7f8c8d" stroke="#34495e" stroke-width="2"/><rect x="15" y="35" width="50" height="10" fill="#3498db"/><line x1="10" y1="20" x2="5" y2="0" stroke="#34495e" stroke-width="3"/><line x1="70" y1="20" x2="75" y2="0" stroke="#34495e" stroke-width="3"/><rect x="75" y="50" width="20" height="10" fill="#2c3e50"/><circle cx="95" cy="55" r="3" fill="#e74c3c"/></g></svg>`,
        monster_slime: `<svg viewBox="0 0 100 100"><path d="M20 80 Q20 20 50 20 Q80 20 80 80 Z" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/><circle cx="40" cy="50" r="5" fill="#000"/><circle cx="60" cy="50" r="5" fill="#000"/></svg>`,
        monster_bat: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="15" fill="#34495e"/><path d="M35 50 Q10 20 10 50 Q20 70 35 55" fill="#34495e"/><path d="M65 50 Q90 20 90 50 Q80 70 65 55" fill="#34495e"/><circle cx="45" cy="50" r="2" fill="#e74c3c"/><circle cx="55" cy="50" r="2" fill="#e74c3c"/></svg>`,
        monster_dragon: `<svg viewBox="0 0 100 100"><path d="M30 60 Q30 30 50 20 Q70 30 70 60" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/><path d="M50 20 L50 5" stroke="#e74c3c" stroke-width="4"/><circle cx="40" cy="45" r="4" fill="#f1c40f"/><circle cx="60" cy="45" r="4" fill="#f1c40f"/><path d="M40 70 Q50 80 60 70" stroke="#000" stroke-width="2" fill="none"/></svg>`,
        monster_evil_dragon: `<svg viewBox="0 0 100 100"><path d="M20 70 Q40 20 80 30 Q90 50 70 80 Q50 90 20 70 Z" fill="#2c3e50" stroke="#000" stroke-width="2"/><path d="M80 30 Q95 10 90 5 Q70 15 60 35" fill="#c0392b"/><path d="M30 40 Q40 50 30 60" stroke="#c0392b" stroke-width="3" fill="none"/><circle cx="65" cy="45" r="3" fill="#e74c3c"/><circle cx="75" cy="55" r="3" fill="#e74c3c"/><path d="M10 60 Q20 40 10 20" stroke="#2c3e50" stroke-width="4" fill="none"/></svg>`,
        stake: `<svg viewBox="0 0 100 100"><rect x="35" y="20" width="30" height="70" fill="#d35400" stroke="#5d4037" stroke-width="2"/><circle cx="50" cy="40" r="8" fill="#fff" opacity="0.8"/><circle cx="50" cy="40" r="3" fill="#000"/><path d="M35 20 L50 5 L65 20 Z" fill="#d35400" stroke="#5d4037" stroke-width="2"/></svg>`
    };

    const CLASSES = [
        {
            id: 'resolute', name: 'åšæ¯…çŒ«', svg: SVGS.cat_resolute, color: '#95a5a6',
            base: { atk: 32, mp: 5, def: 25, hp: 200, spd: 10 },
            growth: { atk: 3, mp: 1, def: 15, hp: 50, spd: 1 },
            talent: 'ã€è†æ£˜ç”²å£³ã€‘è‹¥[çŒ«å¾¡]â‰¥[çŒ«å¨]x2åå¼¹[çŒ«å¾¡]x1ä¼¤å®³ï¼›è‹¥â‰¥x5ï¼Œåå¼¹[çŒ«å¾¡]x2+[çŒ«è¡€]x0.2ä¼¤å®³ã€‚åä¼¤å¯è§¦å‘æš´å‡»ã€‚'
        },
        {
            id: 'agile', name: 'çµæ´»çŒ«', svg: SVGS.cat_agile, color: '#f1c40f',
            base: { atk: 40, mp: 8, def: 10, hp: 80, spd: 20 },
            growth: { atk: 10, mp: 2, def: 3, hp: 20, spd: 4 },
            talent: 'ã€è¿…æ·è¿å‡»ã€‘æ”»å‡»åè¿½åŠ ä¸€æ®µ[çŒ«é€Ÿ]x1çš„çœŸå®ä¼¤å®³(ä¸çˆ†å‡»)ã€‚æ¯å‡10çº§ç³»æ•°+0.2ã€‚'
        },
        {
            id: 'wise', name: 'æ™ºæ…§çŒ«', svg: SVGS.cat_wise, color: '#9b59b6',
            base: { atk: 45, mp: 20, def: 10, hp: 70, spd: 10 },
            growth: { atk: 15, mp: 10, def: 3, hp: 18, spd: 2 },
            talent: 'ã€å¥¥æœ¯è¶…è½½ã€‘æ¶ˆè€—10%[çŒ«èƒ½]å¢ä¼¤ï¼Œ1ç‚¹[çŒ«èƒ½]å¢åŠ 1%ä¼¤å®³ã€‚è‡´æ­»æ—¶æ¶ˆè€—[çŒ«èƒ½]æŠµæŒ¡ä¼¤å®³(å•åœºé™1æ¬¡)ã€‚'
        },
        {
            id: 'berserk', name: 'ç‹‚æš´çŒ«', svg: SVGS.cat_berserk, color: '#c0392b',
            base: { atk: 50, mp: 6, def: 8, hp: 100, spd: 15 },
            growth: { atk: 20, mp: 1, def: 3, hp: 25, spd: 2 },
            talent: 'ã€é²œè¡€æ¸´æœ›ã€‘æ¶ˆè€—20%[çŒ«è¡€]æ”»å‡»ï¼Œè¡€è¶Šå°‘ä¼¤è¶Šé«˜ï¼Œå¸¦10%å¸è¡€ã€‚'
        },
        {
            id: 'blood', name: 'è¡€éª‘çŒ«', svg: SVGS.cat_blood, color: '#8e44ad',
            base: { atk: 25, mp: 6, def: 12, hp: 200, spd: 10 },
            growth: { atk: 12, mp: 1, def: 3, hp: 50, spd: 1 },
            talent: 'ã€é­”è¡€å¥”æ¶Œã€‘æ¯ç§’ç¼çƒ§æ•Œæ–¹([çŒ«å¨]x0.8+[çŒ«è¡€]x0.2)ç‚¹çœŸå®ä¼¤å®³ï¼Œè¯¥ä¼¤å®³ä¸å¯çˆ†å‡»ã€‚'
        },
        {
            id: 'mech', name: 'æœºæ¢°çŒ«', svg: SVGS.cat_mech, color: '#34495e',
            base: { atk: 30, mp: 12, def: 25, hp: 120, spd: 0 },
            growth: { atk: 15, mp: 4, def: 3, hp: 20, spd: 0 },
            talent: 'ã€CAAATÎ©ç«ç®­å¼¹ã€‘æ— æ³•æ™®æ”»/äº«å—çŒ«é€Ÿã€‚æ¯0.2ç§’æ¶ˆè€—3%å½“å‰[çŒ«èƒ½]é€ æˆ[çŒ«å¨]x0.25+å‰©ä½™[çŒ«èƒ½]x0.75ä¼¤å®³ï¼Œå¯çˆ†å‡»ã€‚'
        }
    ];

    const CARDS = [
        { type: 'white', icon: 'âš”ï¸', title: 'åŠ›é‡è®­ç»ƒ', desc: 'çŒ«å¨ +10', effect: (p) => { p.atk += 10; } },
        { type: 'white', icon: 'â¤ï¸', title: 'ä½“èƒ½å¼ºåŒ–', desc: 'çŒ«è¡€ +60', effect: (p) => { p.maxHp += 60; p.hp += 60; } },
        { type: 'white', icon: 'ğŸ›¡ï¸', title: 'ç¡¬åŒ–çš®æ¯›', desc: 'çŒ«å¾¡ +10', effect: (p) => { p.def += 10; } },
        { type: 'white', icon: 'âš¡', title: 'æ•æ·æ­¥ä¼', desc: 'çŒ«é€Ÿ +5', effect: (p) => { p.spd += 5; } },
        { type: 'white', icon: 'ğŸ’§', title: 'å†¥æƒ³', desc: 'çŒ«èƒ½ +5', effect: (p) => { p.mp += 5; p.maxMp += 5; } },
        
        { type: 'green', icon: 'ğŸ¯', title: 'å¼±ç‚¹çœ‹ç ´', desc: 'æš´å‡»ç‡ +5%', effect: (p) => { p.critRate += 0.05; } },
        { type: 'green', icon: 'ğŸ’¥', title: 'è‡´å‘½ä¸€å‡»', desc: 'çˆ†ä¼¤ +10%', effect: (p) => { p.critDmg += 0.1; } },
        { type: 'green', icon: 'ğŸ’š', title: 'ç”Ÿå‘½æºæ³‰', desc: 'çŒ«è¡€ +200', effect: (p) => { p.maxHp += 200; p.hp += 200; } },
        { type: 'green', icon: 'ğŸ”°', title: 'é’¢é“æ„å¿—', desc: 'çŒ«å¾¡ +40', effect: (p) => { p.def += 40; } },
        { type: 'green', icon: 'ğŸ‘Ÿ', title: 'æé€Ÿ', desc: 'çŒ«é€Ÿ +12', effect: (p) => { p.spd += 12; } },
        { type: 'green', icon: 'ğŸ§ª', title: 'é­”åŠ›æ‰©å®¹', desc: 'çŒ«èƒ½ +15', effect: (p) => { p.mp += 15; p.maxMp += 15; } },
        
        { type: 'blue', minLvl: 100, icon: 'ğŸ‘ï¸', title: 'é¹°çœ¼', desc: 'æš´å‡» +8%', effect: (p) => { p.critRate += 0.08; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ’£', title: 'æ¯ç­æ‰“å‡»', desc: 'çˆ†ä¼¤ +20%', effect: (p) => { p.critDmg += 0.2; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ’—', title: 'æ³°å¦ä¹‹å¿ƒ', desc: 'çŒ«è¡€ +500', effect: (p) => { p.maxHp += 500; p.hp += 500; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸ°', title: 'ä¸åŠ¨å¦‚å±±', desc: 'çŒ«å¾¡ +80', effect: (p) => { p.def += 80; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸš€', title: 'å…‰é€Ÿ', desc: 'çŒ«é€Ÿ +20', effect: (p) => { p.spd += 20; } },
        { type: 'blue', minLvl: 100, icon: 'ğŸŒŒ', title: 'è™šç©ºé­”èƒ½', desc: 'çŒ«èƒ½ +30', effect: (p) => { p.mp += 30; p.maxMp += 30; } },
        
        { type: 'blue', minLvl: 100, unique: true, id: 'heal_kill', icon: 'ğŸ§›', title: 'ä»¥æˆ˜å…»æˆ˜', desc: 'èƒœåˆ©å›å¤60%æŸè€—', effect: (p) => { p.hasHealKill = true; } },
        { type: 'blue', minLvl: 100, unique: true, id: 'low_hp_spd', icon: 'ğŸ”¥', title: 'èƒŒæ°´ä¸€æˆ˜', desc: 'ä½è¡€é‡åŠ çŒ«é€Ÿ', effect: (p) => { p.hasLowHpSpd = true; } },
    ];

    let player = null;
    let enemy = null;
    let gameLevel = 1;
    let killCount = 0;
    let stageCount = 0; 
    let stageType = 'minion'; 
    let isPlayerTurn = true;
    let isPendingRogue = false;
    let selectedRogueCard = null;
    let isFirstRogue = false;
    let isGameActive = false;
    let currentSlotId = null;
    let lastBossType = null;
    
    let bloodInterval = null;
    let mechInterval = null;
    let battleLoopId = null; 
    
    let isTestingDamage = false;
    let testTimer = 0;
    let testTotalDamage = 0;
    let testInterval = null;

    const layers = {
        start: document.getElementById('startLayer'),
        slot: document.getElementById('slotLayer'),
        name: document.getElementById('nameInputLayer'),
        select: document.getElementById('classLayer'),
        battle: document.getElementById('battleLayer'),
        card: document.getElementById('cardLayer'),
        over: document.getElementById('gameOverLayer'),
        changelog: document.getElementById('changelogLayer'),
        attr: document.getElementById('attrLayer')
    };
    const logs = document.getElementById('battleLog');

    window.onload = function() {
        const legacySave = localStorage.getItem('bigCatQuestSave');
        const slot0 = localStorage.getItem('bigCatQuest_slot_0');
        if (legacySave && !slot0) {
            localStorage.setItem('bigCatQuest_slot_0', legacySave);
        }
        checkSave();
        
        const slider = document.getElementById('changelogBox');
        let isDown = false; let startY; let scrollTop;
        if (slider) {
            slider.addEventListener('mousedown', (e) => { isDown = true; startY = e.pageY - slider.offsetTop; scrollTop = slider.scrollTop; });
            slider.addEventListener('mouseleave', () => { isDown = false; });
            slider.addEventListener('mouseup', () => { isDown = false; });
            slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const y = e.pageY - slider.offsetTop; const walk = (y - startY) * 2; slider.scrollTop = scrollTop - walk; });
        }
    };

    function showLayer(name) {
        Object.values(layers).forEach(l => {
            if(l) l.classList.remove('active');
        });
        if(layers[name]) layers[name].classList.add('active');
        else console.error("Layer not found: " + name);
    }

    function log(msg, color = '#333') {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = msg;
        div.style.color = color;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    function floatText(text, targetEl, color='red', fontSize='22px') {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = text;
        el.style.color = color;
        el.style.fontSize = fontSize;
        el.style.marginLeft = '0px'; 
        targetEl.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function showSlash(targetEl) {
        const el = document.createElement('div');
        el.className = 'slash-effect';
        targetEl.appendChild(el);
        setTimeout(() => el.remove(), 300);
    }

    let slotMode = 'load';

    function openSlotMenu(mode) {
        slotMode = mode;
        const container = document.getElementById('slotList');
        const title = document.getElementById('slotTitle');
        title.innerText = mode === 'load' ? "è¯»å–å­˜æ¡£" : "é€‰æ‹©å­˜æ¡£æ§½ä½";
        container.innerHTML = '';
        currentSlotId = null;

        for(let i=0; i<3; i++) {
            const saveStr = localStorage.getItem(`bigCatQuest_slot_${i}`);
            const el = document.createElement('div');
            el.className = 'save-slot';
            
            if (saveStr) {
                const data = JSON.parse(saveStr);
                const cls = CLASSES.find(c => c.id === data.clsId);
                const clsIcon = cls ? cls.svg : 'â“';
                const clsName = cls ? cls.name : 'æœªçŸ¥';
                
                el.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="slot-icon">${clsIcon}</div>
                        <div class="slot-info">
                            <div class="slot-title">${clsName} <span style="font-size:12px; color:#27ae60">Lv.${data.player.lvl}</span></div>
                            <div class="slot-detail">ç¬¬ ${data.gameLevel} å±‚ | ${data.timestamp.split(' ')[0]}</div>
                        </div>
                    </div>
                `;
                const delBtn = document.createElement('div');
                delBtn.innerHTML = 'ğŸ—‘ï¸';
                delBtn.className = 'delete-btn';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ")) {
                        localStorage.removeItem(`bigCatQuest_slot_${i}`);
                        openSlotMenu(mode); 
                    }
                };
                el.appendChild(delBtn);

                el.onclick = () => {
                    // [ä¿®å¤] ç‚¹å‡»å³è§¦å‘
                    currentSlotId = i;
                    if (mode === 'load') {
                        loadGameFromSlot(data);
                    } else {
                        if(confirm("è¯¥æ§½ä½å·²æœ‰å­˜æ¡£ï¼Œç¡®å®šè¦†ç›–å—ï¼Ÿ")) {
                            showLayer('name'); 
                        }
                    }
                };
            } else {
                el.className += ' empty';
                el.innerHTML = '<div>+ ç©ºæ§½ä½</div>';
                el.onclick = () => {
                    // [ä¿®å¤] ç‚¹å‡»å³è§¦å‘
                    currentSlotId = i;
                    showLayer('name'); 
                };
            }
            container.appendChild(el);
        }
        showLayer('slot'); 
    }

    function goToClassSelection() {
        const name = document.getElementById('playerNameInput').value.trim();
        if (!name) { alert("å¤§ä¾ è¯·ç•™åï¼"); return; }
        
        const container = document.getElementById('classContainer');
        container.innerHTML = '';
        CLASSES.forEach(cls => {
            const card = document.createElement('div');
            card.className = 'class-card';
            card.innerHTML = `
                <div class="svg-icon">${cls.svg}</div>
                <h3 style="color:${cls.color}">${cls.name}</h3>
                <div class="stats-text">
                    å¨: ${cls.base.atk} <span style="color:#27ae60">(+${cls.growth.atk})</span> èƒ½: ${cls.base.mp} <span style="color:#27ae60">(+${cls.growth.mp})</span><br>
                    å¾¡: ${cls.base.def} <span style="color:#27ae60">(+${cls.growth.def})</span> è¡€: ${cls.base.hp} <span style="color:#27ae60">(+${cls.growth.hp})</span><br>
                    é€Ÿ: ${cls.base.spd} <span style="color:#27ae60">(+${cls.growth.spd})</span>
                </div>
                <div class="talent-text">${cls.talent}</div>
            `;
            // [ä¿®å¤] ç‚¹å‡»å³è§¦å‘
            card.onclick = () => initGame(name, cls);
            container.appendChild(card);
        });
        showLayer('select');
    }

    function initGame(name, cls) {
        player = {
            name: name,
            cls: cls,
            lvl: 1,
            exp: 0,
            maxExp: 2,
            maxHp: cls.base.hp, hp: cls.base.hp,
            maxMp: cls.base.mp, mp: cls.base.mp,
            atk: cls.base.atk, def: cls.base.def, spd: cls.base.spd,
            critRate: 0, critDmg: 1.5,
            shieldUsed: false,
            uniqueCards: [],
            hasHealKill: false,
            hasLowHpSpd: false
        };
        gameLevel = 1;
        killCount = 0;
        stageCount = 0;
        stageType = 'minion';
        lastBossType = null;
        
        document.getElementById('pName').innerText = player.name;
        document.getElementById('pVisual').innerHTML = cls.svg;
        
        saveGame();
        log("å†’é™©å¼€å§‹ï¼", '#f39c12');
        showRogueSelection(true); 
    }

    function saveGame(manual = false) {
        if (!player || currentSlotId === null) return;
        const saveData = {
            player: player,
            clsId: player.cls.id, 
            gameLevel: gameLevel,
            killCount: killCount,
            stageCount: stageCount,
            stageType: stageType,
            lastBossType: lastBossType,
            timestamp: new Date().toLocaleString()
        };
        localStorage.setItem(`bigCatQuest_slot_${currentSlotId}`, JSON.stringify(saveData));
        if (manual) { alert("å­˜æ¡£æˆåŠŸï¼"); } 
    }

    function checkSave() {
        let hasSave = false;
        for(let i=0; i<3; i++) {
            if(localStorage.getItem(`bigCatQuest_slot_${i}`)) hasSave = true;
        }
        document.getElementById('continueBtn').disabled = !hasSave;
    }
    
    function loadGame() {
        openSlotMenu('load');
    }

    function loadGameFromSlot(data) {
        // è¯»æ¡£ä¿æŠ¤
        if (!data || !data.player) {
            alert("å­˜æ¡£æ•°æ®æŸåï¼Œæ— æ³•è¯»å–ï¼");
            return;
        }
        
        player = data.player;
        player.cls = CLASSES.find(c => c.id === data.clsId);
        
        if (!player.cls) {
            alert("èŒä¸šæ•°æ®ä¸¢å¤±ï¼Œå­˜æ¡£ä¸å¯ç”¨ï¼");
            return;
        }

        gameLevel = data.gameLevel;
        killCount = data.killCount;
        stageCount = data.stageCount;
        stageType = data.stageType;
        lastBossType = data.lastBossType || null;
        
        if(player.critRate === undefined) player.critRate = 0;
        if(player.critDmg === undefined) player.critDmg = 1.5;
        if(player.uniqueCards === undefined) player.uniqueCards = [];
        
        // [Ver3.10] åæ¡£è‡ªåŠ¨ä¿®å¤
        if (player.hp <= 0) {
            player.hp = player.maxHp;
            log("âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸æ­»äº¡å­˜æ¡£ï¼Œå·²è‡ªåŠ¨å¤æ´»ã€‚", "#e74c3c");
        }
        
        document.getElementById('pName').innerText = player.name;
        document.getElementById('pVisual').innerHTML = player.cls.svg;
        updateUI();
        showLayer('battle');
        log("ã€ç³»ç»Ÿã€‘æ¬¢è¿å›æ¥ï¼Œå†’é™©ç»§ç»­ï¼", '#27ae60');
        
        if(battleLoopId) clearTimeout(battleLoopId);
        if(bloodInterval) clearInterval(bloodInterval);
        if(mechInterval) clearInterval(mechInterval);
        
        startNextBattle();
    }

    function goToMainMenu() {
        if(confirm("ç¡®å®šè¦è¿”å›ä¸»èœå•å—ï¼Ÿè¿›åº¦å°†è‡ªåŠ¨ä¿å­˜ã€‚")) {
            saveGame();
            isGameActive = false;
            if(bloodInterval) clearInterval(bloodInterval);
            if(mechInterval) clearInterval(mechInterval);
            if(battleLoopId) clearTimeout(battleLoopId);
            checkSave(); 
            showLayer('start');
        }
    }

    function startNextBattle() {
        isGameActive = true;
        if(bloodInterval) clearInterval(bloodInterval);
        if(mechInterval) clearInterval(mechInterval);
        if(battleLoopId) clearTimeout(battleLoopId);

        if (isPendingRogue) {
            isPendingRogue = false;
            showRogueSelection();
            return;
        }

        player.shieldUsed = false; 
        generateEnemy();
        updateUI();
        
        let titleColor = '#3498db';
        if (stageType === 'evil_dragon') titleColor = '#c0392b';
        log(`<br><strong style="color:${titleColor}">=== ç¬¬ ${gameLevel} å±‚ ===</strong>`);
        log(`é­é‡äº† ${enemy.name}!`, '#e74c3c');

        if (player.cls.id === 'blood') {
            log("[é­”è¡€å¥”æ¶Œ] å¼€å¯ï¼Œæ¯ç§’ç¼çƒ§æ•Œäººï¼", "#8e44ad");
            bloodInterval = setInterval(() => {
                if (!isGameActive) return;
                if (player.hp > 0 && enemy.hp > 0) {
                    let dot = Math.floor(player.atk * 0.8 + player.hp * 0.2);
                    enemy.hp -= dot;
                    floatText(`-${dot}`, document.getElementById('enemyEl'), '#8e44ad', '20px');
                    updateUI();
                    if (enemy.hp <= 0) checkResult();
                }
            }, 1000);
        }

        if (player.cls.id === 'mech') {
            log("[CAAATÎ©ç«ç®­å¼¹] å¯åŠ¨ï¼Œå¼¹å¹•å‹åˆ¶ï¼", "#34495e");
            mechInterval = setInterval(() => {
                if (!isGameActive) return;
                if (player.hp > 0 && enemy.hp > 0) {
                    let cost = Math.floor(player.mp * 0.02); 
                    if (player.mp > 0) {
                        player.mp -= cost;
                        if(player.mp < 0) player.mp = 0;
                        let dmgBase = player.atk * 0.25 + player.mp * 0.75;
                        let isCrit = Math.random() < player.critRate;
                        let finalDmg = Math.max(1, Math.floor(dmgBase * (isCrit ? player.critDmg : 1)));
                        enemy.hp -= finalDmg;
                        let color = isCrit ? '#e74c3c' : '#fff';
                        if(isCrit) log(`[Î©ç«ç®­] æš´å‡»! é€ æˆ ${finalDmg} ä¼¤å®³`, '#c0392b'); 
                        floatText(finalDmg, document.getElementById('enemyEl'), color, '16px');
                        updateUI();
                        if (enemy.hp <= 0) checkResult();
                    } else {
                        let charge = Math.max(1, Math.floor(player.maxMp * 0.05));
                        player.mp += charge;
                        log(`[ç³»ç»Ÿ] èƒ½æºè€—å°½ï¼Œç´§æ€¥å……èƒ½ ${charge} ç‚¹`, '#2980b9');
                        updateUI();
                    }
                }
            }, 200);
        }

        if (player.cls.id !== 'mech') {
            let effectiveSpd = player.spd;
            if (player.hasLowHpSpd) {
                let missingPct = (player.maxHp - player.hp) / player.maxHp;
                let boost = Math.min(0.6, missingPct);
                effectiveSpd = Math.floor(player.spd * (1 + boost));
            }
            isPlayerTurn = effectiveSpd >= enemy.spd;
            battleLoopId = setTimeout(battleLoop, 800);
        } else {
            battleLoopId = setTimeout(battleLoop, 800);
        }
    }

    function generateEnemy() {
        if (gameLevel % 100 === 0) {
            stageType = 'evil_dragon';
            stageCount = 0; 
        } else if (stageCount >= 5) {
            if (stageType === 'minion') stageType = 'elite'; 
        } else { stageType = 'minion'; }
        
        if (stageType === 'boss' || stageType === 'evil_dragon') { stageType = 'minion'; stageCount = 0; }
        if (!player.eliteKills) player.eliteKills = 0;
        
        if (gameLevel % 100 === 0) {
            stageType = 'evil_dragon';
        } else if (stageCount >= 5) {
            if ((player.eliteKills + 1) % 5 === 0 && player.eliteKills > 0) stageType = 'boss';
            else stageType = 'elite';
        }

        let baseHp = 80 + (gameLevel * 25);
        let baseAtk = 15 + (gameLevel * 4);
        let baseDef = 5 + (gameLevel * 1); 
        let baseSpd = 10 + (gameLevel * 1.5); 

        let typeName = 'å°æ€ª';
        let svg = SVGS.monster_slime;
        let hpMult = 1.0, atkMult = 1.0, defMult = 1.0;

        if (stageType === 'elite') { 
            typeName = 'ã€ç²¾è‹±ã€‘'; svg = SVGS.monster_bat; hpMult = 2.5; atkMult = 1.3; defMult = 1.2; 
        } else if (stageType === 'boss') { 
            typeName = 'ã€é­”ç‹ã€‘'; svg = SVGS.monster_dragon; hpMult = 5.5; atkMult = 1.5; defMult = 1.4; 
        } else if (stageType === 'evil_dragon') {
            typeName = 'ã€é‚ªé¾™ã€‘'; svg = SVGS.monster_evil_dragon; hpMult = 7.0; atkMult = 1.7; defMult = 1.6;
            log("ä¸€è‚¡è¿œå¤çš„é‚ªæ¶æ°”æ¯æ‰‘é¢è€Œæ¥...", "#c0392b");
        }

        enemy = {
            name: typeName,
            type: stageType, 
            maxHp: Math.floor(baseHp * hpMult * (0.9 + Math.random()*0.2)),
            hp: 0,
            atk: Math.floor(baseAtk * atkMult),
            def: Math.floor(baseDef * defMult),
            spd: Math.floor(baseSpd),
            visual: svg
        };
        enemy.hp = enemy.maxHp;
        
        document.getElementById('eName').innerText = enemy.name;
        document.getElementById('eVisual').innerHTML = enemy.visual;
    }

    function battleLoop() {
        if (!isGameActive) return;
        if (!isTestingDamage && (player.hp <= 0 || enemy.hp <= 0)) return;
        
        if (enemy.hp <= 0) { checkResult(); return; }
        if (player.hp <= 0) { checkResult(); return; }

        if (player.cls.id === 'mech') {
            performEnemyAttack();
        } else {
            if (isPlayerTurn) performPlayerAttack();
            else performEnemyAttack();
        }
    }

    function performPlayerAttack() {
        const pEl = document.getElementById('playerEl');
        pEl.style.transform = 'translateX(30px)';
        battleLoopId = setTimeout(() => pEl.style.transform = 'translateX(0)', 200);
        showSlash(document.getElementById('enemyEl'));

        if (player.cls.id === 'wise') {
            let rec = Math.ceil(player.maxMp * 0.05);
            player.mp = Math.min(player.maxMp, player.mp + rec);
        }

        let dmgMult = 1.0;
        let extraDmg = 0;
        let selfDmg = 0;
        
        if (player.cls.id === 'wise') {
            let cost = Math.floor(player.mp * 0.1);
            if (cost > 0) { player.mp -= cost; dmgMult += cost * 0.01; if(!isTestingDamage) log(`[å¥¥æœ¯] è€— ${cost} èƒ½, å¢ä¼¤ ${(cost*1).toFixed(0)}%`, '#9b59b6'); }
        }
        if (player.cls.id === 'berserk') {
            let cost = Math.floor(player.hp * 0.2);
            selfDmg = cost;
            let missingPct = (player.maxHp - player.hp)/player.maxHp * 100;
            dmgMult += missingPct * 0.01;
            if(!isTestingDamage) log(`[è¡€æ€’] è€— ${cost} è¡€, å¢ä¼¤ ${missingPct.toFixed(0)}%`, '#c0392b');
        }
        if (player.cls.id === 'agile') {
            extraDmg += player.spd * (1 + Math.floor(player.lvl/10)*0.2);
        }

        let isCrit = Math.random() < player.critRate;
        let finalMult = dmgMult;
        if (isCrit) finalMult *= player.critDmg;

        let dmg = Math.max(1, Math.floor(player.atk * finalMult - enemy.def + extraDmg));
        enemy.hp -= dmg;
        
        if(isTestingDamage) testTotalDamage += dmg;

        let floatColor = isCrit ? '#e74c3c' : '#fff';
        let floatSize = isCrit ? '32px' : '22px';
        let floatMsg = isCrit ? `æš´å‡»! ${dmg}` : dmg;
        floatText(floatMsg, document.getElementById('enemyEl'), floatColor, floatSize);
        
        if(!isTestingDamage) log(isCrit ? `âš¡ã€æš´å‡»ã€‘é€ æˆäº† ${dmg} ç‚¹å·¨é¢ä¼¤å®³!` : `ä½ å¯¹ ${enemy.name} é€ æˆ ${dmg} ç‚¹ä¼¤å®³ã€‚`);

        if (enemy.hp <= 0 && !isTestingDamage) {
            checkResult();
            return;
        }

        if (player.cls.id === 'agile' && enemy.hp > 0) {
            let spdCoef = 1.0 + Math.floor(player.lvl/10)*0.2;
            let extra = Math.floor(player.spd * spdCoef);
            battleLoopId = setTimeout(() => {
                if(enemy.hp <= 0) return;
                enemy.hp -= extra;
                if(isTestingDamage) testTotalDamage += extra;
                floatText("+" + extra, document.getElementById('enemyEl'), '#f1c40f', '28px');
                if(!isTestingDamage) log(`[è¿…æ·] è¿½åŠ  ${extra} çœŸä¼¤`);
                updateUI();
                if (!isTestingDamage && enemy.hp <= 0) checkResult();
                else checkMultiHit(); 
            }, 300);
        } else {
            if (selfDmg > 0) {
                player.hp -= selfDmg;
                let drain = Math.floor(dmg * 0.1);
                player.hp += drain;
                if(!isTestingDamage) floatText(`+${drain}`, document.getElementById('playerEl'), '#2ecc71', '16px');
                if(!isTestingDamage) log(`å¸è¡€æ¢å¤ ${drain} çŒ«è¡€`, '#2ecc71');
            }
            updateUI();
            if (enemy.hp > 0) checkMultiHit();
            else if (!isTestingDamage) checkResult();
        }
    }
    
    function checkMultiHit() {
        if(!isGameActive) return;

        let effectiveSpd = player.spd;
        if (player.hasLowHpSpd) {
             let missingPct = (player.maxHp - player.hp) / player.maxHp;
             effectiveSpd = Math.floor(player.spd * (1 + Math.min(0.6, missingPct)));
        }

        if (effectiveSpd >= enemy.spd * 2 && Math.random() > 0.4) {
            if(!isTestingDamage) log(">>> [çŒ«é€Ÿ]ç¢¾å‹ï¼å‘åŠ¨è¿å‡»ï¼ <<<", '#f39c12');
            battleLoopId = setTimeout(performPlayerAttack, 600);
        } else {
            isPlayerTurn = false;
            battleLoopId = setTimeout(battleLoop, 1000);
        }
    }

    function performEnemyAttack() {
        const eEl = document.getElementById('enemyEl');
        eEl.style.transform = 'translateX(-30px)';
        battleLoopId = setTimeout(() => eEl.style.transform = 'translateX(0)', 200);
        showSlash(document.getElementById('playerEl'));

        // [Ver3.06] ç©¿é€æœºåˆ¶è°ƒæ•´
        let rawDmg = enemy.atk - player.def;
        let minRate = 0.1; 
        if(stageType === 'elite') minRate = 0.25;
        if(stageType === 'boss') minRate = 0.40;
        if(stageType === 'evil_dragon') minRate = 0.40;

        let minDmg = Math.floor(enemy.atk * minRate);
        let dmg = Math.max(minDmg, rawDmg);
        dmg = Math.max(1, dmg);
        
        if (player.hp - dmg <= 0 && player.cls.id === 'wise' && player.mp > 0 && !player.shieldUsed) {
            let needBlock = dmg - (player.hp - 1);
            let manaCost = Math.ceil(needBlock / 2);
            if (player.mp >= manaCost) {
                player.mp -= manaCost;
                dmg -= needBlock;
                player.shieldUsed = true; 
                if(!isTestingDamage) log("ğŸ›¡ï¸ [å¥¥æœ¯è¶…è½½] æŠ¤ç›¾æŠµæŒ¡äº†è‡´å‘½ä¼¤! (æœ¬æˆ˜é™1æ¬¡)", '#3498db');
            }
        }

        player.hp -= dmg;
        floatText(dmg, document.getElementById('playerEl'), '#c0392b');
        if(!isTestingDamage) log(`å—åˆ° ${dmg} ä¼¤å®³ã€‚`);
        
        updateUI();

        // ç«‹å³æ£€æŸ¥æ­»äº¡ï¼Œé˜»æ–­åç»­
        if (player.hp <= 0 && !isTestingDamage) {
            checkResult();
            return; 
        }

        if (stageType === 'evil_dragon' && player.hp > 0) {
            let dragonBreathDmg = Math.floor(player.maxHp * 0.07);
            if (dragonBreathDmg > 0) {
                battleLoopId = setTimeout(() => {
                    player.hp -= dragonBreathDmg;
                    floatText(dragonBreathDmg, document.getElementById('playerEl'), '#f1c40f', '24px'); 
                    if(!isTestingDamage) log(`ğŸ”¥ [é¾™æ¯] é‚ªé¾™å–·åé¾™æ¯ï¼Œé€ æˆ ${dragonBreathDmg} ç‚¹çœŸå®ä¼¤å®³!`, '#c0392b');
                    updateUI();
                    if (!isTestingDamage && player.hp <= 0) checkResult();
                }, 400);
            }
        }
        
        if (player.cls.id === 'resolute' && player.hp > 0) {
            let reflect = 0;
            if (player.def >= player.atk * 5) {
                reflect = player.def * 2 + player.hp * 0.2;
                if(!isTestingDamage) log(`[è†æ£˜ç”²å£³] è§¦å‘é«˜é˜¶åä¼¤!`, '#f1c40f');
            } else if (player.def >= player.atk * 2) {
                reflect = player.def;
                if(!isTestingDamage) log(`[è†æ£˜ç”²å£³] è§¦å‘åä¼¤!`, '#f1c40f');
            }
            if (reflect > 0) {
                let isCrit = Math.random() < player.critRate;
                let finalReflect = reflect * (isCrit ? player.critDmg : 1);
                let actualDmg = Math.max(1, Math.floor(finalReflect - enemy.def));
                
                battleLoopId = setTimeout(() => {
                    enemy.hp -= actualDmg;
                    if(isTestingDamage) testTotalDamage += actualDmg;
                    let color = isCrit ? '#e74c3c' : '#e67e22';
                    let msg = isCrit ? `åä¼¤æš´å‡»! ${actualDmg}` : `åä¼¤${actualDmg}`;
                    floatText(msg, document.getElementById('enemyEl'), color);
                    if(!isTestingDamage) log(`[è†æ£˜] åå¼¹é€ æˆ ${actualDmg} ä¼¤å®³!`, color);
                    updateUI();
                    if (!isTestingDamage) checkResult();
                }, 300);
            } else {
                if (!isTestingDamage) checkResult();
            }
        } else {
            if (!isTestingDamage && player.hp > 0) checkResult();
        }

        if (player.hp > 0 && enemy.hp > 0) {
            isPlayerTurn = true;
            battleLoopId = setTimeout(battleLoop, 800);
        }
    }

    function checkResult() {
        if(enemy.hp <= 0 && document.getElementById('eName').innerText !== "å·²å‡»è´¥") {
            if(bloodInterval) clearInterval(bloodInterval);
            if(mechInterval) clearInterval(mechInterval);
            if(battleLoopId) clearTimeout(battleLoopId);

            let rawName = enemy.name;
            document.getElementById('eName').innerText = "å·²å‡»è´¥";
            log(`${rawName} å€’ä¸‹äº†!`, '#27ae60');
            killCount++;
            stageCount++; 
            
            let gainExp = player.lvl + 1;
            player.exp += gainExp;
            while (player.exp >= player.maxExp) {
                player.exp -= player.maxExp;
                levelUp();
            }
            
            let healHp = Math.floor(player.maxHp * 0.1);
            if(player.hasHealKill) {
                 healHp += Math.floor((player.maxHp - player.hp) * 0.6);
                 let healMp = Math.floor((player.maxMp - player.mp) * 0.6);
                 player.mp += healMp;
            }
            player.hp = Math.min(player.maxHp, player.hp + healHp);
            log(`èƒœåˆ©æ¢å¤çŠ¶æ€`, '#2ecc71');

            gameLevel++;
            
            if (stageType === 'boss') lastBossType = 'boss';
            else if (stageType === 'evil_dragon') lastBossType = 'evil_dragon';
            else lastBossType = null;

            if (!isTestingDamage) saveGame();
            updateUI();

            if (stageType === 'elite' || stageType === 'boss' || stageType === 'evil_dragon') {
                if (stageType !== 'evil_dragon') {
                    player.eliteKills = (player.eliteKills || 0) + 1;
                }
                isPendingRogue = true; 
                stageCount = 0; 
            }

            battleLoopId = setTimeout(startNextBattle, 1500);

        } else if (player.hp <= 0) {
            // æ­»äº¡åˆ¤å®šï¼šç«‹åˆ»åœæ­¢æ‰€æœ‰å¾ªç¯
            if(bloodInterval) clearInterval(bloodInterval);
            if(mechInterval) clearInterval(mechInterval);
            if(battleLoopId) clearTimeout(battleLoopId);
            
            player.hp = 0;
            isGameActive = false;
            updateUI();
            
            log(`ğŸ’” åŠ›ç«­å€’ä¸‹... 3ç§’åè‡ªåŠ¨å¤æ´»`, '#c0392b');
            
            // 3ç§’åè‡ªåŠ¨å¤æ´»ï¼Œä¸å†éœ€è¦ç‚¹å‡»
            setTimeout(revivePlayer, 3000);
        }
    }
</script>
</body>
</html>